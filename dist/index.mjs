var Ye=Object.defineProperty;var Be=(t,e,n)=>e in t?Ye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var l=(t,e,n)=>Be(t,typeof e!="symbol"?e+"":e,n);var I=Object.freeze({NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4}),te=class{debug(e,n){console.warn("ILogger.debug not implemented",e,n)}info(e,n){console.warn("ILogger.info not implemented",e,n)}warn(e,n){console.warn("ILogger.warn not implemented",e,n)}error(e,n,r){console.warn("ILogger.error not implemented",e,n,r)}withContext(e){return console.warn("ILogger.withContext not implemented",e),this}setLevel(e){console.warn("ILogger.setLevel base implementation called - might not be effective unless overridden.",e)}getLevel(){return console.warn("ILogger.getLevel base implementation called - returning default INFO."),I.INFO}},ne=class t extends te{constructor(e={}){super(),this._level=Object.values(I).includes(e.level)?e.level:I.INFO,this._component=e.component,this._baseContext=e.context||{}}setLevel(e){Object.values(I).includes(e)?this._level=e:console.warn(`[ConsoleLogger] Attempted to set invalid log level: ${e}. Level remains ${this._level}.`)}getLevel(){return this._level}debug(e,n={}){this._level>=I.DEBUG&&console.debug(this._formatMessage(I.DEBUG,e,n))}info(e,n={}){this._level>=I.INFO&&console.info(this._formatMessage(I.INFO,e,n))}warn(e,n={}){this._level>=I.WARN&&console.warn(this._formatMessage(I.WARN,e,n))}error(e,n,r={}){this._level>=I.ERROR&&console.error(this._formatMessage(I.ERROR,e,r,n),n instanceof Error?n:"")}withContext(e){return new t({level:this._level,component:this._component,context:{...this._baseContext,...e}})}_formatMessage(e,n,r,i){var d;let o={timestamp:new Date().toISOString(),level:((d=Object.keys(I).find(s=>I[s]===e))==null?void 0:d.toLowerCase())||"unknown",component:this._component,message:n,...this._baseContext,...r};o.component===void 0&&delete o.component,i&&(o.error={message:i.message,name:i.name,stack:i.stack,...i instanceof Error?{}:i});try{return JSON.stringify(o,(h,p)=>{if(p instanceof Error){let _={message:p.message,name:p.name};return p.stack&&(_.stack=p.stack.split(`
`).map(E=>E.trim())),Object.keys(p).forEach(E=>{E!=="message"&&E!=="name"&&E!=="stack"&&(_[E]=p[E])}),_}return p})}catch(s){return console.error("[ConsoleLogger] Failed to stringify log entry:",s),JSON.stringify({timestamp:o.timestamp,level:o.level,component:o.component,message:n+" (Log entry stringify failed - details omitted)",stringifyError:s.message})}}};function re(t,e={}){if(t&&typeof t.info=="function"&&typeof t.error=="function")return t;let n={...e},r,i;if(typeof t=="object"&&t!==null){if(n={...n,...t},r=n.debug,i=n.level,n.logger&&typeof n.logger.info=="function"&&typeof n.logger.error=="function")return n.logger}else typeof t=="boolean"&&(r=t);i!==void 0&&Object.values(I).includes(i)&&(n.level=i);let o=new ne(n);if(i===void 0&&typeof r=="boolean"){let d=r?I.DEBUG:I.INFO;o.setLevel(d)}return o}function Ue(t){return{all:t=t||new Map,on:function(e,n){var r=t.get(e);r?r.push(n):t.set(e,[n])},off:function(e,n){var r=t.get(e);r&&(n?r.splice(r.indexOf(n)>>>0,1):t.set(e,[]))},emit:function(e,n){var r=t.get(e);r&&r.slice().map(function(i){i(n)}),(r=t.get("*"))&&r.slice().map(function(i){i(e,n)})}}}var T=[];for(let t=0;t<256;++t)T.push((t+256).toString(16).slice(1));function Me(t,e=0){return(T[t[e+0]]+T[t[e+1]]+T[t[e+2]]+T[t[e+3]]+"-"+T[t[e+4]]+T[t[e+5]]+"-"+T[t[e+6]]+T[t[e+7]]+"-"+T[t[e+8]]+T[t[e+9]]+"-"+T[t[e+10]]+T[t[e+11]]+T[t[e+12]]+T[t[e+13]]+T[t[e+14]]+T[t[e+15]]).toLowerCase()}var ie,je=new Uint8Array(16);function oe(){if(!ie){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ie=crypto.getRandomValues.bind(crypto)}return ie(je)}var We=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),se={randomUUID:We};function qe(t,e,n){var i,o,d;if(se.randomUUID&&!e&&!t)return se.randomUUID();t=t||{};let r=(d=(o=t.random)!=null?o:(i=t.rng)==null?void 0:i.call(t))!=null?d:oe();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){if(n=n||0,n<0||n+16>e.length)throw new RangeError(`UUID byte range ${n}:${n+15} is out of buffer bounds`);for(let s=0;s<16;++s)e[n+s]=r[s];return e}return Me(r)}var H=qe;var ae=class{constructor(){l(this,"_emitter");l(this,"_listeners",new Map);l(this,"_pendingEvents",new Set);l(this,"_shuttingDown",!1);l(this,"addListener",this.on.bind(this));l(this,"removeListener",this.off.bind(this));this._emitter=Ue()}on(e,n,r={async:!1}){var o;let i={id:H(),isAsync:(o=r.async)!=null?o:!1,originalHandler:n,wrappedHandler:async(...d)=>{if(!this._shuttingDown)try{if(i.isAsync){let s=Promise.resolve().then(()=>n(...d));this._pendingEvents.add(s),await s.finally(()=>this._pendingEvents.delete(s))}else await n(...d)}catch(s){console.error(`[SafeEventBus] Handler failed for "${e}":`,s),this.emit("error",{event:e,error:s,payload:d})}}};return this._listeners.has(e)||this._listeners.set(e,[]),this._listeners.get(e).push(i),this._emitter.on(e,i.wrappedHandler),()=>this.off(e,n)}once(e,n,r={async:!1}){let i=async o=>{this.off(e,i),await n(o)};return this.on(e,i,r)}off(e,n){let r=this._listeners.get(e);if(!r)return;let i=r.findIndex(o=>o.originalHandler===n);if(i!==-1){let[o]=r.splice(i,1);this._emitter.off(e,o.wrappedHandler)}r.length===0&&this._listeners.delete(e)}async emit(e,n,r={}){if(this._shuttingDown){console.warn(`[SafeEventBus] Emit ignored during shutdown: ${e}`);return}if(r.awaitListeners){let i=this._listeners.get(e)||[];for(let{wrappedHandler:o}of i)try{await o(n)}catch(d){console.error(`[SafeEventBus] Sequential handler error: ${e}`,d)}}else this._emitter.emit(e,n)}async shutdown(e=5e3){this._shuttingDown=!0;let n=new Promise((r,i)=>setTimeout(()=>i(new Error("Shutdown timeout")),e));try{await Promise.race([Promise.allSettled([...this._pendingEvents]),n])}catch(r){console.error("[SafeEventBus] Shutdown error:",r)}finally{this._listeners.clear(),this._emitter.all.clear()}}subscribe(e,n){return this.on(e,n)}getListenerCount(e){var n;return e?((n=this._listeners.get(e))==null?void 0:n.length)||0:[...this._listeners.values()].reduce((r,i)=>r+i.length,0)}},Le=ae;var S=H(),Qe=new RegExp('(\\\\)?"@__(F|R|D|M|S|A|U|I|B|L)-'+S+'-(\\d+)__@"',"g"),Je=/\{\s*\[native code\]\s*\}/g,Ze=/function.*?\(/,Ke=/.*?=>.*?/,Xe=/[<>\/\u2028\u2029]/g,et=["*","async"],tt={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"};function nt(t){return tt[t]}function Pe(t){let e=[];for(let n in t)typeof t[n]=="function"&&e.push(n);for(let n=0;n<e.length;n++)delete t[e[n]]}function Ve(t){let e=t.toString();if(Je.test(e))throw new TypeError("Serializing native function: "+t.name);if(Ze.test(e)||Ke.test(e))return e;let n=e.indexOf("("),r=e.substr(0,n).trim().split(" ").filter(function(o){return o.length>0});return r.filter(function(o){return et.indexOf(o)===-1}).length>0?(r.indexOf("async")>-1?"async ":"")+"function"+(r.join("").indexOf("*")>-1?"*":"")+e.substr(n):e}function rt(t,e){let n=new WeakMap,r={__circularRefId:0};function i(o,d){try{if(e.ignoreFunction&&d&&typeof d=="object"&&Pe(d),d===null||d===0||d===!1||d===""||!d&&d!==void 0&&d!==BigInt(0))return d;let s=this[o],h=typeof s;if(h==="object"&&s!==null){if(n.has(s))return{__type:"CircularRef",refId:n.get(s)};let p=r.__circularRefId++;if(n.set(s,p),s instanceof RegExp)return{__type:"RegExp",source:s.source,flags:s.flags};if(s instanceof Date)return isNaN(s.getTime())?{__type:"Date",value:"Invalid Date"}:{__type:"Date",value:s.toISOString()};if(s instanceof Map)return{__type:"Map",entries:Array.from(s.entries())};if(s instanceof Set)return{__type:"Set",values:Array.from(s.values())};if(s instanceof Array)return s.length!==Object.keys(s).length?{__type:"SparseArray",length:s.length,entries:Object.assign({},s)}:s;if(s instanceof URL)return{__type:"URL",value:s.toString()};if(s instanceof Error)return{__type:"Error",name:s.name,message:s.message,stack:s.stack}}if(h==="function"){if(e.ignoreFunction)return;try{return{__type:"Function",value:Ve(s),name:s.name}}catch(p){return{__type:"Function",error:p.message,name:s.name}}}if(h==="undefined")return{__type:"undefined"};if(h==="number"){if(isNaN(s))return{__type:"NaN"};if(!isFinite(s))return{__type:"Infinity",value:s>0?"Infinity":"-Infinity"}}return h==="bigint"?{__type:"BigInt",value:s.toString()}:h==="symbol"?{__type:"Symbol",description:s.description}:d}catch(s){return{__type:"SerializationError",error:s.message}}}try{if(e.ignoreFunction&&typeof t=="function"&&(t=void 0),t===void 0)return{__type:"undefined"};if(t===null)return null;let o=JSON.stringify(t,i,e.space);return o===void 0?{__type:"undefined"}:JSON.parse(o)}catch(o){return{__type:"SerializationError",error:o.message,originalType:typeof t}}}function U(t,e){if(e||(e={}),(typeof e=="number"||typeof e=="string")&&(e={space:e}),e.returnObject)return rt(t,e);let n=[],r=[],i=[],o=[],d=[],s=[],h=[],p=[],_=[],E=[],D=new WeakSet;function P(b,A){if(e.ignoreFunction&&Pe(A),!A&&A!==void 0&&A!==BigInt(0))return A;let g=this[b],m=typeof g;if(m==="object"&&g!==null){if(D.has(g))return"[Circular]";if(D.add(g),g instanceof RegExp)return"@__R-"+S+"-"+(r.push(g)-1)+"__@";if(g instanceof Date)return"@__D-"+S+"-"+(i.push(g)-1)+"__@";if(g instanceof Map)return"@__M-"+S+"-"+(o.push(g)-1)+"__@";if(g instanceof Set)return"@__S-"+S+"-"+(d.push(g)-1)+"__@";if(g instanceof Array&&g.filter(function(){return!0}).length!==g.length)return"@__A-"+S+"-"+(s.push(g)-1)+"__@";if(g instanceof URL)return"@__L-"+S+"-"+(E.push(g)-1)+"__@"}return m==="function"?"@__F-"+S+"-"+(n.push(g)-1)+"__@":m==="undefined"?"@__U-"+S+"-"+(h.push(g)-1)+"__@":m==="number"&&!isNaN(g)&&!isFinite(g)?"@__I-"+S+"-"+(p.push(g)-1)+"__@":m==="bigint"?"@__B-"+S+"-"+(_.push(g)-1)+"__@":A}if(e.ignoreFunction&&typeof t=="function"&&(t=void 0),t===void 0)return String(t);let y;return e.isJSON&&!e.space?y=JSON.stringify(t):y=JSON.stringify(t,e.isJSON?null:P,e.space),typeof y!="string"?String(y):(e.unsafe!==!0&&(y=y.replace(Xe,nt)),n.length===0&&r.length===0&&i.length===0&&o.length===0&&d.length===0&&s.length===0&&h.length===0&&p.length===0&&_.length===0&&E.length===0?y:y.replace(Qe,function(b,A,g,m){if(A)return b;if(g==="D")return'new Date("'+i[m].toISOString()+'")';if(g==="R")return"new RegExp("+U(r[m].source)+', "'+r[m].flags+'")';if(g==="M")return"new Map("+U(Array.from(o[m].entries()),e)+")";if(g==="S")return"new Set("+U(Array.from(d[m].values()),e)+")";if(g==="A")return"Array.prototype.slice.call("+U(Object.assign({length:s[m].length},s[m]),e)+")";if(g==="U")return"undefined";if(g==="I")return p[m];if(g==="B")return'BigInt("'+_[m]+'")';if(g==="L")return"new URL("+U(E[m].toString(),e)+")";let Q=n[m];return Ve(Q)}))}var K=class t extends Error{constructor(n,r,i,o){super(r);l(this,"cause");l(this,"context",{});l(this,"code");this.name=n||"VideoEngagerError",this.message=r,this.cause=i,this.code=i.code,this.context=o||{}}static isVeError(n){return n instanceof t}toString(){return`${this.name} [${this.code}]: ${this.cause.description||"No description available"} ${this.cause.originalError?`
Original Error: ${this.cause.originalError.message}`:""}`}toJSON(){return U({name:this.name,message:this.message,code:this.code,cause:{...this.cause,originalError:this.cause.originalError?this.cause.originalError.message:void 0},context:this.context,version:this.version||"1.0.0",stack:this.stack},{ignoreFunction:!0,returnObject:!0})}};function it(t,e){let n=["code","name","description"];if(!t||typeof t!="object"||Object.keys(t).length===0)throw new Error("Invalid VideoEngager error codes configuration");if(!e||typeof e!="object"||Object.keys(e).length===0)throw new Error("Invalid VideoEngager error details configuration");for(let r of Object.values(t))e[r]||console.warn(`Missing error details for code: ${r}`);for(let[r,i]of Object.entries(e)){if(!i||typeof i!="object")throw new Error(`Invalid error details for code: ${r}`);for(let o of n)if(!i[o])throw new Error(`Missing required field '${o}' in error details for code: ${r}`)}}function xe(t,e,n,r="1.0.0"){var o;it(t,e);function i(){return{name:"UnknownError",description:"An unknown error occurred",code:"unknown"}}return o=class extends K{constructor(h,p={}){let{originalError:_,context:E={},retryable:D,component:P=n||"VideoEngager"}=p,y=e[h];y||console.warn(`Unknown error code: ${h}. Falling back to unhandled error.`);let b=y||i(),A=typeof _=="string"?new Error(_):_,g={...b,retryable:D,component:P,originalError:A};super("VideoEngagerError",`VideoEngagerError: ${b.name||(A==null?void 0:A.message)||"UnknownError"}`,g,E);l(this,"version",r);l(this,"cause");this.cause=g}static isValidCode(h){return Object.values(t).includes(h)}static getErrorDetails(h){return e[h]}},l(o,"codes",t),l(o,"errorsDetails",e),o}var z="1.0.0";var a=Object.freeze({AGENT_ALREADY_INITIALIZED:"agent|already-initialized",AGENT_NOT_INITIALIZED:"agent|not-initialized",AGENT_NOT_AUTHENTICATED:"agent|not-authenticated",AUTH_METHOD_NOT_SUPPORTED:"auth|method-not-supported",AUTH_GENESYS_ENVIRONMENT_REQUIRED:"auth|genesys-environment-required",AUTH_GENERIC_API_KEY_REQUIRED:"auth|generic-api-key-required",AUTH_CUSTOM_FUNCTION_REQUIRED:"auth|custom-function-required",AUTH_CUSTOM_PARAMETERS_MISSING:"auth|custom-parameters-missing",AUTH_CUSTOM_PARAMETERS_INVALID_TYPE:"auth|custom-parameters-invalid-type",AUTH_CUSTOM_PARAMETERS_EMPTY:"auth|custom-parameters-empty",AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE:"auth|custom-parameters-invalid-value-type",CONFIG_DOMAIN_REQUIRED:"config|domain-required",CONFIG_DOMAIN_INVALID_FORMAT:"config|domain-invalid-format",CONFIG_CONTAINER_ID_INVALID_TYPE:"config|container-id-invalid-type",UI_HANDLERS_BAD_CONFIG:"ui-handlers|bad-config",UI_HANDLERS_METHOD_REQUIRED:"ui-handlers|method-required",UI_HANDLERS_NOT_INITIALIZED:"ui-handlers|not-initialized",PARAM_CUSTOMER_ID_INVALID_TYPE:"param|customer-id-invalid-type",SESSION_ALREADY_ACTIVE:"session|already-active",SESSION_NOT_FOUND:"session|not-found",SESSION_FAILED_TO_START:"session|failed-to-start",CALL_NOT_STARTED:"call|not-started",CALL_ALREADY_FINISHED:"call|already-finished",WIDGET_IFRAME_LOAD_FAILED:"widget|iframe-load-failed",WIDGET_IFRAME_NOT_FOUND:"widget|iframe-not-found",WIDGET_CONTAINER_NOT_FOUND:"widget|container-not-found",OPERATION_ALREADY_RUNNING:"operation|already-running",OPERATION_TIMEOUT:"operation|timeout",OPERATION_CONFLICT:"operation|conflict",OPERATION_ABORTED:"operation|aborted",VE_UNHANDLED_ERROR:"ve|unhandled-error",INVALID_ARGUMENT:"validation|invalid-argument",REQUIRED_FIELD_MISSING:"validation|required-field-missing"}),Fe=Object.freeze({[a.AGENT_ALREADY_INITIALIZED]:{name:"AgentAlreadyInitialized",description:"VideoEngager Agent is already initialized. Cannot initialize again.",code:a.AGENT_ALREADY_INITIALIZED},[a.AGENT_NOT_INITIALIZED]:{name:"AgentNotInitialized",description:"VideoEngager Agent is not initialized. Call initialize() first.",code:a.AGENT_NOT_INITIALIZED},[a.AGENT_NOT_AUTHENTICATED]:{name:"AgentNotAuthenticated",description:"VideoEngager Agent is not authenticated. Call initialize() first.",code:a.AGENT_NOT_AUTHENTICATED},[a.AUTH_METHOD_NOT_SUPPORTED]:{name:"AuthMethodNotSupported",description:"The specified authentication method is not supported.",code:a.AUTH_METHOD_NOT_SUPPORTED},[a.AUTH_GENESYS_ENVIRONMENT_REQUIRED]:{name:"GenesysEnvironmentRequired",description:"Genesys environment is required for Genesys authentication.",code:a.AUTH_GENESYS_ENVIRONMENT_REQUIRED},[a.AUTH_GENERIC_API_KEY_REQUIRED]:{name:"GenericApiKeyRequired",description:"API key is required for generic authentication.",code:a.AUTH_GENERIC_API_KEY_REQUIRED},[a.AUTH_CUSTOM_FUNCTION_REQUIRED]:{name:"CustomAuthFunctionRequired",description:"Custom authentication function is required for custom authentication.",code:a.AUTH_CUSTOM_FUNCTION_REQUIRED},[a.AUTH_CUSTOM_PARAMETERS_MISSING]:{name:"CustomAuthParametersMissing",description:"Authentication parameters are missing in the response from custom authentication function.",code:a.AUTH_CUSTOM_PARAMETERS_MISSING},[a.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE]:{name:"CustomAuthParametersInvalidType",description:"Authentication parameters should be an object.",code:a.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE},[a.AUTH_CUSTOM_PARAMETERS_EMPTY]:{name:"CustomAuthParametersEmpty",description:"Authentication parameters are empty.",code:a.AUTH_CUSTOM_PARAMETERS_EMPTY},[a.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE]:{name:"CustomAuthParametersInvalidValueType",description:"Invalid type for authentication parameter. Only string, number, and boolean are supported.",code:a.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE},[a.CONFIG_DOMAIN_REQUIRED]:{name:"DomainRequired",description:"Domain must be a non-empty string.",code:a.CONFIG_DOMAIN_REQUIRED},[a.CONFIG_DOMAIN_INVALID_FORMAT]:{name:"DomainInvalidFormat",description:"Invalid domain format. Please provide a valid domain.",code:a.CONFIG_DOMAIN_INVALID_FORMAT},[a.CONFIG_CONTAINER_ID_INVALID_TYPE]:{name:"ContainerIdInvalidType",description:"Container ID must be a string.",code:a.CONFIG_CONTAINER_ID_INVALID_TYPE},[a.UI_HANDLERS_BAD_CONFIG]:{name:"UIHandlersBadConfig",description:"UI handlers are not configured correctly. Please check your UI handlers configuration.",code:a.UI_HANDLERS_BAD_CONFIG},[a.UI_HANDLERS_METHOD_REQUIRED]:{name:"UIHandlersMethodRequired",description:"Required UI handler method is missing or not a function.",code:a.UI_HANDLERS_METHOD_REQUIRED},[a.UI_HANDLERS_NOT_INITIALIZED]:{name:"UIHandlersNotInitialized",description:"UI handlers are not initialized. Please ensure that the UI handlers are set up before using them.",code:a.UI_HANDLERS_NOT_INITIALIZED},[a.PARAM_CUSTOMER_ID_INVALID_TYPE]:{name:"CustomerIdInvalidType",description:"Customer ID must be a string and not empty.",code:a.PARAM_CUSTOMER_ID_INVALID_TYPE},[a.SESSION_ALREADY_ACTIVE]:{name:"SessionAlreadyActive",description:"A session is already active. Cannot start a new session.",code:a.SESSION_ALREADY_ACTIVE},[a.SESSION_NOT_FOUND]:{name:"SessionNotFound",description:"No active session found.",code:a.SESSION_NOT_FOUND},[a.SESSION_FAILED_TO_START]:{name:"SessionFailedToStart",description:"Failed to start the video session.",code:a.SESSION_FAILED_TO_START},[a.CALL_NOT_STARTED]:{name:"CallNotStarted",description:"Call has not been started yet.",code:a.CALL_NOT_STARTED},[a.CALL_ALREADY_FINISHED]:{name:"CallAlreadyFinished",description:"Call has already finished.",code:a.CALL_ALREADY_FINISHED},[a.WIDGET_IFRAME_LOAD_FAILED]:{name:"WidgetIframeLoadFailed",description:"Failed to load the VideoEngager widget iframe.",code:a.WIDGET_IFRAME_LOAD_FAILED},[a.WIDGET_IFRAME_NOT_FOUND]:{name:"WidgetIframeNotFound",description:"VideoEngager widget iframe not found in the DOM.",code:a.WIDGET_IFRAME_NOT_FOUND},[a.WIDGET_CONTAINER_NOT_FOUND]:{name:"WidgetContainerNotFound",description:"VideoEngager widget container not found in the DOM.",code:a.WIDGET_CONTAINER_NOT_FOUND},[a.OPERATION_ALREADY_RUNNING]:{name:"OperationAlreadyRunning",description:"Operation is already running and cannot be started again.",code:a.OPERATION_ALREADY_RUNNING},[a.OPERATION_TIMEOUT]:{name:"OperationTimeout",description:"Operation timed out before completion.",code:a.OPERATION_TIMEOUT},[a.OPERATION_CONFLICT]:{name:"OperationConflict",description:"Cannot run operation due to conflicting operations already running.",code:a.OPERATION_CONFLICT},[a.OPERATION_ABORTED]:{name:"OperationAborted",description:"Operation was aborted before completion.",code:a.OPERATION_ABORTED},[a.VE_UNHANDLED_ERROR]:{name:"UnhandledError",description:"An unhandled error occurred in the VideoEngager system. Please check the logs for more details.",code:a.VE_UNHANDLED_ERROR},[a.INVALID_ARGUMENT]:{name:"InvalidArgument",description:"Invalid argument provided to the function.",code:a.INVALID_ARGUMENT},[a.REQUIRED_FIELD_MISSING]:{name:"RequiredFieldMissing",description:"Required field is missing or empty.",code:a.REQUIRED_FIELD_MISSING}}),c=xe(a,Fe,"VideoEngagerAgent",z);var Y=class{constructor(e){l(this,"name","custom");l(this,"configs");this.configs=e}async authenticate(){this.validateConfigs();let e=await this.configs.authenticateFn(this.configs);if(!e)throw new c(c.codes.AUTH_CUSTOM_PARAMETERS_MISSING);if(typeof e!="object")throw new c(c.codes.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE);if(Object.keys(e).length===0)throw new c(c.codes.AUTH_CUSTOM_PARAMETERS_EMPTY);let n={};for(let r in e){let i=e[r];if(typeof i!="string"&&typeof i!="number"&&typeof i!="boolean")throw new c(c.codes.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE,{context:{parameterKey:r,valueType:typeof i,actualValue:i}});n[r]=String(i)}return n}validateConfigs(){if(!this.configs.authenticateFn||typeof this.configs.authenticateFn!="function")throw new c(c.codes.AUTH_CUSTOM_FUNCTION_REQUIRED)}};var B=class{constructor(e){l(this,"name","generic");l(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:"generic",pak:this.configs.apiKey,email:`${this.configs.organizationId?`${this.configs.organizationId}`:""}${this.configs.agentEmail}`}}validateConfigs(){if(!this.configs.apiKey||this.configs.apiKey==="")throw new c(c.codes.AUTH_GENERIC_API_KEY_REQUIRED)}};var j=class{constructor(e){l(this,"name","genesys");l(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:this.configs.environment}}validateConfigs(){if(!this.configs.environment||this.configs.environment==="")throw new c(c.codes.AUTH_GENESYS_ENVIRONMENT_REQUIRED)}};var ce=Object.freeze({generic:B,genesys:j,custom:Y});var He=Object.freeze({NONE:"NONE",CALL_STARTED:"CALL_STARTED",PRE_CALL:"PRE_CALL",FINISHED:"FINISHED",END_CALL:"END_CALL"});var W=class extends Error{constructor(n){super(`Operation "${n}" is already running`);this.op=n}},q=class extends Error{constructor(n,r){super(`Cannot run "${n}" while [${r.join(", ")}] are running`);this.op=n;this.conflicts=r}},v=class extends Error{constructor(n){super(`Operation "${n}" was aborted`);this.op=n}},L=class extends Error{constructor(n,r){super(`Operation "${n}" timed out after ${r} ms`);this.op=n;this.ms=r}};var O=class{constructor(e,n={memoryLeakCheckTimeoutMs:1e4}){this.logger=e;this.configs=n;l(this,"operations",new Map)}async run(e,n,r={}){var fe,pe,Ee,he,me,_e,Ae,Ie,Te,ye,Re,Ne,Se,Oe,we,De,be;let{waitIfRunning:i=!1,useExistingRunResult:o=!1,onExistingRunFail:d="ignore",waitIfRunningDelayMs:s=0,conflictsWith:h=[],waitFor:p=[],waitForDelayMs:_=0,timeoutMs:E=0,signal:D,beforeRun:P,onSuccess:y,onAbort:b,onError:A,onWaitForRunsFail:g="ignore",transformError:m}=r;(fe=this.logger)==null||fe.debug(`Running operation "${e}" with`);let Q=setTimeout(()=>{var u;(u=this.logger)==null||u.warn(`Operation "${e}" is taking too long to complete. Possible memory leak detected.`)},this.configs.memoryLeakCheckTimeoutMs),$,J,C=()=>{J&&(clearTimeout(J),J=void 0),D&&$&&(D.removeEventListener("abort",$),$=void 0),clearTimeout(Q)},M=m||(u=>u instanceof Error?u:new Error(String(u)));if(this.isRunning(e))if((pe=this.logger)==null||pe.debug(`"${e}" already running`),i||o){let R=await this.operations.get(e).promise.catch(N=>{var F;if(d==="throw")throw C(),N;return(F=this.logger)==null||F.debug(`"${e}" existing operation failed, ignoring error and continuing`),C(),N});if(s>0&&((Ee=this.logger)==null||Ee.debug(`Adding artificial delay of ${s}ms after waitIfRunning for "${e}"`),await new Promise(N=>setTimeout(N,s))),o){if(R instanceof Error)throw C(),R;return C(),R}(he=this.logger)==null||he.debug(`"${e}" completed, now running new instance`)}else throw C(),(me=this.logger)==null||me.debug(`"${e}" is already running, not starting a new instance`),M(new W(e));let X=h.filter(u=>this.isRunning(u));if(X.length)throw(_e=this.logger)==null||_e.debug(`"${e}" conflicts with [${X.join(", ")}]`),C(),M(new q(e,X));let Z=p.filter(u=>this.isRunning(u));Z.length&&((Ae=this.logger)==null||Ae.debug(`"${e}" waiting for [${Z.join(", ")}]`),g==="throw"?await Promise.all(Z.map(u=>this.operations.get(u).promise)):await Promise.allSettled(Z.map(u=>this.operations.get(u).promise)),(Ie=this.logger)==null||Ie.debug(`"${e}" done waiting for dependencies`),_>0&&((Te=this.logger)==null||Te.debug(`Adding artificial delay of ${_}ms after waitFor for "${e}"`),await new Promise(u=>setTimeout(u,_))));let V=new AbortController,{signal:x}=V;if(D&&(D.aborted?V.abort():($=()=>{var u;V.abort(),(u=this.logger)==null||u.debug(`"${e}" aborted by external signal`)},D.addEventListener("abort",$,{once:!0}))),P)try{(ye=this.logger)==null||ye.debug(`Executing beforeRun hook for "${e}"`);let u=await P(e,x);if(x.aborted)throw C(),M(new v(e));if(u&&u.skip)return(Re=this.logger)==null||Re.debug(`Operation "${e}" silently skipped by beforeRun hook`),C(),u.value}catch(u){if((Ne=this.logger)==null||Ne.debug(`beforeRun hook aborted operation "${e}": ${u}`),C(),u instanceof v)throw M(u);let R=new Error(`Operation "${e}" aborted by beforeRun hook: ${u}`);throw R.cause=u,M(R)}let ge=(async()=>{var u;try{E>0&&((u=this.logger)==null||u.debug(`Setting timeout of ${E}ms for "${e}"`),J=setTimeout(()=>{var N;(N=this.logger)==null||N.debug(`"${e}" timed out after ${E}ms`),V.abort("Timeout")},E));let R=n(x);return await new Promise((N,F)=>{var Ce;(Ce=this.logger)==null||Ce.debug(`"${e}" operation started`),V.signal.addEventListener("abort",ee=>{var k;(k=this.logger)==null||k.debug(`"${e}" aborted by controller with reason: ${x.reason}`),F(x.reason==="Timeout"?new L(e,E):new v(e))}),R.then(N).catch(ee=>{var k,ve;x.aborted?((k=this.logger)==null||k.debug(`"${e}" operation aborted`),F(new v(e))):((ve=this.logger)==null||ve.debug(`"${e}" operation failed: ${ee}`),F(ee))})})}finally{C()}})();this.operations.set(e,{promise:ge,controller:V});try{let u=await ge;(Se=this.logger)==null||Se.debug(`"${e}" operation completed successfully`);try{await(y==null?void 0:y(u))}catch(R){(Oe=this.logger)==null||Oe.error(`onSuccess hook for "${e}" failed`,R)}return u}catch(u){if(u instanceof DOMException&&u.name==="AbortError"||u instanceof v||u instanceof L){let R=u instanceof L?`"${e}" timed out after ${E}ms`:`"${e}" aborted`;(we=this.logger)==null||we.warn(R);try{await(b==null?void 0:b())}catch(N){(De=this.logger)==null||De.error(`onAbort hook for "${e}" failed`,N)}throw M(u)}else{try{await(A==null?void 0:A(u))}catch(R){(be=this.logger)==null||be.error(`onError hook for "${e}" failed`,R)}throw M(u)}}finally{this.operations.delete(e)}}isRunning(e){return this.operations.has(e)}getRunningOperations(){return[...this.operations.keys()]}async waitFor(e){let n=this.operations.get(e);n&&await n.promise}async waitForAll(){await Promise.all([...this.operations.values()].map(e=>e.promise))}async waitForMany({operations:e,delay:n=0}){var i;let r=e.filter(o=>this.operations.has(o));if(r.length===0){(i=this.logger)==null||i.debug(`No operations found to wait for: ${e.join(", ")}`);return}await Promise.allSettled(r.map(o=>{var d;return(d=this.operations.get(o))==null?void 0:d.promise})),n>0&&await new Promise(o=>setTimeout(o,n))}abort(e,n="Abort Invoked"){var i,o,d;(i=this.logger)==null||i.debug(`Aborting operation "${e}"`);let r=this.operations.get(e);return r?(r.controller.abort(n),(d=this.logger)==null||d.debug(`Aborted operation "${e}" with reason: ${n}`),!0):((o=this.logger)==null||o.debug(`Operation "${e}" not found`),!1)}abortAll(e="Abort All Invoked"){var r,i;(r=this.logger)==null||r.debug("Aborting all operations");let n=0;for(let[o,d]of this.operations.entries())d.controller.abort(e),n++,(i=this.logger)==null||i.debug(`Aborted operation "${o}"`);return n}};l(O,"OperationRunningError",W),l(O,"ConflictError",q),l(O,"OperationAbortedError",v),l(O,"OperationTimeoutError",L);var le="video-engager-container";function de(t){if(t.options&&"uiHandlers"in t.options&&t.options.uiHandlers)throw new Error("Internal Error: default UI handlers cannot be used with custom UI handlers");return t.options||{}}function ot(t,e){let r=de(e).containerId||le,i=document.getElementById(r),o=!1;i||(i=document.createElement("div"),i.id=r,o=!0);let d=i.querySelector("iframe");d&&i.removeChild(d);let s=document.createElement("iframe");s.setAttribute("allow","camera; microphone; autoplay; encrypted-media; fullscreen; picture-in-picture; display-capture"),s.src=t,s.classList.add("video-engager-widget-iframe"),i.appendChild(s),o&&document.body.appendChild(i)}function st(t){let n=de(t).containerId||le,r=document.querySelector(".video-engager-widget-iframe");r&&r.remove();let i=document.getElementById(n);i&&i.remove()}function at(t){let n=de(t).containerId||le,r=document.getElementById(n);return r?r.querySelector(".video-engager-widget-iframe"):null}var Ge={openIframe:ot,closeIframe:st,getIframe:at};function $e(){if(document.getElementById("video-engager-widget-styles"))return;let t=document.createElement("style");t.id="video-engager-widget-styles",t.innerHTML=`
        .video-engager-widget-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        #video-engager-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }
    `,document.head.appendChild(t)}function ke(t){if((!t.domain||typeof t.domain!="string"||t.domain.trim()==="")&&(t.domain="videome.leadsecure.com"),t.domain=ct(t.domain),t.authMethod||(t.authMethod="generic"),t.options||(t.options={}),"containerId"in t.options&&typeof t.options.containerId!="string")throw new c(c.codes.CONFIG_CONTAINER_ID_INVALID_TYPE);if("uiHandlers"in t.options&&t.options.uiHandlers){let e=["openIframe","closeIframe","getIframe"];for(let n of e)if(!t.options.uiHandlers[n]||typeof t.options.uiHandlers[n]!="function")throw new c(c.codes.UI_HANDLERS_METHOD_REQUIRED,{context:{missingMethod:n}})}return t}function ct(t){if(typeof t!="string"||t.trim()==="")throw new c(c.codes.CONFIG_DOMAIN_REQUIRED);try{let e=!t.startsWith("http://")&&!t.startsWith("https://");return new URL(e?`https://${t}`:t).host}catch(e){throw new c(c.codes.CONFIG_DOMAIN_INVALID_FORMAT,{originalError:e,context:{providedDomain:t}})}}function ue(t){let{OperationRunningError:e,ConflictError:n,OperationAbortedError:r,OperationTimeoutError:i}=O;return c.isVeError(t)?t:t instanceof e?new c(c.codes.OPERATION_ALREADY_RUNNING,{originalError:t,context:{operationName:t.op}}):t instanceof n?new c(c.codes.OPERATION_CONFLICT,{originalError:t,context:{operationName:t.op,conflictingOperations:t.conflicts}}):t instanceof r?new c(c.codes.OPERATION_ABORTED,{originalError:t,context:{operationName:t.op}}):t instanceof i?new c(c.codes.OPERATION_TIMEOUT,{originalError:t,context:{operationName:t.op,timeoutMs:t.ms}}):new c(c.codes.VE_UNHANDLED_ERROR,{originalError:t instanceof Error?t:new Error(ze(t)),context:{message:ze(t)}})}function ze(t){return typeof t=="string"?t:typeof t=="object"&&t!==null&&"message"in t&&typeof t.message=="string"?t.message:typeof t=="object"&&t!==null?JSON.stringify(t):String(t)}var f=class f{constructor(){l(this,"logger");l(this,"eventEmitter",new Le);l(this,"authParameters");l(this,"promiseManager");l(this,"PromiseManager",O);l(this,"configs");l(this,"_isInitialized",!1);l(this,"cleanups",[]);l(this,"callState",this.defaultCallState);l(this,"handlerErrors",e=>{let n=ue(e);return this.logger.error("Error in VideoEngagerAgent operation:",n.toJSON()),n});l(this,"on",this.eventEmitter.on.bind(this.eventEmitter));l(this,"off",this.eventEmitter.off.bind(this.eventEmitter));this.logger=re(!0,{component:"VideoEngagerAgent"}),this.promiseManager=new O(this.logger),this.logger.info("VideoEngagerAgent loaded")}get defaultCallState(){return{status:"NONE",callerEmail:"",email:"",tennant_id:"",visitorId:"",pin:"",shortUrl:"",attributes:{},inActiveSession:!1}}static getInstance(){return f._instance||(f._instance=new f),f._instance}static async init(e){return G&&await G.catch(n=>{}),f._instance||(f._instance=new f),await f._instance.initialize(e)}async initialize(e){return await this.promiseManager.run("initialize",async()=>{if(this._isInitialized)throw new c(c.codes.AGENT_ALREADY_INITIALIZED);this.configs=ke(e),this.logger=re(e.logger,{component:"VideoEngagerAgent"});let n=!!this.configs.authMethod&&this.configs.authMethod in ce&&ce[this.configs.authMethod];if(!n)throw new c(c.codes.AUTH_METHOD_NOT_SUPPORTED,{context:{authMethod:this.configs.authMethod}});let r=new n(this.configs);this.authParameters=await r.authenticate(),"uiHandlers"in(this.configs.options||{})||$e(),this.registerSmartVideoEvents(),this._isInitialized=!0,this.logger.info("VideoEngagerAgent Authenticated Successfully")},{waitIfRunning:!1,transformError:this.handlerErrors})}registerSmartVideoEvents(){let e=n=>{var r;n.origin===`https://${this.configs.domain}`&&(this.logger.info("Received message from VideoEngager widget: ",n.data),(r=n.data)!=null&&r.status&&this.handleStatusEvent(n.data))};window.addEventListener("message",e),this.logger.info("Registered message event listener for VideoEngager widget"),this.cleanups.push(()=>{this.logger.info("Removing message event listener"),window.removeEventListener("message",e)})}updateCallState(e,n=!0){let r=e.attributes||{},i={...this.callState.attributes,...r};this.callState={...this.callState,...e,attributes:i},this.logger.info(`Call state updated: ${JSON.stringify(this.callState)}`),n&&this.eventEmitter.emit("callStateUpdated",{...this.callState})}async handleStatusEvent(e){return this.promiseManager.run("handleStatusEvent",async()=>{if(!e||!e.status){this.logger.debug("Received empty payload for status event");return}this.logger.info(`Handling status event: ${e.status}`);let n=this.callState.visitorId,r=this.callState.status,i=!1;switch(e.status){case"PRE_CALL":this.updateCallState(e,!1),n!==e.visitorId&&(this.callState.inActiveSession=!0,this.eventEmitter.emit("sessionStarted",{...this.callState})),i=!0;break;case"CALL_STARTED":this.updateCallState(e);break;case"END_CALL":if(r!=="CALL_STARTED"){this.logger.warn("Call not started yet, ignoring END_CALL event");return}this.updateCallState(e);break;case"FINISHED":if(r==="FINISHED"){this.logger.debug("Call already finished, ignoring duplicate FINISHED event");return}if(r==="NONE"){this.logger.warn("Call Never Started, this indicates a failure to start the call, ignoring FINISHED event"),this.eventEmitter.emit("sessionFailed",e);return}this.callState.inActiveSession=!0,this.updateCallState(e,!1),this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState}),await new Promise(o=>setTimeout(o,10)),this.logger.info("Resetting call state after session finished"),this.callState=this.defaultCallState;break;default:this.logger.warn(`Unhandled status event: ${e.status}`);break}i&&this.eventEmitter.emit("callStateUpdated",{...this.callState})},{waitIfRunning:!0})}async call(e){return await this.promiseManager.run("call",async()=>{if(!this._isInitialized||!this.authParameters)throw new c(c.codes.AGENT_NOT_AUTHENTICATED);this.logger.info("Calling VideoEngagerAgent with auth parameters:");let n={...this.authParameters,enablePostMessage:"true",authPopup:"true"},r=e==null?void 0:e.customerId;if(r&&typeof r!="string")throw new c(c.codes.PARAM_CUSTOMER_ID_INVALID_TYPE);r&&(n.veinteraction=r);let i=new URLSearchParams(n),o=`https://${this.configs.domain}/nextjs/single/smartvideo/?${i.toString()}`;await this.handlersUi.openIframe(o,this.configs),this.logger.info("VideoEngagerAgent call completed. Widget is ready.")},{waitFor:["initialize"],conflictsWith:["endCall"],waitIfRunning:!1,transformError:this.handlerErrors})}async endCall(){return await this.promiseManager.run("endCall",async()=>{if(!this.callState.inActiveSession)throw this.logger.warn("No active session to end"),new c(c.codes.CALL_NOT_STARTED);this.logger.info("Ending call"),await this.handlersUi.closeIframe(this.configs),this.logger.info("closed iframe"),this.callState.inActiveSession&&(this.callState.status=He.FINISHED,this.callState.inActiveSession=!1,this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState})),this.logger.info("Call ended and iframe closed"),this.callState=this.defaultCallState},{waitFor:["initialize","call"],waitIfRunning:!1,waitForDelayMs:500,transformError:this.handlerErrors})}async cleanup(){var e;this.logger.info("Cleaning up VideoEngagerAgent resources");try{(e=this.callState)!=null&&e.inActiveSession&&await this.endCall()}catch(n){this.logger.warn("Error closing iframe during cleanup:"+String(n))}this.cleanups.forEach(n=>{try{n()}catch(r){this.logger.warn("Error during cleanup:"+String(r))}}),this.cleanups.length=0,await this.promiseManager.waitFor("handleStatusEvent"),await this.eventEmitter.emit("cleanup",void 0,{awaitListeners:!0}).catch(n=>{this.logger.warn("Error emitting cleanup event:"+String(n))}),this.logger.info("Emitted cleanup event to listeners");try{await this.eventEmitter.shutdown(1e3)}catch(n){this.logger.warn("Error during event emitter shutdown:"+String(n))}this.promiseManager.abortAll("cleanup"),this.callState=this.defaultCallState,this._isInitialized=!1,this.authParameters=void 0,this.promiseManager=void 0,this.eventEmitter=void 0,this.logger.info("VideoEngagerAgent cleanup completed"),this.logger=void 0,this.configs=void 0}isInitialized(){return this._isInitialized}static call(...e){if(!f._instance)throw new c(c.codes.AGENT_NOT_INITIALIZED);return f._instance.call.bind(f._instance)(...e)}static endCall(...e){if(!f._instance)throw new c(c.codes.AGENT_NOT_INITIALIZED);return f._instance.endCall.bind(f._instance)(...e)}static isInitialized(){return f._instance!==null&&f._instance.isInitialized()}static async destroy(){if(G)throw new c(c.codes.OPERATION_ALREADY_RUNNING,{context:{operationName:"destroy"}});if(f._instance)try{G=f._instance.cleanup(),await G}finally{G=null,f._instance=null}}get handlersUi(){let e=this.configs.options||{};return"uiHandlers"in e&&e.uiHandlers||Ge}};l(f,"VERSION",z),l(f,"_instance",null),l(f,"on",(...e)=>f.getInstance().on.bind(f.getInstance())(...e)),l(f,"off",(...e)=>f.getInstance().off.bind(f.getInstance())(...e));var w=f,G=null,wn=w.init,Dn=w.getInstance,bn=w.isInitialized,Cn=w.destroy,vn=w.call,Un=w.endCall,Mn=w.on,Ln=w.off,Pn=w;export{a as VEErrorCodes,Fe as VEErrorDetails,z as VERSION,w as VideoEngagerAgent,c as VideoEngagerAgentError,vn as call,Pn as default,Cn as destroy,Un as endCall,Dn as getInstance,wn as init,bn as isInitialized,Ln as off,Mn as on};
