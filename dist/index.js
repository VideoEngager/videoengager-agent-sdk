"use strict";var ne=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var nt=Object.getOwnPropertyNames;var ot=Object.prototype.hasOwnProperty;var it=(r,e,t)=>e in r?ne(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var st=(r,e)=>{for(var t in e)ne(r,t,{get:e[t],enumerable:!0})},at=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of nt(e))!ot.call(r,o)&&o!==t&&ne(r,o,{get:()=>e[o],enumerable:!(n=rt(e,o))||n.enumerable});return r};var ct=r=>at(ne({},"__esModule",{value:!0}),r);var l=(r,e,t)=>it(r,typeof e!="symbol"?e+"":e,t);var kt={};st(kt,{VEErrorCodes:()=>a,VEErrorDetails:()=>pe,VERSION:()=>B,VideoEngagerAgent:()=>w,VideoEngagerAgentError:()=>d,call:()=>Lt,default:()=>Ht,destroy:()=>Vt,endCall:()=>Pt,getInstance:()=>Ut,init:()=>vt,isInitialized:()=>xt,off:()=>Ft,on:()=>Mt});module.exports=ct(kt);var I=Object.freeze({NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4}),ce=class{debug(e,t){console.warn("ILogger.debug not implemented",e,t)}info(e,t){console.warn("ILogger.info not implemented",e,t)}warn(e,t){console.warn("ILogger.warn not implemented",e,t)}error(e,t,n){console.warn("ILogger.error not implemented",e,t,n)}withContext(e){return console.warn("ILogger.withContext not implemented",e),this}setLevel(e){console.warn("ILogger.setLevel base implementation called - might not be effective unless overridden.",e)}getLevel(){return console.warn("ILogger.getLevel base implementation called - returning default INFO."),I.INFO}},de=class r extends ce{constructor(e={}){super(),this._level=Object.values(I).includes(e.level)?e.level:I.INFO,this._component=e.component,this._baseContext=e.context||{}}setLevel(e){Object.values(I).includes(e)?this._level=e:console.warn(`[ConsoleLogger] Attempted to set invalid log level: ${e}. Level remains ${this._level}.`)}getLevel(){return this._level}debug(e,t={}){this._level>=I.DEBUG&&console.debug(this._formatMessage(I.DEBUG,e,t))}info(e,t={}){this._level>=I.INFO&&console.info(this._formatMessage(I.INFO,e,t))}warn(e,t={}){this._level>=I.WARN&&console.warn(this._formatMessage(I.WARN,e,t))}error(e,t,n={}){this._level>=I.ERROR&&console.error(this._formatMessage(I.ERROR,e,n,t),t instanceof Error?t:"")}withContext(e){return new r({level:this._level,component:this._component,context:{...this._baseContext,...e}})}_formatMessage(e,t,n,o){var c;let s={timestamp:new Date().toISOString(),level:((c=Object.keys(I).find(i=>I[i]===e))==null?void 0:c.toLowerCase())||"unknown",component:this._component,message:t,...this._baseContext,...n};s.component===void 0&&delete s.component,o&&(s.error={message:o.message,name:o.name,stack:o.stack,...o instanceof Error?{}:o});try{return JSON.stringify(s,(h,f)=>{if(f instanceof Error){let m={message:f.message,name:f.name};return f.stack&&(m.stack=f.stack.split(`
`).map(p=>p.trim())),Object.keys(f).forEach(p=>{p!=="message"&&p!=="name"&&p!=="stack"&&(m[p]=f[p])}),m}return f})}catch(i){return console.error("[ConsoleLogger] Failed to stringify log entry:",i),JSON.stringify({timestamp:s.timestamp,level:s.level,component:s.component,message:t+" (Log entry stringify failed - details omitted)",stringifyError:i.message})}}};function le(r,e={}){if(r&&typeof r.info=="function"&&typeof r.error=="function")return r;let t={...e},n,o;if(typeof r=="object"&&r!==null){if(t={...t,...r},n=t.debug,o=t.level,t.logger&&typeof t.logger.info=="function"&&typeof t.logger.error=="function")return t.logger}else typeof r=="boolean"&&(n=r);o!==void 0&&Object.values(I).includes(o)&&(t.level=o);let s=new de(t);if(o===void 0&&typeof n=="boolean"){let c=n?I.DEBUG:I.INFO;s.setLevel(c)}return s}function ze(r){return{all:r=r||new Map,on:function(e,t){var n=r.get(e);n?n.push(t):r.set(e,[t])},off:function(e,t){var n=r.get(e);n&&(t?n.splice(n.indexOf(t)>>>0,1):r.set(e,[]))},emit:function(e,t){var n=r.get(e);n&&n.slice().map(function(o){o(t)}),(n=r.get("*"))&&n.slice().map(function(o){o(e,t)})}}}var T=[];for(let r=0;r<256;++r)T.push((r+256).toString(16).slice(1));function Ye(r,e=0){return(T[r[e+0]]+T[r[e+1]]+T[r[e+2]]+T[r[e+3]]+"-"+T[r[e+4]]+T[r[e+5]]+"-"+T[r[e+6]]+T[r[e+7]]+"-"+T[r[e+8]]+T[r[e+9]]+"-"+T[r[e+10]]+T[r[e+11]]+T[r[e+12]]+T[r[e+13]]+T[r[e+14]]+T[r[e+15]]).toLowerCase()}var ue,dt=new Uint8Array(16);function ge(){if(!ue){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ue=crypto.getRandomValues.bind(crypto)}return ue(dt)}var lt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),fe={randomUUID:lt};function ut(r,e,t){var o,s,c;if(fe.randomUUID&&!e&&!r)return fe.randomUUID();r=r||{};let n=(c=(s=r.random)!=null?s:(o=r.rng)==null?void 0:o.call(r))!=null?c:ge();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let i=0;i<16;++i)e[t+i]=n[i];return e}return Ye(n)}var L=ut;var W=class extends Error{constructor(t){super(`Operation "${t}" is already running`);this.op=t}},Q=class extends Error{constructor(t,n){super(`Cannot run "${t}" while [${n.join(", ")}] are running`);this.op=t;this.conflicts=n}},O=class extends Error{constructor(t){super(`Operation "${t}" was aborted`);this.op=t}},V=class extends Error{constructor(t,n){super(`Operation "${t}" timed out after ${n} ms`);this.op=t;this.ms=n}};var Ee=class{constructor(){l(this,"_emitter");l(this,"_listeners",new Map);l(this,"_pendingEvents",new Set);l(this,"_shuttingDown",!1);l(this,"addListener",this.on.bind(this));l(this,"removeListener",this.off.bind(this));this._emitter=ze()}on(e,t,n={async:!1}){var s;let o={id:L(),isAsync:(s=n.async)!=null?s:!1,originalHandler:t,wrappedHandler:async(...c)=>{if(!this._shuttingDown)try{if(o.isAsync){let i=Promise.resolve().then(()=>t(...c));this._pendingEvents.add(i),await i.finally(()=>this._pendingEvents.delete(i))}else await t(...c)}catch(i){console.error(`[SafeEventBus] Handler failed for "${e}":`,i),this.emit("error",{event:e,error:i,payload:c})}}};return this._listeners.has(e)||this._listeners.set(e,[]),this._listeners.get(e).push(o),this._emitter.on(e,o.wrappedHandler),()=>this.off(e,t)}once(e,t,n={async:!1}){let o=async s=>{this.off(e,o),await t(s)};return this.on(e,o,n)}waitFor(e,t=5e3,n,o="resolve"){if(n&&typeof n!="function")throw new Error("Filter must be a function");let s,c,i=()=>{};return{promise:new Promise((f,m)=>{t!==-1&&(s=setTimeout(()=>{c&&c(),m(new V(`Timeout waiting for event: ${e}`,t))},t)),c=this.on(e,p=>{try{if(n&&!n(p))return;clearTimeout(s),c&&c(),f(p)}catch(_){clearTimeout(s),c&&c(),m(_);return}}),i=p=>{if(t!==-1&&clearTimeout(s),c&&c(),o==="reject"){m(new O(`Wait for event cancelled: ${e}`));return}f(p||void 0)}}),cancel:i}}waitForAny(e,t=5e3,n,o="resolve"){if(!Array.isArray(e)||e.length===0)throw new Error("eventNames must be a non-empty array");if(n&&typeof n!="function")throw new Error("Filter must be a function");let s,c=[],i=()=>{};return{promise:new Promise((f,m)=>{t!==-1&&(s=setTimeout(()=>{c.forEach(_=>_()),m(new V(`Timeout waiting for any of events: ${e.join(", ")}`,t))},t));let p=_=>R=>{try{if(n&&!n(_,R))return;clearTimeout(s),c.forEach(A=>A()),f({event:_,payload:R})}catch(A){clearTimeout(s),c.forEach(N=>N()),m(A)}};e.forEach(_=>{let R=this.on(_,p(_));c.push(R)}),i=_=>{if(t!==-1&&clearTimeout(s),c.forEach(R=>R()),o==="reject"){m(new O(`Wait for any event cancelled: ${e.join(", ")}`));return}f(_||void 0)}}),cancel:i}}off(e,t){let n=this._listeners.get(e);if(!n)return;let o=n.findIndex(s=>s.originalHandler===t);if(o!==-1){let[s]=n.splice(o,1);this._emitter.off(e,s.wrappedHandler)}n.length===0&&this._listeners.delete(e)}async emit(e,t,n={}){if(this._shuttingDown){console.warn(`[SafeEventBus] Emit ignored during shutdown: ${e}`);return}if(n.awaitListeners){let o=this._listeners.get(e)||[];for(let{wrappedHandler:s}of o)try{await s(t)}catch(c){console.error(`[SafeEventBus] Sequential handler error: ${e}`,c)}}else this._emitter.emit(e,t)}async shutdown(e=5e3){this._shuttingDown=!0;let t=new Promise((n,o)=>setTimeout(()=>o(new Error("Shutdown timeout")),e));try{await Promise.race([Promise.allSettled([...this._pendingEvents]),t])}catch(n){console.error("[SafeEventBus] Shutdown error:",n)}finally{this._listeners.clear(),this._emitter.all.clear()}}subscribe(e,t){return this.on(e,t)}getListenerCount(e){var t;return e?((t=this._listeners.get(e))==null?void 0:t.length)||0:[...this._listeners.values()].reduce((n,o)=>n+o.length,0)}},oe=Ee;var v=L(),gt=new RegExp('(\\\\)?"@__(F|R|D|M|S|A|U|I|B|L)-'+v+'-(\\d+)__@"',"g"),ft=/\{\s*\[native code\]\s*\}/g,Et=/function.*?\(/,pt=/.*?=>.*?/,mt=/[<>\/\u2028\u2029]/g,ht=["*","async"],_t={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"};function At(r){return _t[r]}function je(r){let e=[];for(let t in r)typeof r[t]=="function"&&e.push(t);for(let t=0;t<e.length;t++)delete r[e[t]]}function qe(r){let e=r.toString();if(ft.test(e))throw new TypeError("Serializing native function: "+r.name);if(Et.test(e)||pt.test(e))return e;let t=e.indexOf("("),n=e.substr(0,t).trim().split(" ").filter(function(s){return s.length>0});return n.filter(function(s){return ht.indexOf(s)===-1}).length>0?(n.indexOf("async")>-1?"async ":"")+"function"+(n.join("").indexOf("*")>-1?"*":"")+e.substr(t):e}function yt(r,e){let t=new WeakMap,n={__circularRefId:0};function o(s,c){try{if(e.ignoreFunction&&c&&typeof c=="object"&&je(c),c===null||c===0||c===!1||c===""||!c&&c!==void 0&&c!==BigInt(0))return c;let i=this[s],h=typeof i;if(h==="object"&&i!==null){if(t.has(i))return{__type:"CircularRef",refId:t.get(i)};let f=n.__circularRefId++;if(t.set(i,f),i instanceof RegExp)return{__type:"RegExp",source:i.source,flags:i.flags};if(i instanceof Date)return isNaN(i.getTime())?{__type:"Date",value:"Invalid Date"}:{__type:"Date",value:i.toISOString()};if(i instanceof Map)return{__type:"Map",entries:Array.from(i.entries())};if(i instanceof Set)return{__type:"Set",values:Array.from(i.values())};if(i instanceof Array)return i.length!==Object.keys(i).length?{__type:"SparseArray",length:i.length,entries:Object.assign({},i)}:i;if(i instanceof URL)return{__type:"URL",value:i.toString()};if(i instanceof Error)return{__type:"Error",name:i.name,message:i.message,stack:i.stack}}if(h==="function"){if(e.ignoreFunction)return;try{return{__type:"Function",value:qe(i),name:i.name}}catch(f){return{__type:"Function",error:f.message,name:i.name}}}if(h==="undefined")return{__type:"undefined"};if(h==="number"){if(isNaN(i))return{__type:"NaN"};if(!isFinite(i))return{__type:"Infinity",value:i>0?"Infinity":"-Infinity"}}return h==="bigint"?{__type:"BigInt",value:i.toString()}:h==="symbol"?{__type:"Symbol",description:i.description}:c}catch(i){return{__type:"SerializationError",error:i.message}}}try{if(e.ignoreFunction&&typeof r=="function"&&(r=void 0),r===void 0)return{__type:"undefined"};if(r===null)return null;let s=JSON.stringify(r,o,e.space);return s===void 0?{__type:"undefined"}:JSON.parse(s)}catch(s){return{__type:"SerializationError",error:s.message,originalType:typeof r}}}function P(r,e){if(e||(e={}),(typeof e=="number"||typeof e=="string")&&(e={space:e}),e.returnObject)return yt(r,e);let t=[],n=[],o=[],s=[],c=[],i=[],h=[],f=[],m=[],p=[],_=new WeakSet;function R(N,C){if(e.ignoreFunction&&je(C),!C&&C!==void 0&&C!==BigInt(0))return C;let g=this[N],y=typeof g;if(y==="object"&&g!==null){if(_.has(g))return"[Circular]";if(_.add(g),g instanceof RegExp)return"@__R-"+v+"-"+(n.push(g)-1)+"__@";if(g instanceof Date)return"@__D-"+v+"-"+(o.push(g)-1)+"__@";if(g instanceof Map)return"@__M-"+v+"-"+(s.push(g)-1)+"__@";if(g instanceof Set)return"@__S-"+v+"-"+(c.push(g)-1)+"__@";if(g instanceof Array&&g.filter(function(){return!0}).length!==g.length)return"@__A-"+v+"-"+(i.push(g)-1)+"__@";if(g instanceof URL)return"@__L-"+v+"-"+(p.push(g)-1)+"__@"}return y==="function"?"@__F-"+v+"-"+(t.push(g)-1)+"__@":y==="undefined"?"@__U-"+v+"-"+(h.push(g)-1)+"__@":y==="number"&&!isNaN(g)&&!isFinite(g)?"@__I-"+v+"-"+(f.push(g)-1)+"__@":y==="bigint"?"@__B-"+v+"-"+(m.push(g)-1)+"__@":C}if(e.ignoreFunction&&typeof r=="function"&&(r=void 0),r===void 0)return String(r);let A;return e.isJSON&&!e.space?A=JSON.stringify(r):A=JSON.stringify(r,e.isJSON?null:R,e.space),typeof A!="string"?String(A):(e.unsafe!==!0&&(A=A.replace(mt,At)),t.length===0&&n.length===0&&o.length===0&&s.length===0&&c.length===0&&i.length===0&&h.length===0&&f.length===0&&m.length===0&&p.length===0?A:A.replace(gt,function(N,C,g,y){if(C)return N;if(g==="D")return'new Date("'+o[y].toISOString()+'")';if(g==="R")return"new RegExp("+P(n[y].source)+', "'+n[y].flags+'")';if(g==="M")return"new Map("+P(Array.from(s[y].entries()),e)+")";if(g==="S")return"new Set("+P(Array.from(c[y].values()),e)+")";if(g==="A")return"Array.prototype.slice.call("+P(Object.assign({length:i[y].length},i[y]),e)+")";if(g==="U")return"undefined";if(g==="I")return f[y];if(g==="B")return'BigInt("'+m[y]+'")';if(g==="L")return"new URL("+P(p[y].toString(),e)+")";let Y=t[y];return qe(Y)}))}var K=class r extends Error{constructor(t,n,o,s={},c="1.0.0"){super(n);l(this,"idempotencyKey",L());l(this,"cause");l(this,"context");l(this,"code");l(this,"version");this.name=t||"VideoEngagerError",this.cause=o,this.message=`VideoEngagerError: ${this.cause.name}`,this.code=o.code,this.context=s,this.version=c}static isVeError(t){return t instanceof r}toString(){let t=this.cause.description||"No description available",n=this.cause.originalError?`
Original Error: ${this.cause.originalError.message}`:"";return`${this.name} [${this.code}]: ${t}${n}`}toJSON(){var t;return P({name:this.name,message:this.message,code:this.code,cause:{...this.cause,originalError:(t=this.cause.originalError)==null?void 0:t.message},context:this.context,version:this.version,stack:this.stack,idempotencyKey:this.idempotencyKey},{ignoreFunction:!0,returnObject:!0})}},It=["code","name","description"];function Tt(r,e){let t=(n,o)=>{if(!n||typeof n!="object"||Object.keys(n).length===0)throw new Error(`Invalid VideoEngager ${o} configuration`)};t(r,"error codes"),t(e,"error details"),Object.values(r).forEach(n=>{e[n]||console.warn(`Missing error details for code: ${n}`)}),Object.entries(e).forEach(([n,o])=>{if(!o||typeof o!="object")throw new Error(`Invalid error details for code: ${n}`);It.forEach(s=>{if(!(s in o))throw new Error(`Missing required field '${s}' in error details for code: ${n}`)})})}var Ct={name:"UnknownError",description:"An unknown error occurred",code:"unknown"};function Qe(r,e,t="VideoEngager",n="1.0.0"){Tt(r,e);let s=class s extends K{constructor(i,h={}){let{originalError:f,context:m={},retryable:p,component:_=t}=h,R=e[i];R||console.warn(`Unknown error code: ${i}. Falling back to unhandled error.`);let A=R||Ct,N=typeof f=="string"?new Error(f):f,C={code:A.code,name:A.name,description:A.description,retryable:p,component:_,originalError:N},g=`VideoEngagerError: ${A.name||(N==null?void 0:N.message)||"UnknownError"}`;super("VideoEngagerError",g,C,m,n),this.code=i,this.cause=C,St(this)}static isVeError(i){return i instanceof K}static isOwnError(i){return i instanceof s}static getErrorDetails(i){return e[i]}static isValidCode(i){return Object.values(r).includes(i)}};l(s,"codes",r),l(s,"errorsDetails",e);let o=s;return o}var Rt=new oe,Nt=300*1e3,We=1e3,M=new Map;function St(r){if(!r||typeof r!="object")return;if(!("idempotencyKey"in r))try{Object.assign(r,{idempotencyKey:L()})}catch{return}let e=r.idempotencyKey,t=Date.now();for(let[n,o]of M)t-o>Nt&&M.delete(n);if(!M.has(e)&&(M.set(e,t),Rt.emit("error",r),M.size>We)){let n=M.size-We,o=0;for(let s of M.keys())if(M.delete(s),++o>=n)break}}var B="4.0.1";var a=Object.freeze({AGENT_ALREADY_INITIALIZED:"agent|already-initialized",AGENT_NOT_INITIALIZED:"agent|not-initialized",AGENT_NOT_AUTHENTICATED:"agent|not-authenticated",AUTH_METHOD_NOT_SUPPORTED:"auth|method-not-supported",AUTH_GENESYS_ENVIRONMENT_REQUIRED:"auth|genesys-environment-required",AUTH_GENERIC_API_KEY_REQUIRED:"auth|generic-api-key-required",AUTH_CUSTOM_FUNCTION_REQUIRED:"auth|custom-function-required",AUTH_CUSTOM_PARAMETERS_MISSING:"auth|custom-parameters-missing",AUTH_CUSTOM_PARAMETERS_INVALID_TYPE:"auth|custom-parameters-invalid-type",AUTH_CUSTOM_PARAMETERS_EMPTY:"auth|custom-parameters-empty",AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE:"auth|custom-parameters-invalid-value-type",CONFIG_DOMAIN_REQUIRED:"config|domain-required",CONFIG_DOMAIN_INVALID_FORMAT:"config|domain-invalid-format",CONFIG_CONTAINER_ID_INVALID_TYPE:"config|container-id-invalid-type",UI_HANDLERS_BAD_CONFIG:"ui-handlers|bad-config",UI_HANDLERS_METHOD_REQUIRED:"ui-handlers|method-required",UI_HANDLERS_NOT_INITIALIZED:"ui-handlers|not-initialized",PARAM_CUSTOMER_ID_INVALID_TYPE:"param|customer-id-invalid-type",SESSION_ALREADY_ACTIVE:"session|already-active",SESSION_NOT_FOUND:"session|not-found",SESSION_FAILED_TO_START:"session|failed-to-start",CALL_NOT_STARTED:"call|not-started",CALL_ALREADY_FINISHED:"call|already-finished",WIDGET_IFRAME_LOAD_FAILED:"widget|iframe-load-failed",WIDGET_IFRAME_NOT_FOUND:"widget|iframe-not-found",WIDGET_CONTAINER_NOT_FOUND:"widget|container-not-found",OPERATION_ALREADY_RUNNING:"operation|already-running",OPERATION_TIMEOUT:"operation|timeout",OPERATION_CONFLICT:"operation|conflict",OPERATION_ABORTED:"operation|aborted",VE_UNHANDLED_ERROR:"ve|unhandled-error",INVALID_ARGUMENT:"validation|invalid-argument",REQUIRED_FIELD_MISSING:"validation|required-field-missing"}),pe=Object.freeze({[a.AGENT_ALREADY_INITIALIZED]:{name:"AgentAlreadyInitialized",description:"VideoEngager Agent is already initialized. Cannot initialize again.",code:a.AGENT_ALREADY_INITIALIZED},[a.AGENT_NOT_INITIALIZED]:{name:"AgentNotInitialized",description:"VideoEngager Agent is not initialized. Call initialize() first.",code:a.AGENT_NOT_INITIALIZED},[a.AGENT_NOT_AUTHENTICATED]:{name:"AgentNotAuthenticated",description:"VideoEngager Agent is not authenticated. Call initialize() first.",code:a.AGENT_NOT_AUTHENTICATED},[a.AUTH_METHOD_NOT_SUPPORTED]:{name:"AuthMethodNotSupported",description:"The specified authentication method is not supported.",code:a.AUTH_METHOD_NOT_SUPPORTED},[a.AUTH_GENESYS_ENVIRONMENT_REQUIRED]:{name:"GenesysEnvironmentRequired",description:"Genesys environment is required for Genesys authentication.",code:a.AUTH_GENESYS_ENVIRONMENT_REQUIRED},[a.AUTH_GENERIC_API_KEY_REQUIRED]:{name:"GenericApiKeyRequired",description:"API key is required for generic authentication.",code:a.AUTH_GENERIC_API_KEY_REQUIRED},[a.AUTH_CUSTOM_FUNCTION_REQUIRED]:{name:"CustomAuthFunctionRequired",description:"Custom authentication function is required for custom authentication.",code:a.AUTH_CUSTOM_FUNCTION_REQUIRED},[a.AUTH_CUSTOM_PARAMETERS_MISSING]:{name:"CustomAuthParametersMissing",description:"Authentication parameters are missing in the response from custom authentication function.",code:a.AUTH_CUSTOM_PARAMETERS_MISSING},[a.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE]:{name:"CustomAuthParametersInvalidType",description:"Authentication parameters should be an object.",code:a.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE},[a.AUTH_CUSTOM_PARAMETERS_EMPTY]:{name:"CustomAuthParametersEmpty",description:"Authentication parameters are empty.",code:a.AUTH_CUSTOM_PARAMETERS_EMPTY},[a.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE]:{name:"CustomAuthParametersInvalidValueType",description:"Invalid type for authentication parameter. Only string, number, and boolean are supported.",code:a.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE},[a.CONFIG_DOMAIN_REQUIRED]:{name:"DomainRequired",description:"Domain must be a non-empty string.",code:a.CONFIG_DOMAIN_REQUIRED},[a.CONFIG_DOMAIN_INVALID_FORMAT]:{name:"DomainInvalidFormat",description:"Invalid domain format. Please provide a valid domain.",code:a.CONFIG_DOMAIN_INVALID_FORMAT},[a.CONFIG_CONTAINER_ID_INVALID_TYPE]:{name:"ContainerIdInvalidType",description:"Container ID must be a string.",code:a.CONFIG_CONTAINER_ID_INVALID_TYPE},[a.UI_HANDLERS_BAD_CONFIG]:{name:"UIHandlersBadConfig",description:"UI handlers are not configured correctly. Please check your UI handlers configuration.",code:a.UI_HANDLERS_BAD_CONFIG},[a.UI_HANDLERS_METHOD_REQUIRED]:{name:"UIHandlersMethodRequired",description:"Required UI handler method is missing or not a function.",code:a.UI_HANDLERS_METHOD_REQUIRED},[a.UI_HANDLERS_NOT_INITIALIZED]:{name:"UIHandlersNotInitialized",description:"UI handlers are not initialized. Please ensure that the UI handlers are set up before using them.",code:a.UI_HANDLERS_NOT_INITIALIZED},[a.PARAM_CUSTOMER_ID_INVALID_TYPE]:{name:"CustomerIdInvalidType",description:"Customer ID must be a string and not empty.",code:a.PARAM_CUSTOMER_ID_INVALID_TYPE},[a.SESSION_ALREADY_ACTIVE]:{name:"SessionAlreadyActive",description:"A session is already active. Cannot start a new session.",code:a.SESSION_ALREADY_ACTIVE},[a.SESSION_NOT_FOUND]:{name:"SessionNotFound",description:"No active session found.",code:a.SESSION_NOT_FOUND},[a.SESSION_FAILED_TO_START]:{name:"SessionFailedToStart",description:"Failed to start the video session.",code:a.SESSION_FAILED_TO_START},[a.CALL_NOT_STARTED]:{name:"CallNotStarted",description:"Call has not been started yet.",code:a.CALL_NOT_STARTED},[a.CALL_ALREADY_FINISHED]:{name:"CallAlreadyFinished",description:"Call has already finished.",code:a.CALL_ALREADY_FINISHED},[a.WIDGET_IFRAME_LOAD_FAILED]:{name:"WidgetIframeLoadFailed",description:"Failed to load the VideoEngager widget iframe.",code:a.WIDGET_IFRAME_LOAD_FAILED},[a.WIDGET_IFRAME_NOT_FOUND]:{name:"WidgetIframeNotFound",description:"VideoEngager widget iframe not found in the DOM.",code:a.WIDGET_IFRAME_NOT_FOUND},[a.WIDGET_CONTAINER_NOT_FOUND]:{name:"WidgetContainerNotFound",description:"VideoEngager widget container not found in the DOM.",code:a.WIDGET_CONTAINER_NOT_FOUND},[a.OPERATION_ALREADY_RUNNING]:{name:"OperationAlreadyRunning",description:"Operation is already running and cannot be started again.",code:a.OPERATION_ALREADY_RUNNING},[a.OPERATION_TIMEOUT]:{name:"OperationTimeout",description:"Operation timed out before completion.",code:a.OPERATION_TIMEOUT},[a.OPERATION_CONFLICT]:{name:"OperationConflict",description:"Cannot run operation due to conflicting operations already running.",code:a.OPERATION_CONFLICT},[a.OPERATION_ABORTED]:{name:"OperationAborted",description:"Operation was aborted before completion.",code:a.OPERATION_ABORTED},[a.VE_UNHANDLED_ERROR]:{name:"UnhandledError",description:"An unhandled error occurred in the VideoEngager system. Please check the logs for more details.",code:a.VE_UNHANDLED_ERROR},[a.INVALID_ARGUMENT]:{name:"InvalidArgument",description:"Invalid argument provided to the function.",code:a.INVALID_ARGUMENT},[a.REQUIRED_FIELD_MISSING]:{name:"RequiredFieldMissing",description:"Required field is missing or empty.",code:a.REQUIRED_FIELD_MISSING}}),d=Qe(a,pe,"VideoEngagerAgent",B);var J=class{constructor(e){l(this,"name","custom");l(this,"configs");this.configs=e}async authenticate(){this.validateConfigs();let e=await this.configs.authenticateFn(this.configs);if(!e)throw new d(d.codes.AUTH_CUSTOM_PARAMETERS_MISSING);if(typeof e!="object")throw new d(d.codes.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE);if(Object.keys(e).length===0)throw new d(d.codes.AUTH_CUSTOM_PARAMETERS_EMPTY);let t={};for(let n in e){let o=e[n];if(typeof o!="string"&&typeof o!="number"&&typeof o!="boolean")throw new d(d.codes.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE,{context:{parameterKey:n,valueType:typeof o,actualValue:o}});t[n]=String(o)}return t}validateConfigs(){if(!this.configs.authenticateFn||typeof this.configs.authenticateFn!="function")throw new d(d.codes.AUTH_CUSTOM_FUNCTION_REQUIRED)}};var Z=class{constructor(e){l(this,"name","generic");l(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:"generic",pak:this.configs.apiKey,email:`${this.configs.organizationId?`${this.configs.organizationId}`:""}${this.configs.agentEmail}`}}validateConfigs(){if(!this.configs.apiKey||this.configs.apiKey==="")throw new d(d.codes.AUTH_GENERIC_API_KEY_REQUIRED)}};var X=class{constructor(e){l(this,"name","genesys");l(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:this.configs.environment}}validateConfigs(){if(!this.configs.environment||this.configs.environment==="")throw new d(d.codes.AUTH_GENESYS_ENVIRONMENT_REQUIRED)}};var me=Object.freeze({generic:Z,genesys:X,custom:J});var Ke=Object.freeze({NONE:"NONE",CALL_STARTED:"CALL_STARTED",PRE_CALL:"PRE_CALL",FINISHED:"FINISHED",END_CALL:"END_CALL"});var ie=class{constructor(e="sequential-reversed",t){this.logger=t;l(this,"actions",[]);l(this,"strategy");this.strategy=e}register(e){var t;this.actions.push(e),(t=this.logger)==null||t.debug(`Registered compensation action (total: ${this.actions.length})`)}registerIf(e,t){var n,o;e?(this.actions.push(t),(n=this.logger)==null||n.debug(`Conditionally registered compensation action (total: ${this.actions.length})`)):(o=this.logger)==null||o.debug("Compensation action not registered (condition false)")}registerIfLazy(e,t){var o;let n=async()=>{var s,c;try{await Promise.resolve(e())?await Promise.resolve(t()):(s=this.logger)==null||s.debug("Skipping lazy conditional action (condition false)")}catch(i){(c=this.logger)==null||c.error("Condition evaluation failed, treating as false:",i)}};this.actions.push(n),(o=this.logger)==null||o.debug(`Registered lazy conditional compensation action (total: ${this.actions.length})`)}getActionCount(){return this.actions.length}setStrategy(e){var t;(t=this.logger)==null||t.debug(`Changing compensation strategy from ${this.strategy} to ${e}`),this.strategy=e}getStrategy(){return this.strategy}async executeAll(){var t,n,o,s,c;if(this.actions.length===0){(t=this.logger)==null||t.debug("No compensation actions to execute");return}(n=this.logger)==null||n.debug(`Executing ${this.actions.length} compensation actions with strategy: ${this.strategy}`);let e=this.strategy==="sequential-reversed"?[...this.actions].reverse():this.actions;if(this.strategy==="parallel")(await Promise.allSettled(e.map(h=>Promise.resolve(h())))).forEach((h,f)=>{var m;h.status==="rejected"&&((m=this.logger)==null||m.error(`Compensation action ${f+1} failed:`,h.reason))});else for(let i=0;i<e.length;i++)try{await e[i](),(o=this.logger)==null||o.debug(`Compensation action ${i+1}/${e.length} completed`)}catch(h){(s=this.logger)==null||s.error(`Compensation action ${i+1} failed:`,h)}(c=this.logger)==null||c.debug("All compensation actions executed")}clear(){var e;this.actions=[],(e=this.logger)==null||e.debug("Cleared all compensation actions")}};var U=class{constructor(e,t={memoryLeakCheckTimeoutMs:1e4}){this.logger=e;this.configs=t;l(this,"operations",new Map)}async run(e,t,n={}){var Ie,Te,Ce,Re,Ne,Se,Oe,we,De,be,ve,Ue,xe,Ve,Le,Pe,Me,Fe,He,ke,$e,Ge;let{waitIfRunning:o=!1,useExistingRunResult:s=!1,onExistingRunFail:c="ignore",waitIfRunningDelayMs:i=0,conflictsWith:h=[],waitFor:f=[],waitForDelayMs:m=0,timeoutMs:p=0,signal:_,beforeRun:R,onSuccess:A,onAbort:N,onError:C,onWaitForRunsFail:g="ignore",transformError:y,compensationStrategy:Y="sequential-reversed",shouldCompensate:ee}=n,H=new ie(Y,this.logger);(Ie=this.logger)==null||Ie.debug(`Running operation "${e}" with compensation strategy: ${Y}`);let tt=setTimeout(()=>{var u;(u=this.logger)==null||u.warn(`Operation "${e}" is taking too long to complete. Possible memory leak detected.`)},this.configs.memoryLeakCheckTimeoutMs),j,te,x=()=>{te&&(clearTimeout(te),te=void 0),_&&j&&(_.removeEventListener("abort",j),j=void 0),clearTimeout(tt)},F=y||(u=>u instanceof Error?u:new Error(String(u)));if(this.isRunning(e))if((Te=this.logger)==null||Te.debug(`"${e}" already running`),o||s){let D=await this.operations.get(e).promise.catch(S=>{var b;if(c==="throw")throw x(),S;return(b=this.logger)==null||b.debug(`"${e}" existing operation failed, ignoring error and continuing`),x(),S});if(i>0&&((Ce=this.logger)==null||Ce.debug(`Adding artificial delay of ${i}ms after waitIfRunning for "${e}"`),await new Promise(S=>setTimeout(S,i))),s){if(D instanceof Error)throw x(),D;return x(),D}(Re=this.logger)==null||Re.debug(`"${e}" completed, now running new instance`)}else throw x(),(Ne=this.logger)==null||Ne.debug(`"${e}" is already running, not starting a new instance`),F(new W(e));let se=h.filter(u=>this.isRunning(u));if(se.length)throw(Se=this.logger)==null||Se.debug(`"${e}" conflicts with [${se.join(", ")}]`),x(),F(new Q(e,se));let re=f.filter(u=>this.isRunning(u));re.length&&((Oe=this.logger)==null||Oe.debug(`"${e}" waiting for [${re.join(", ")}]`),g==="throw"?await Promise.all(re.map(u=>this.operations.get(u).promise)):await Promise.allSettled(re.map(u=>this.operations.get(u).promise)),(we=this.logger)==null||we.debug(`"${e}" done waiting for dependencies`),m>0&&((De=this.logger)==null||De.debug(`Adding artificial delay of ${m}ms after waitFor for "${e}"`),await new Promise(u=>setTimeout(u,m))));let k=new AbortController,{signal:$}=k;if(_&&(_.aborted?k.abort():(j=()=>{var u;k.abort(),(u=this.logger)==null||u.debug(`"${e}" aborted by external signal`)},_.addEventListener("abort",j,{once:!0}))),R)try{(be=this.logger)==null||be.debug(`Executing beforeRun hook for "${e}"`);let u=await R(e,$);if($.aborted)throw x(),F(new O(e));if(u&&u.skip)return(ve=this.logger)==null||ve.debug(`Operation "${e}" silently skipped by beforeRun hook`),x(),u.value}catch(u){if((Ue=this.logger)==null||Ue.debug(`beforeRun hook aborted operation "${e}": ${u}`),x(),u instanceof O)throw F(u);let D=new Error(`Operation "${e}" aborted by beforeRun hook: ${u}`);throw D.cause=u,F(D)}let ye=(async()=>{var u;try{p>0&&((u=this.logger)==null||u.debug(`Setting timeout of ${p}ms for "${e}"`),te=setTimeout(()=>{var S;(S=this.logger)==null||S.debug(`"${e}" timed out after ${p}ms`),k.abort("Timeout")},p));let D=t($,H);return await new Promise((S,b)=>{var G;(G=this.logger)==null||G.debug(`"${e}" operation started`),k.signal.addEventListener("abort",ae=>{var q;(q=this.logger)==null||q.debug(`"${e}" aborted by controller with reason: ${$.reason}`),b($.reason==="Timeout"?new V(e,p):new O(e))}),D.then(S).catch(ae=>{var q,Be;$.aborted?((q=this.logger)==null||q.debug(`"${e}" operation aborted`),b(new O(e))):((Be=this.logger)==null||Be.debug(`"${e}" operation failed: ${ae}`),b(ae))})})}finally{x()}})();this.operations.set(e,{promise:ye,controller:k});try{let u=await ye;(xe=this.logger)==null||xe.debug(`"${e}" operation completed successfully`);try{await(A==null?void 0:A(u))}catch(D){(Ve=this.logger)==null||Ve.error(`onSuccess hook for "${e}" failed`,D)}return u}catch(u){if(u instanceof DOMException&&u.name==="AbortError"||u instanceof O||u instanceof V){let S=u instanceof V?`"${e}" timed out after ${p}ms`:`"${e}" aborted`;if((Le=this.logger)==null||Le.warn(S),(ee?ee(u):!0)&&H.getActionCount()>0){(Pe=this.logger)==null||Pe.debug(`Executing compensations for aborted operation "${e}"`);try{await H.executeAll()}catch(G){(Me=this.logger)==null||Me.error(`Failed to execute compensations for "${e}"`,G)}}try{await(N==null?void 0:N())}catch(G){(Fe=this.logger)==null||Fe.error(`onAbort hook for "${e}" failed`,G)}throw F(u)}else{if((He=this.logger)==null||He.error(`Operation "${e}" failed with error:`,u),(ee?ee(u):!0)&&H.getActionCount()>0){(ke=this.logger)==null||ke.debug(`Executing compensations for failed operation "${e}"`);try{await H.executeAll()}catch(b){($e=this.logger)==null||$e.error(`Failed to execute compensations for "${e}"`,b)}}try{await(C==null?void 0:C(u))}catch(b){(Ge=this.logger)==null||Ge.error(`onError hook for "${e}" failed`,b)}throw F(u)}}finally{H.clear(),this.operations.delete(e)}}isRunning(e){return this.operations.has(e)}getRunningOperations(){return[...this.operations.keys()]}async waitFor(e){let t=this.operations.get(e);t&&await t.promise}async waitForAll(){await Promise.all([...this.operations.values()].map(e=>e.promise))}async waitForMany({operations:e,delay:t=0}){var o;let n=e.filter(s=>this.operations.has(s));if(n.length===0){(o=this.logger)==null||o.debug(`No operations found to wait for: ${e.join(", ")}`);return}await Promise.allSettled(n.map(s=>{var c;return(c=this.operations.get(s))==null?void 0:c.promise})),t>0&&await new Promise(s=>setTimeout(s,t))}abort(e,t="Abort Invoked"){var o,s,c;(o=this.logger)==null||o.debug(`Aborting operation "${e}"`);let n=this.operations.get(e);return n?(n.controller.abort(t),(c=this.logger)==null||c.debug(`Aborted operation "${e}" with reason: ${t}`),!0):((s=this.logger)==null||s.debug(`Operation "${e}" not found`),!1)}abortAll(e="Abort All Invoked"){var n,o;(n=this.logger)==null||n.debug("Aborting all operations");let t=0;for(let[s,c]of this.operations.entries())c.controller.abort(e),t++,(o=this.logger)==null||o.debug(`Aborted operation "${s}"`);return t}};l(U,"OperationRunningError",W),l(U,"ConflictError",Q),l(U,"OperationAbortedError",O),l(U,"OperationTimeoutError",V);var he="video-engager-container";function _e(r){if(r.options&&"uiHandlers"in r.options&&r.options.uiHandlers)throw new Error("Internal Error: default UI handlers cannot be used with custom UI handlers");return r.options||{}}function Ot(r,e){let n=_e(e).containerId||he,o=document.getElementById(n),s=!1;o||(o=document.createElement("div"),o.id=n,s=!0);let c=o.querySelector("iframe");c&&o.removeChild(c);let i=document.createElement("iframe");i.setAttribute("allow","camera; microphone; autoplay; encrypted-media; fullscreen; picture-in-picture; display-capture"),i.src=r,i.classList.add("video-engager-widget-iframe"),o.appendChild(i),s&&document.body.appendChild(o)}function wt(r){let t=_e(r).containerId||he,n=document.querySelector(".video-engager-widget-iframe");n&&n.remove();let o=document.getElementById(t);o&&o.remove()}function Dt(r){let t=_e(r).containerId||he,n=document.getElementById(t);return n?n.querySelector(".video-engager-widget-iframe"):null}var Je={openIframe:Ot,closeIframe:wt,getIframe:Dt};function Ze(){if(document.getElementById("video-engager-widget-styles"))return;let r=document.createElement("style");r.id="video-engager-widget-styles",r.innerHTML=`
        .video-engager-widget-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        #video-engager-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }
    `,document.head.appendChild(r)}function Xe(r){if((!r.domain||typeof r.domain!="string"||r.domain.trim()==="")&&(r.domain="videome.leadsecure.com"),r.domain=bt(r.domain),r.authMethod||(r.authMethod="generic"),r.options||(r.options={}),"containerId"in r.options&&typeof r.options.containerId!="string")throw new d(d.codes.CONFIG_CONTAINER_ID_INVALID_TYPE);if("uiHandlers"in r.options&&r.options.uiHandlers){let e=["openIframe","closeIframe","getIframe"];for(let t of e)if(!r.options.uiHandlers[t]||typeof r.options.uiHandlers[t]!="function")throw new d(d.codes.UI_HANDLERS_METHOD_REQUIRED,{context:{missingMethod:t}})}return r}function bt(r){if(typeof r!="string"||r.trim()==="")throw new d(d.codes.CONFIG_DOMAIN_REQUIRED);try{let e=!r.startsWith("http://")&&!r.startsWith("https://");return new URL(e?`https://${r}`:r).host}catch(e){throw new d(d.codes.CONFIG_DOMAIN_INVALID_FORMAT,{originalError:e,context:{providedDomain:r}})}}function Ae(r){let{OperationRunningError:e,ConflictError:t,OperationAbortedError:n,OperationTimeoutError:o}=U;return d.isVeError(r)?r:r instanceof e?new d(d.codes.OPERATION_ALREADY_RUNNING,{originalError:r,context:{operationName:r.op}}):r instanceof t?new d(d.codes.OPERATION_CONFLICT,{originalError:r,context:{operationName:r.op,conflictingOperations:r.conflicts}}):r instanceof n?new d(d.codes.OPERATION_ABORTED,{originalError:r,context:{operationName:r.op}}):r instanceof o?new d(d.codes.OPERATION_TIMEOUT,{originalError:r,context:{operationName:r.op,timeoutMs:r.ms}}):new d(d.codes.VE_UNHANDLED_ERROR,{originalError:r instanceof Error?r:new Error(et(r)),context:{message:et(r)}})}function et(r){return typeof r=="string"?r:typeof r=="object"&&r!==null&&"message"in r&&typeof r.message=="string"?r.message:typeof r=="object"&&r!==null?JSON.stringify(r):String(r)}var E=class E{constructor(){l(this,"logger");l(this,"eventEmitter",new oe);l(this,"authParameters");l(this,"promiseManager");l(this,"PromiseManager",U);l(this,"configs");l(this,"_isInitialized",!1);l(this,"cleanups",[]);l(this,"callState",this.defaultCallState);l(this,"handlerErrors",e=>{let t=Ae(e);return this.logger.error("Error in VideoEngagerAgent operation:",t.toJSON()),t});l(this,"on",this.eventEmitter.on.bind(this.eventEmitter));l(this,"off",this.eventEmitter.off.bind(this.eventEmitter));this.logger=le(!0,{component:"VideoEngagerAgent"}),this.promiseManager=new U(this.logger),this.logger.info("VideoEngagerAgent loaded")}get defaultCallState(){return{status:"NONE",callerEmail:"",email:"",tennant_id:"",visitorId:"",pin:"",shortUrl:"",attributes:{},inActiveSession:!1}}static getInstance(){return E._instance||(E._instance=new E),E._instance}static async init(e){return z&&await z.catch(t=>{}),E._instance||(E._instance=new E),await E._instance.initialize(e)}async initialize(e){return await this.promiseManager.run("initialize",async()=>{if(this._isInitialized)throw new d(d.codes.AGENT_ALREADY_INITIALIZED);this.configs=Xe(e),this.logger=le(e.logger,{component:"VideoEngagerAgent"});let t=!!this.configs.authMethod&&this.configs.authMethod in me&&me[this.configs.authMethod];if(!t)throw new d(d.codes.AUTH_METHOD_NOT_SUPPORTED,{context:{authMethod:this.configs.authMethod}});let n=new t(this.configs);this.authParameters=await n.authenticate(),"uiHandlers"in(this.configs.options||{})||Ze(),this.registerSmartVideoEvents(),this._isInitialized=!0,this.logger.info("VideoEngagerAgent Authenticated Successfully")},{waitIfRunning:!1,transformError:this.handlerErrors})}registerSmartVideoEvents(){let e=t=>{var n;t.origin===`https://${this.configs.domain}`&&(this.logger.info("Received message from VideoEngager widget: ",t.data),(n=t.data)!=null&&n.status&&this.handleStatusEvent(t.data))};window.addEventListener("message",e),this.logger.info("Registered message event listener for VideoEngager widget"),this.cleanups.push(()=>{this.logger.info("Removing message event listener"),window.removeEventListener("message",e)})}updateCallState(e,t=!0){let n=e.attributes||{},o={...this.callState.attributes,...n};this.callState={...this.callState,...e,attributes:o},this.logger.info(`Call state updated: ${JSON.stringify(this.callState)}`),t&&this.eventEmitter.emit("callStateUpdated",{...this.callState})}async handleStatusEvent(e){return this.promiseManager.run("handleStatusEvent",async()=>{if(!e||!e.status){this.logger.debug("Received empty payload for status event");return}this.logger.info(`Handling status event: ${e.status}`);let t=this.callState.visitorId,n=this.callState.status,o=!1;switch(e.status){case"PRE_CALL":this.updateCallState(e,!1),t!==e.visitorId&&(this.callState.inActiveSession=!0,this.eventEmitter.emit("sessionStarted",{...this.callState})),o=!0;break;case"CALL_STARTED":this.updateCallState(e);break;case"END_CALL":if(n!=="CALL_STARTED"){this.logger.warn("Call not started yet, ignoring END_CALL event");return}this.updateCallState(e);break;case"FINISHED":if(n==="FINISHED"){this.logger.debug("Call already finished, ignoring duplicate FINISHED event");return}if(n==="NONE"){this.logger.warn("Call Never Started, this indicates a failure to start the call, ignoring FINISHED event"),this.eventEmitter.emit("sessionFailed",e);return}this.callState.inActiveSession=!0,this.updateCallState(e,!1),this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState}),await new Promise(s=>setTimeout(s,10)),this.logger.info("Resetting call state after session finished"),this.callState=this.defaultCallState;break;default:this.logger.warn(`Unhandled status event: ${e.status}`);break}o&&this.eventEmitter.emit("callStateUpdated",{...this.callState})},{waitIfRunning:!0})}async call(e){return await this.promiseManager.run("call",async()=>{if(!this._isInitialized||!this.authParameters)throw new d(d.codes.AGENT_NOT_AUTHENTICATED);this.logger.info("Calling VideoEngagerAgent with auth parameters:");let t={...this.authParameters,enablePostMessage:"true",authPopup:"true"},n=e==null?void 0:e.customerId;if(n&&typeof n!="string")throw new d(d.codes.PARAM_CUSTOMER_ID_INVALID_TYPE);n&&(t.veinteraction=n);let o=new URLSearchParams(t),s=`https://${this.configs.domain}/nextjs/single/smartvideo/?${o.toString()}`;await this.handlersUi.openIframe(s,this.configs),this.logger.info("VideoEngagerAgent call completed. Widget is ready.")},{waitFor:["initialize"],conflictsWith:["endCall"],waitIfRunning:!1,transformError:this.handlerErrors})}async endCall(){return await this.promiseManager.run("endCall",async()=>{if(!this.callState.inActiveSession)throw this.logger.warn("No active session to end"),new d(d.codes.CALL_NOT_STARTED);this.logger.info("Ending call"),await this.handlersUi.closeIframe(this.configs),this.logger.info("closed iframe"),this.callState.inActiveSession&&(this.callState.status=Ke.FINISHED,this.callState.inActiveSession=!1,this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState})),this.logger.info("Call ended and iframe closed"),this.callState=this.defaultCallState},{waitFor:["initialize","call"],waitIfRunning:!1,waitForDelayMs:500,transformError:this.handlerErrors})}async cleanup(){var e;this.logger.info("Cleaning up VideoEngagerAgent resources");try{(e=this.callState)!=null&&e.inActiveSession&&await this.endCall()}catch(t){this.logger.warn("Error closing iframe during cleanup:"+String(t))}this.cleanups.forEach(t=>{try{t()}catch(n){this.logger.warn("Error during cleanup:"+String(n))}}),this.cleanups.length=0,await this.promiseManager.waitFor("handleStatusEvent"),await this.eventEmitter.emit("cleanup",void 0,{awaitListeners:!0}).catch(t=>{this.logger.warn("Error emitting cleanup event:"+String(t))}),this.logger.info("Emitted cleanup event to listeners");try{await this.eventEmitter.shutdown(1e3)}catch(t){this.logger.warn("Error during event emitter shutdown:"+String(t))}this.promiseManager.abortAll("cleanup"),this.callState=this.defaultCallState,this._isInitialized=!1,this.authParameters=void 0,this.promiseManager=void 0,this.eventEmitter=void 0,this.logger.info("VideoEngagerAgent cleanup completed"),this.logger=void 0,this.configs=void 0}isInitialized(){return this._isInitialized}static call(...e){if(!E._instance)throw new d(d.codes.AGENT_NOT_INITIALIZED);return E._instance.call.bind(E._instance)(...e)}static endCall(...e){if(!E._instance)throw new d(d.codes.AGENT_NOT_INITIALIZED);return E._instance.endCall.bind(E._instance)(...e)}static isInitialized(){return E._instance!==null&&E._instance.isInitialized()}static async destroy(){if(z)throw new d(d.codes.OPERATION_ALREADY_RUNNING,{context:{operationName:"destroy"}});if(E._instance)try{z=E._instance.cleanup(),await z}finally{z=null,E._instance=null}}get handlersUi(){let e=this.configs.options||{};return"uiHandlers"in e&&e.uiHandlers||Je}};l(E,"VERSION",B),l(E,"_instance",null),l(E,"on",((...e)=>E.getInstance().on.bind(E.getInstance())(...e))),l(E,"off",((...e)=>E.getInstance().off.bind(E.getInstance())(...e)));var w=E,z=null,vt=w.init,Ut=w.getInstance,xt=w.isInitialized,Vt=w.destroy,Lt=w.call,Pt=w.endCall,Mt=w.on,Ft=w.off,Ht=w;
