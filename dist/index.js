"use strict";var Ie=Object.defineProperty;var Kt=Object.getOwnPropertyDescriptor;var Zt=Object.getOwnPropertyNames;var Jt=Object.prototype.hasOwnProperty;var St=r=>{throw TypeError(r)};var Xt=(r,e,t)=>e in r?Ie(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var er=(r,e)=>{for(var t in e)Ie(r,t,{get:e[t],enumerable:!0})},tr=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Zt(e))!Jt.call(r,i)&&i!==t&&Ie(r,i,{get:()=>e[i],enumerable:!(n=Kt(e,i))||n.enumerable});return r};var rr=r=>tr(Ie({},"__esModule",{value:!0}),r);var c=(r,e,t)=>Xt(r,typeof e!="symbol"?e+"":e,t),Pe=(r,e,t)=>e.has(r)||St("Cannot "+t);var P=(r,e,t)=>(Pe(r,e,"read from private field"),t?t.call(r):e.get(r)),k=(r,e,t)=>e.has(r)?St("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),Ue=(r,e,t,n)=>(Pe(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t),Y=(r,e,t)=>(Pe(r,e,"access private method"),t);var En={};er(En,{VEErrorCodes:()=>d,VEErrorDetails:()=>He,VERSION:()=>q,VideoEngagerAgent:()=>I,VideoEngagerAgentError:()=>o,acceptCall:()=>sn,agentSettings:()=>cn,call:()=>en,default:()=>mn,destroy:()=>Xr,endCall:()=>tn,getCurrentCallState:()=>gn,getDisplayName:()=>ln,getInstance:()=>Zr,getReceivedCalls:()=>un,init:()=>Kr,isIframeOpened:()=>on,isInitialized:()=>Jr,isOnQueue:()=>pn,isOnline:()=>fn,off:()=>nn,on:()=>rn,rejectCall:()=>an,setUiHandler:()=>dn,switchQueue:()=>hn});module.exports=rr(En);function Nt(r){return{all:r=r||new Map,on:function(e,t){var n=r.get(e);n?n.push(t):r.set(e,[t])},off:function(e,t){var n=r.get(e);n&&(t?n.splice(n.indexOf(t)>>>0,1):r.set(e,[]))},emit:function(e,t){var n=r.get(e);n&&n.slice().map(function(i){i(t)}),(n=r.get("*"))&&n.slice().map(function(i){i(e,t)})}}}var N=[];for(let r=0;r<256;++r)N.push((r+256).toString(16).slice(1));function wt(r,e=0){return(N[r[e+0]]+N[r[e+1]]+N[r[e+2]]+N[r[e+3]]+"-"+N[r[e+4]]+N[r[e+5]]+"-"+N[r[e+6]]+N[r[e+7]]+"-"+N[r[e+8]]+N[r[e+9]]+"-"+N[r[e+10]]+N[r[e+11]]+N[r[e+12]]+N[r[e+13]]+N[r[e+14]]+N[r[e+15]]).toLowerCase()}var Ve,nr=new Uint8Array(16);function ke(){if(!Ve){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ve=crypto.getRandomValues.bind(crypto)}return Ve(nr)}var ir=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Fe={randomUUID:ir};function or(r,e,t){var i,s,a;if(Fe.randomUUID&&!e&&!r)return Fe.randomUUID();r=r||{};let n=(a=(s=r.random)!=null?s:(i=r.rng)==null?void 0:i.call(r))!=null?a:ke();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let l=0;l<16;++l)e[t+l]=n[l];return e}return wt(n)}var D=or;var ne=class extends Error{constructor(t){super(`Operation "${t}" is already running`);this.op=t}},ie=class extends Error{constructor(t,n){super(`Cannot run "${t}" while [${n.join(", ")}] are running`);this.op=t;this.conflicts=n}},O=class extends Error{constructor(t){super(`Operation "${t}" was aborted`);this.op=t}},U=class extends Error{constructor(t,n){super(`Operation "${t}" timed out after ${n} ms`);this.op=t;this.ms=n}};var Ge=class{constructor(){c(this,"_emitter");c(this,"_listeners",new Map);c(this,"_pendingEvents",new Set);c(this,"_shuttingDown",!1);c(this,"addListener",this.on.bind(this));c(this,"removeListener",this.off.bind(this));this._emitter=Nt()}on(e,t,n={async:!1}){var s;let i={id:D(),isAsync:(s=n.async)!=null?s:!1,originalHandler:t,wrappedHandler:async(...a)=>{if(!this._shuttingDown)try{if(i.isAsync){let l=Promise.resolve().then(()=>t(...a));this._pendingEvents.add(l),await l.finally(()=>this._pendingEvents.delete(l))}else await t(...a)}catch(l){console.error(`[SafeEventBus] Handler failed for "${e}":`,l),this.emit("error",{event:e,error:l,payload:a})}}};return this._listeners.has(e)||this._listeners.set(e,[]),this._listeners.get(e).push(i),this._emitter.on(e,i.wrappedHandler),()=>this.off(e,t)}once(e,t,n={async:!1}){let i=async s=>{this.off(e,i),await t(s)};return this.on(e,i,n)}waitFor(e,t=5e3,n,i="resolve"){if(n&&typeof n!="function")throw new Error("Filter must be a function");let s,a,l=()=>{};return{promise:new Promise((f,m)=>{t!==-1&&(s=setTimeout(()=>{a&&a(),m(new U(`Timeout waiting for event: ${e}`,t))},t)),a=this.on(e,y=>{try{if(n&&!n(y))return;clearTimeout(s),a&&a(),f(y)}catch(E){clearTimeout(s),a&&a(),m(E);return}}),l=y=>{if(t!==-1&&clearTimeout(s),a&&a(),i==="reject"){m(new O(`Wait for event cancelled: ${e}`));return}f(y||void 0)}}),cancel:l}}waitForAny(e,t=5e3,n,i="resolve"){if(!Array.isArray(e)||e.length===0)throw new Error("eventNames must be a non-empty array");if(n&&typeof n!="function")throw new Error("Filter must be a function");let s,a=[],l=()=>{};return{promise:new Promise((f,m)=>{t!==-1&&(s=setTimeout(()=>{a.forEach(E=>E()),m(new U(`Timeout waiting for any of events: ${e.join(", ")}`,t))},t));let y=E=>S=>{try{if(n&&!n({event:E,payload:S}))return;clearTimeout(s),a.forEach(_=>_()),f({event:E,payload:S})}catch(_){clearTimeout(s),a.forEach(A=>A()),m(_)}};e.forEach(E=>{let S=this.on(E,y(E));a.push(S)}),l=E=>{if(t!==-1&&clearTimeout(s),a.forEach(S=>S()),i==="reject"){m(new O(`Wait for any event cancelled: ${e.join(", ")}`));return}f(E||void 0)}}),cancel:l}}off(e,t){let n=this._listeners.get(e);if(!n)return;let i=n.findIndex(s=>s.originalHandler===t);if(i!==-1){let[s]=n.splice(i,1);this._emitter.off(e,s.wrappedHandler)}n.length===0&&this._listeners.delete(e)}async emit(e,t,n={}){if(this._shuttingDown){console.warn(`[SafeEventBus] Emit ignored during shutdown: ${e}`);return}if(n.awaitListeners){let i=this._listeners.get(e)||[];for(let{wrappedHandler:s}of i)try{await s(t)}catch(a){console.error(`[SafeEventBus] Sequential handler error: ${e}`,a)}}else this._emitter.emit(e,t)}async shutdown(e=5e3){this._shuttingDown=!0;let t=new Promise((n,i)=>setTimeout(()=>i(new Error("Shutdown timeout")),e));try{await Promise.race([Promise.allSettled([...this._pendingEvents]),t])}catch(n){console.error("[SafeEventBus] Shutdown error:",n)}finally{this._listeners.clear(),this._emitter.all.clear()}}subscribe(e,t){return this.on(e,t)}getListenerCount(e){var t;return e?((t=this._listeners.get(e))==null?void 0:t.length)||0:[...this._listeners.values()].reduce((n,i)=>n+i.length,0)}},V=Ge;var L=D(),sr=new RegExp('(\\\\)?"@__(F|R|D|M|S|A|U|I|B|L)-'+L+'-(\\d+)__@"',"g"),ar=/\{\s*\[native code\]\s*\}/g,lr=/function.*?\(/,cr=/.*?=>.*?/,dr=/[<>\/\u2028\u2029]/g,gr=["*","async"],ur={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"};function hr(r){return ur[r]}function bt(r){let e=[];for(let t in r)typeof r[t]=="function"&&e.push(t);for(let t=0;t<e.length;t++)delete r[e[t]]}function Ot(r){let e=r.toString();if(ar.test(e))throw new TypeError("Serializing native function: "+r.name);if(lr.test(e)||cr.test(e))return e;let t=e.indexOf("("),n=e.substr(0,t).trim().split(" ").filter(function(s){return s.length>0});return n.filter(function(s){return gr.indexOf(s)===-1}).length>0?(n.indexOf("async")>-1?"async ":"")+"function"+(n.join("").indexOf("*")>-1?"*":"")+e.substr(t):e}function pr(r,e){let t=new WeakMap,n={__circularRefId:0};function i(s,a){try{if(e.ignoreFunction&&a&&typeof a=="object"&&bt(a),a===null||a===0||a===!1||a===""||!a&&a!==void 0&&a!==BigInt(0))return a;let l=this[s],h=typeof l;if(h==="object"&&l!==null){if(t.has(l))return{__type:"CircularRef",refId:t.get(l)};let f=n.__circularRefId++;if(t.set(l,f),l instanceof RegExp)return{__type:"RegExp",source:l.source,flags:l.flags};if(l instanceof Date)return isNaN(l.getTime())?{__type:"Date",value:"Invalid Date"}:{__type:"Date",value:l.toISOString()};if(l instanceof Map)return{__type:"Map",entries:Array.from(l.entries())};if(l instanceof Set)return{__type:"Set",values:Array.from(l.values())};if(l instanceof Array)return l.length!==Object.keys(l).length?{__type:"SparseArray",length:l.length,entries:Object.assign({},l)}:l;if(l instanceof URL)return{__type:"URL",value:l.toString()};if(l instanceof Error)return{__type:"Error",name:l.name,message:l.message,stack:l.stack}}if(h==="function"){if(e.ignoreFunction)return;try{return{__type:"Function",value:Ot(l),name:l.name}}catch(f){return{__type:"Function",error:f.message,name:l.name}}}if(h==="undefined")return{__type:"undefined"};if(h==="number"){if(isNaN(l))return{__type:"NaN"};if(!isFinite(l))return{__type:"Infinity",value:l>0?"Infinity":"-Infinity"}}return h==="bigint"?{__type:"BigInt",value:l.toString()}:h==="symbol"?{__type:"Symbol",description:l.description}:a}catch(l){return{__type:"SerializationError",error:l.message}}}try{if(e.ignoreFunction&&typeof r=="function"&&(r=void 0),r===void 0)return{__type:"undefined"};if(r===null)return null;let s=JSON.stringify(r,i,e.space);return s===void 0?{__type:"undefined"}:JSON.parse(s)}catch(s){return{__type:"SerializationError",error:s.message,originalType:typeof r}}}function F(r,e){if(e||(e={}),(typeof e=="number"||typeof e=="string")&&(e={space:e}),e.returnObject)return pr(r,e);let t=[],n=[],i=[],s=[],a=[],l=[],h=[],f=[],m=[],y=[],E=new WeakSet;function S(A,T){if(e.ignoreFunction&&bt(T),!T&&T!==void 0&&T!==BigInt(0))return T;let p=this[A],C=typeof p;if(C==="object"&&p!==null){if(E.has(p))return"[Circular]";if(E.add(p),p instanceof RegExp)return"@__R-"+L+"-"+(n.push(p)-1)+"__@";if(p instanceof Date)return"@__D-"+L+"-"+(i.push(p)-1)+"__@";if(p instanceof Map)return"@__M-"+L+"-"+(s.push(p)-1)+"__@";if(p instanceof Set)return"@__S-"+L+"-"+(a.push(p)-1)+"__@";if(p instanceof Array&&p.filter(function(){return!0}).length!==p.length)return"@__A-"+L+"-"+(l.push(p)-1)+"__@";if(p instanceof URL)return"@__L-"+L+"-"+(y.push(p)-1)+"__@"}return C==="function"?"@__F-"+L+"-"+(t.push(p)-1)+"__@":C==="undefined"?"@__U-"+L+"-"+(h.push(p)-1)+"__@":C==="number"&&!isNaN(p)&&!isFinite(p)?"@__I-"+L+"-"+(f.push(p)-1)+"__@":C==="bigint"?"@__B-"+L+"-"+(m.push(p)-1)+"__@":T}if(e.ignoreFunction&&typeof r=="function"&&(r=void 0),r===void 0)return String(r);let _;return e.isJSON&&!e.space?_=JSON.stringify(r):_=JSON.stringify(r,e.isJSON?null:S,e.space),typeof _!="string"?String(_):(e.unsafe!==!0&&(_=_.replace(dr,hr)),t.length===0&&n.length===0&&i.length===0&&s.length===0&&a.length===0&&l.length===0&&h.length===0&&f.length===0&&m.length===0&&y.length===0?_:_.replace(sr,function(A,T,p,C){if(T)return A;if(p==="D")return'new Date("'+i[C].toISOString()+'")';if(p==="R")return"new RegExp("+F(n[C].source)+', "'+n[C].flags+'")';if(p==="M")return"new Map("+F(Array.from(s[C].entries()),e)+")";if(p==="S")return"new Set("+F(Array.from(a[C].values()),e)+")";if(p==="A")return"Array.prototype.slice.call("+F(Object.assign({length:l[C].length},l[C]),e)+")";if(p==="U")return"undefined";if(p==="I")return f[C];if(p==="B")return'BigInt("'+m[C]+'")';if(p==="L")return"new URL("+F(y[C].toString(),e)+")";let ee=t[C];return Ot(ee)}))}var oe=class r extends Error{constructor(t,n,i,s={},a="1.0.0"){super(n);c(this,"idempotencyKey",D());c(this,"cause");c(this,"context");c(this,"code");c(this,"version");this.name=t||"VideoEngagerError",this.cause=i,this.message=`VideoEngagerError: ${this.cause.name}`,this.code=i.code,this.context=s,this.version=a}static isVeError(t){return t instanceof r}toString(){let t=this.cause.description||"No description available",n=this.cause.originalError?`
Original Error: ${this.cause.originalError.message}`:"";return`${this.name} [${this.code}]: ${t}${n}`}toJSON(){var t;return F({name:this.name,message:this.message,code:this.code,cause:{...this.cause,originalError:(t=this.cause.originalError)==null?void 0:t.message},context:this.context,version:this.version,stack:this.stack,idempotencyKey:this.idempotencyKey},{ignoreFunction:!0,returnObject:!0})}},fr=["code","name","description"];function mr(r,e){let t=(n,i)=>{if(!n||typeof n!="object"||Object.keys(n).length===0)throw new Error(`Invalid VideoEngager ${i} configuration`)};t(r,"error codes"),t(e,"error details"),Object.values(r).forEach(n=>{e[n]||console.warn(`Missing error details for code: ${n}`)}),Object.entries(e).forEach(([n,i])=>{if(!i||typeof i!="object")throw new Error(`Invalid error details for code: ${n}`);fr.forEach(s=>{if(!(s in i))throw new Error(`Missing required field '${s}' in error details for code: ${n}`)})})}var Er={name:"UnknownError",description:"An unknown error occurred",code:"unknown"};function vt(r,e,t="VideoEngager",n="1.0.0"){mr(r,e);let s=class s extends oe{constructor(l,h={}){let{originalError:f,context:m={},retryable:y,component:E=t}=h,S=e[l];S||console.warn(`Unknown error code: ${l}. Falling back to unhandled error.`);let _=S||Er,A=typeof f=="string"?new Error(f):f,T={code:_.code,name:_.name,description:_.description,retryable:y,component:E,originalError:A},p=`VideoEngagerError: ${_.name||(A==null?void 0:A.message)||"UnknownError"}`;super("VideoEngagerError",p,T,m,n),this.code=l,this.cause=T,Ir(this)}static isVeError(l){return l instanceof oe}static isOwnError(l){return l instanceof s}static getErrorDetails(l){return e[l]}static isValidCode(l){return Object.values(r).includes(l)}};c(s,"codes",r),c(s,"errorsDetails",e);let i=s;return i}var _r=new V,Ar=300*1e3,Rt=1e3,G=new Map;function Ir(r){if(!r||typeof r!="object")return;if(!("idempotencyKey"in r))try{Object.assign(r,{idempotencyKey:D()})}catch{return}let e=r.idempotencyKey,t=Date.now();for(let[n,i]of G)t-i>Ar&&G.delete(n);if(!G.has(e)&&(G.set(e,t),_r.emit("error",r),G.size>Rt)){let n=G.size-Rt,i=0;for(let s of G.keys())if(G.delete(s),++i>=n)break}}var q="4.0.1";var d=Object.freeze({AGENT_ALREADY_INITIALIZED:"agent|already-initialized",AGENT_NOT_INITIALIZED:"agent|not-initialized",AGENT_NOT_AUTHENTICATED:"agent|not-authenticated",AUTH_METHOD_NOT_SUPPORTED:"auth|method-not-supported",AUTH_GENESYS_ENVIRONMENT_REQUIRED:"auth|genesys-environment-required",AUTH_GENERIC_API_KEY_REQUIRED:"auth|generic-api-key-required",AUTH_GENERIC_EXTERNAL_ID_REQUIRED:"auth|generic-external-id-required",AUTH_GENERIC_AGENT_EMAIL_REQUIRED:"auth|generic-agent-email-required",AUTH_CUSTOM_FUNCTION_REQUIRED:"auth|custom-function-required",AUTH_CUSTOM_PARAMETERS_MISSING:"auth|custom-parameters-missing",AUTH_CUSTOM_PARAMETERS_INVALID_TYPE:"auth|custom-parameters-invalid-type",AUTH_CUSTOM_PARAMETERS_EMPTY:"auth|custom-parameters-empty",AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE:"auth|custom-parameters-invalid-value-type",AUTH_TOKEN_REQUIRED:"auth|token-required",CONFIG_DOMAIN_REQUIRED:"config|domain-required",CONFIG_DOMAIN_INVALID_FORMAT:"config|domain-invalid-format",CONFIG_CONTAINER_ID_INVALID_TYPE:"config|container-id-invalid-type",UI_HANDLERS_BAD_CONFIG:"ui-handlers|bad-config",UI_HANDLERS_METHOD_REQUIRED:"ui-handlers|method-required",UI_HANDLERS_NOT_INITIALIZED:"ui-handlers|not-initialized",PARAM_CUSTOMER_ID_INVALID_TYPE:"param|customer-id-invalid-type",SESSION_ALREADY_ACTIVE:"session|already-active",SESSION_NOT_FOUND:"session|not-found",SESSION_FAILED_TO_START:"session|failed-to-start",CALL_NOT_STARTED:"call|not-started",CALL_ALREADY_FINISHED:"call|already-finished",WIDGET_IFRAME_LOAD_FAILED:"widget|iframe-load-failed",WIDGET_IFRAME_NOT_FOUND:"widget|iframe-not-found",WIDGET_CONTAINER_NOT_FOUND:"widget|container-not-found",OPERATION_ALREADY_RUNNING:"operation|already-running",OPERATION_TIMEOUT:"operation|timeout",OPERATION_CONFLICT:"operation|conflict",OPERATION_ABORTED:"operation|aborted",VE_UNHANDLED_ERROR:"ve|unhandled-error",INVALID_ARGUMENT:"validation|invalid-argument",REQUIRED_FIELD_MISSING:"validation|required-field-missing",AGENT_NOT_IN_STANDALONE_MODE:"standalone|agent-not-in-standalone-mode",VISITOR_HAS_LEFT_SESSION:"standalone|visitor-has-left-session",SESSION_ACCEPTED_BY_ANOTHER_AGENT:"standalone|session-accepted-by-another-agent",SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE:"standalone|session-accepted-by-self-on-another-device"}),He=Object.freeze({[d.AGENT_ALREADY_INITIALIZED]:{name:"AgentAlreadyInitialized",description:"VideoEngager Agent is already initialized. Cannot initialize again.",code:d.AGENT_ALREADY_INITIALIZED},[d.AGENT_NOT_INITIALIZED]:{name:"AgentNotInitialized",description:"VideoEngager Agent is not initialized. Call initialize() first.",code:d.AGENT_NOT_INITIALIZED},[d.AGENT_NOT_AUTHENTICATED]:{name:"AgentNotAuthenticated",description:"VideoEngager Agent is not authenticated. Call initialize() first.",code:d.AGENT_NOT_AUTHENTICATED},[d.AUTH_METHOD_NOT_SUPPORTED]:{name:"AuthMethodNotSupported",description:"The specified authentication method is not supported.",code:d.AUTH_METHOD_NOT_SUPPORTED},[d.AUTH_GENESYS_ENVIRONMENT_REQUIRED]:{name:"GenesysEnvironmentRequired",description:"Genesys environment is required for Genesys authentication.",code:d.AUTH_GENESYS_ENVIRONMENT_REQUIRED},[d.AUTH_GENERIC_API_KEY_REQUIRED]:{name:"GenericApiKeyRequired",description:"API key is required for generic authentication.",code:d.AUTH_GENERIC_API_KEY_REQUIRED},[d.AUTH_GENERIC_AGENT_EMAIL_REQUIRED]:{name:"GenericAgentEmailRequired",description:"Agent email is required for generic authentication.",code:d.AUTH_GENERIC_AGENT_EMAIL_REQUIRED},[d.AUTH_GENERIC_EXTERNAL_ID_REQUIRED]:{name:"GenericExternalIdRequired",description:"External ID is required for generic authentication in standalone mode.",code:d.AUTH_GENERIC_EXTERNAL_ID_REQUIRED},[d.AUTH_CUSTOM_FUNCTION_REQUIRED]:{name:"CustomAuthFunctionRequired",description:"Custom authentication function is required for custom authentication.",code:d.AUTH_CUSTOM_FUNCTION_REQUIRED},[d.AUTH_CUSTOM_PARAMETERS_MISSING]:{name:"CustomAuthParametersMissing",description:"Authentication parameters are missing in the response from custom authentication function.",code:d.AUTH_CUSTOM_PARAMETERS_MISSING},[d.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE]:{name:"CustomAuthParametersInvalidType",description:"Authentication parameters should be an object.",code:d.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE},[d.AUTH_CUSTOM_PARAMETERS_EMPTY]:{name:"CustomAuthParametersEmpty",description:"Authentication parameters are empty.",code:d.AUTH_CUSTOM_PARAMETERS_EMPTY},[d.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE]:{name:"CustomAuthParametersInvalidValueType",description:"Invalid type for authentication parameter. Only string, number, and boolean are supported.",code:d.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE},[d.AUTH_TOKEN_REQUIRED]:{name:"AuthTokenRequired",description:"Token is required for token-based authentication.",code:d.AUTH_TOKEN_REQUIRED},[d.CONFIG_DOMAIN_REQUIRED]:{name:"DomainRequired",description:"Domain must be a non-empty string.",code:d.CONFIG_DOMAIN_REQUIRED},[d.CONFIG_DOMAIN_INVALID_FORMAT]:{name:"DomainInvalidFormat",description:"Invalid domain format. Please provide a valid domain.",code:d.CONFIG_DOMAIN_INVALID_FORMAT},[d.CONFIG_CONTAINER_ID_INVALID_TYPE]:{name:"ContainerIdInvalidType",description:"Container ID must be a string.",code:d.CONFIG_CONTAINER_ID_INVALID_TYPE},[d.UI_HANDLERS_BAD_CONFIG]:{name:"UIHandlersBadConfig",description:"UI handlers are not configured correctly. Please check your UI handlers configuration.",code:d.UI_HANDLERS_BAD_CONFIG},[d.UI_HANDLERS_METHOD_REQUIRED]:{name:"UIHandlersMethodRequired",description:"Required UI handler method is missing or not a function.",code:d.UI_HANDLERS_METHOD_REQUIRED},[d.UI_HANDLERS_NOT_INITIALIZED]:{name:"UIHandlersNotInitialized",description:"UI handlers are not initialized. Please ensure that the UI handlers are set up before using them.",code:d.UI_HANDLERS_NOT_INITIALIZED},[d.PARAM_CUSTOMER_ID_INVALID_TYPE]:{name:"CustomerIdInvalidType",description:"Customer ID must be a string and not empty.",code:d.PARAM_CUSTOMER_ID_INVALID_TYPE},[d.SESSION_ALREADY_ACTIVE]:{name:"SessionAlreadyActive",description:"A session is already active. Cannot start a new session.",code:d.SESSION_ALREADY_ACTIVE},[d.SESSION_NOT_FOUND]:{name:"SessionNotFound",description:"No active session found.",code:d.SESSION_NOT_FOUND},[d.SESSION_FAILED_TO_START]:{name:"SessionFailedToStart",description:"Failed to start the video session.",code:d.SESSION_FAILED_TO_START},[d.CALL_NOT_STARTED]:{name:"CallNotStarted",description:"Call has not been started yet.",code:d.CALL_NOT_STARTED},[d.CALL_ALREADY_FINISHED]:{name:"CallAlreadyFinished",description:"Call has already finished.",code:d.CALL_ALREADY_FINISHED},[d.WIDGET_IFRAME_LOAD_FAILED]:{name:"WidgetIframeLoadFailed",description:"Failed to load the VideoEngager widget iframe.",code:d.WIDGET_IFRAME_LOAD_FAILED},[d.WIDGET_IFRAME_NOT_FOUND]:{name:"WidgetIframeNotFound",description:"VideoEngager widget iframe not found in the DOM.",code:d.WIDGET_IFRAME_NOT_FOUND},[d.WIDGET_CONTAINER_NOT_FOUND]:{name:"WidgetContainerNotFound",description:"VideoEngager widget container not found in the DOM.",code:d.WIDGET_CONTAINER_NOT_FOUND},[d.OPERATION_ALREADY_RUNNING]:{name:"OperationAlreadyRunning",description:"Operation is already running and cannot be started again.",code:d.OPERATION_ALREADY_RUNNING},[d.OPERATION_TIMEOUT]:{name:"OperationTimeout",description:"Operation timed out before completion.",code:d.OPERATION_TIMEOUT},[d.OPERATION_CONFLICT]:{name:"OperationConflict",description:"Cannot run operation due to conflicting operations already running.",code:d.OPERATION_CONFLICT},[d.OPERATION_ABORTED]:{name:"OperationAborted",description:"Operation was aborted before completion.",code:d.OPERATION_ABORTED},[d.VE_UNHANDLED_ERROR]:{name:"UnhandledError",description:"An unhandled error occurred in the VideoEngager system. Please check the logs for more details.",code:d.VE_UNHANDLED_ERROR},[d.INVALID_ARGUMENT]:{name:"InvalidArgument",description:"Invalid argument provided to the function.",code:d.INVALID_ARGUMENT},[d.REQUIRED_FIELD_MISSING]:{name:"RequiredFieldMissing",description:"Required field is missing or empty.",code:d.REQUIRED_FIELD_MISSING},[d.AGENT_NOT_IN_STANDALONE_MODE]:{name:"AgentNotInStandaloneMode",description:"The requested operation is only available in standalone mode.",code:d.AGENT_NOT_IN_STANDALONE_MODE},[d.VISITOR_HAS_LEFT_SESSION]:{name:"VisitorHasLeftSession",description:"The visitor has left the session.",code:d.VISITOR_HAS_LEFT_SESSION},[d.SESSION_ACCEPTED_BY_ANOTHER_AGENT]:{name:"SessionAcceptedByAnotherAgent",description:"The session was accepted by another agent.",code:d.SESSION_ACCEPTED_BY_ANOTHER_AGENT},[d.SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE]:{name:"SessionAcceptedBySelfOnAnotherDevice",description:"The session was accepted by the same agent on another device or tab.",code:d.SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE}}),o=vt(d,He,"VideoEngagerAgent",q);var se=class{constructor(e){c(this,"name","custom");c(this,"configs");this.configs=e}async authenticate(){this.validateConfigs();let e=await this.configs.authenticateFn(this.configs);if(!e)throw new o(o.codes.AUTH_CUSTOM_PARAMETERS_MISSING);if(typeof e!="object")throw new o(o.codes.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE);if(Object.keys(e).length===0)throw new o(o.codes.AUTH_CUSTOM_PARAMETERS_EMPTY);let t={};for(let n in e){let i=e[n];if(typeof i!="string"&&typeof i!="number"&&typeof i!="boolean")throw new o(o.codes.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE,{context:{parameterKey:n,valueType:typeof i,actualValue:i}});t[n]=String(i)}return t}validateConfigs(){if(!this.configs.authenticateFn||typeof this.configs.authenticateFn!="function")throw new o(o.codes.AUTH_CUSTOM_FUNCTION_REQUIRED)}};var ae=class{constructor(e){c(this,"name","generic");c(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:"generic",pak:this.configs.apiKey,email:`${this.configs.organizationId?`${this.configs.organizationId}`:""}${this.configs.agentEmail}`}}validateConfigs(){if(!this.configs.apiKey||this.configs.apiKey==="")throw new o(o.codes.AUTH_GENERIC_API_KEY_REQUIRED);if(!this.configs.agentEmail||this.configs.agentEmail==="")throw new o(o.codes.AUTH_GENERIC_AGENT_EMAIL_REQUIRED);if(this.configs.standaloneMode&&(!this.configs.externalId||this.configs.externalId===""))throw new o(o.codes.AUTH_GENERIC_EXTERNAL_ID_REQUIRED)}};var le=class{constructor(e){c(this,"name","genesys");c(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:this.configs.environment}}validateConfigs(){if(!this.configs.environment||this.configs.environment==="")throw new o(o.codes.AUTH_GENESYS_ENVIRONMENT_REQUIRED)}};var ce=class{constructor(e){c(this,"name","token");c(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{token:this.configs.token}}validateConfigs(){if(!this.configs.token||this.configs.token==="")throw new o(o.codes.AUTH_TOKEN_REQUIRED)}};var $e=Object.freeze({generic:ae,genesys:le,custom:se,token:ce});var Dt=Object.freeze({NONE:"NONE",CALL_STARTED:"CALL_STARTED",PRE_CALL:"PRE_CALL",FINISHED:"FINISHED",END_CALL:"END_CALL"});var ye=class{constructor(e="sequential-reversed",t){this.logger=t;c(this,"actions",[]);c(this,"strategy");this.strategy=e}register(e){var t;this.actions.push(e),(t=this.logger)==null||t.debug(`Registered compensation action (total: ${this.actions.length})`)}registerIf(e,t){var n,i;e?(this.actions.push(t),(n=this.logger)==null||n.debug(`Conditionally registered compensation action (total: ${this.actions.length})`)):(i=this.logger)==null||i.debug("Compensation action not registered (condition false)")}registerIfLazy(e,t){var i;let n=async()=>{var s,a;try{await Promise.resolve(e())?await Promise.resolve(t()):(s=this.logger)==null||s.debug("Skipping lazy conditional action (condition false)")}catch(l){(a=this.logger)==null||a.error("Condition evaluation failed, treating as false:",l)}};this.actions.push(n),(i=this.logger)==null||i.debug(`Registered lazy conditional compensation action (total: ${this.actions.length})`)}getActionCount(){return this.actions.length}setStrategy(e){var t;(t=this.logger)==null||t.debug(`Changing compensation strategy from ${this.strategy} to ${e}`),this.strategy=e}getStrategy(){return this.strategy}async executeAll(){var t,n,i,s,a;if(this.actions.length===0){(t=this.logger)==null||t.debug("No compensation actions to execute");return}(n=this.logger)==null||n.debug(`Executing ${this.actions.length} compensation actions with strategy: ${this.strategy}`);let e=this.strategy==="sequential-reversed"?[...this.actions].reverse():this.actions;if(this.strategy==="parallel")(await Promise.allSettled(e.map(h=>Promise.resolve(h())))).forEach((h,f)=>{var m;h.status==="rejected"&&((m=this.logger)==null||m.error(`Compensation action ${f+1} failed:`,h.reason))});else for(let l=0;l<e.length;l++)try{await e[l](),(i=this.logger)==null||i.debug(`Compensation action ${l+1}/${e.length} completed`)}catch(h){(s=this.logger)==null||s.error(`Compensation action ${l+1} failed:`,h)}(a=this.logger)==null||a.debug("All compensation actions executed")}clear(){var e;this.actions=[],(e=this.logger)==null||e.debug("Cleared all compensation actions")}};var w=class{constructor(e,t={memoryLeakCheckTimeoutMs:1e4}){this.configs=t;c(this,"operations",new Map);c(this,"logger");this.logger=e}async run(e,t,n={}){var tt,rt,nt,it,ot,st,at,lt,ct,dt,gt,ut,ht,pt,ft,mt,Et,_t,At,It,yt,Ct;let{waitIfRunning:i=!1,useExistingRunResult:s=!1,onExistingRunFail:a="ignore",waitIfRunningDelayMs:l=0,conflictsWith:h=[],waitFor:f=[],waitForDelayMs:m=0,timeoutMs:y=0,signal:E,beforeRun:S,onSuccess:_,onAbort:A,onError:T,onWaitForRunsFail:p="ignore",transformError:C,compensationStrategy:ee="sequential-reversed",shouldCompensate:Ee}=n,z=new ye(ee,this.logger);(tt=this.logger)==null||tt.debug(`Running operation "${e}" with compensation strategy: ${ee}`);let Wt=setTimeout(()=>{var u;(u=this.logger)==null||u.warn(`Operation "${e}" is taking too long to complete. Possible memory leak detected.`)},this.configs.memoryLeakCheckTimeoutMs),te,_e,x=()=>{_e&&(clearTimeout(_e),_e=void 0),E&&te&&(E.removeEventListener("abort",te),te=void 0),clearTimeout(Wt)},H=C||(u=>u instanceof Error?u:new Error(String(u)));if(this.isRunning(e))if((rt=this.logger)==null||rt.debug(`"${e}" already running`),i||s){let R=await this.operations.get(e).promise.catch(b=>{var v;if(a==="throw")throw x(),b;return(v=this.logger)==null||v.debug(`"${e}" existing operation failed, ignoring error and continuing`),x(),b});if(l>0&&((nt=this.logger)==null||nt.debug(`Adding artificial delay of ${l}ms after waitIfRunning for "${e}"`),await new Promise(b=>setTimeout(b,l))),s){if(R instanceof Error)throw x(),R;return x(),R}(it=this.logger)==null||it.debug(`"${e}" completed, now running new instance`)}else throw x(),(ot=this.logger)==null||ot.debug(`"${e}" is already running, not starting a new instance`),H(new ne(e));let Me=h.filter(u=>this.isRunning(u));if(Me.length)throw(st=this.logger)==null||st.debug(`"${e}" conflicts with [${Me.join(", ")}]`),x(),H(new ie(e,Me));let Ae=f.filter(u=>this.isRunning(u));Ae.length&&((at=this.logger)==null||at.debug(`"${e}" waiting for [${Ae.join(", ")}]`),p==="throw"?await Promise.all(Ae.map(u=>this.operations.get(u).promise)):await Promise.allSettled(Ae.map(u=>this.operations.get(u).promise)),(lt=this.logger)==null||lt.debug(`"${e}" done waiting for dependencies`),m>0&&((ct=this.logger)==null||ct.debug(`Adding artificial delay of ${m}ms after waitFor for "${e}"`),await new Promise(u=>setTimeout(u,m))));let B=new AbortController,{signal:j}=B;if(E&&(E.aborted?B.abort():(te=()=>{var u;B.abort(),(u=this.logger)==null||u.debug(`"${e}" aborted by external signal`)},E.addEventListener("abort",te,{once:!0}))),S)try{(dt=this.logger)==null||dt.debug(`Executing beforeRun hook for "${e}"`);let u=await S(e,j);if(j.aborted)throw x(),H(new O(e));if(u&&u.skip)return(gt=this.logger)==null||gt.debug(`Operation "${e}" silently skipped by beforeRun hook`),x(),u.value}catch(u){if((ut=this.logger)==null||ut.debug(`beforeRun hook aborted operation "${e}": ${u}`),x(),u instanceof O)throw H(u);let R=new Error(`Operation "${e}" aborted by beforeRun hook: ${u}`);throw R.cause=u,H(R)}let et=(async()=>{var u;try{y>0&&((u=this.logger)==null||u.debug(`Setting timeout of ${y}ms for "${e}"`),_e=setTimeout(()=>{var b;(b=this.logger)==null||b.debug(`"${e}" timed out after ${y}ms`),B.abort("Timeout")},y));let R=t(j,z);return await new Promise((b,v)=>{var Q;(Q=this.logger)==null||Q.debug(`"${e}" operation started`),B.signal.addEventListener("abort",xe=>{var re;(re=this.logger)==null||re.debug(`"${e}" aborted by controller with reason: ${j.reason}`),v(j.reason==="Timeout"?new U(e,y):new O(e))}),R.then(b).catch(xe=>{var re,Tt;j.aborted?((re=this.logger)==null||re.debug(`"${e}" operation aborted`),v(new O(e))):((Tt=this.logger)==null||Tt.debug(`"${e}" operation failed: ${xe}`),v(xe))})})}finally{x()}})();this.operations.set(e,{promise:et,controller:B});try{let u=await et;(ht=this.logger)==null||ht.debug(`"${e}" operation completed successfully`);try{await(_==null?void 0:_(u))}catch(R){(pt=this.logger)==null||pt.error(`onSuccess hook for "${e}" failed`,R)}return u}catch(u){if(u instanceof DOMException&&u.name==="AbortError"||u instanceof O||u instanceof U){let b=u instanceof U?`"${e}" timed out after ${y}ms`:`"${e}" aborted`;if((ft=this.logger)==null||ft.warn(b),(Ee?Ee(u):!0)&&z.getActionCount()>0){(mt=this.logger)==null||mt.debug(`Executing compensations for aborted operation "${e}"`);try{await z.executeAll()}catch(Q){(Et=this.logger)==null||Et.error(`Failed to execute compensations for "${e}"`,Q)}}try{await(A==null?void 0:A())}catch(Q){(_t=this.logger)==null||_t.error(`onAbort hook for "${e}" failed`,Q)}throw H(u)}else{if((At=this.logger)==null||At.error(`Operation "${e}" failed with error:`,u),(Ee?Ee(u):!0)&&z.getActionCount()>0){(It=this.logger)==null||It.debug(`Executing compensations for failed operation "${e}"`);try{await z.executeAll()}catch(v){(yt=this.logger)==null||yt.error(`Failed to execute compensations for "${e}"`,v)}}try{await(T==null?void 0:T(u))}catch(v){(Ct=this.logger)==null||Ct.error(`onError hook for "${e}" failed`,v)}throw H(u)}}finally{z.clear(),this.operations.delete(e)}}isRunning(e){return this.operations.has(e)}getRunningOperations(){return[...this.operations.keys()]}async waitFor(e){let t=this.operations.get(e);t&&await t.promise}async waitForAll(){await Promise.all([...this.operations.values()].map(e=>e.promise))}async waitForMany({operations:e,delay:t=0}){var i;let n=e.filter(s=>this.operations.has(s));if(n.length===0){(i=this.logger)==null||i.debug(`No operations found to wait for: ${e.join(", ")}`);return}await Promise.allSettled(n.map(s=>{var a;return(a=this.operations.get(s))==null?void 0:a.promise})),t>0&&await new Promise(s=>setTimeout(s,t))}abort(e,t="Abort Invoked"){var i,s,a;(i=this.logger)==null||i.debug(`Aborting operation "${e}"`);let n=this.operations.get(e);return n?(n.controller.abort(t),(a=this.logger)==null||a.debug(`Aborted operation "${e}" with reason: ${t}`),!0):((s=this.logger)==null||s.debug(`Operation "${e}" not found`),!1)}abortAll(e="Abort All Invoked"){var n,i;(n=this.logger)==null||n.debug("Aborting all operations");let t=0;for(let[s,a]of this.operations.entries())a.controller.abort(e),t++,(i=this.logger)==null||i.debug(`Aborted operation "${s}"`);return t}};c(w,"OperationRunningError",ne),c(w,"ConflictError",ie),c(w,"OperationAbortedError",O),c(w,"OperationTimeoutError",U);var Be="video-engager-container";function je(r){return(r==null?void 0:r.options)||{}}var ze=!1;function yr(r,e){let n=je(e).containerId||Be,i=document.getElementById(n),s=!1;i||(i=document.createElement("div"),i.id=n,s=!0,ze=!0);let a=i.querySelector("iframe");a&&i.removeChild(a);let l=document.createElement("iframe");l.setAttribute("allow","camera; microphone; autoplay; encrypted-media; fullscreen; picture-in-picture; display-capture"),l.src=r,l.classList.add("video-engager-widget-iframe"),i.appendChild(l),s&&document.body.appendChild(i)}function Cr(r){let t=je(r).containerId||Be,n=document.querySelector(".video-engager-widget-iframe");n&&n.remove();let i=document.getElementById(t);ze&&i&&(i.remove(),ze=!1)}function Tr(r){let t=je(r).containerId||Be,n=document.getElementById(t);return n?n.querySelector(".video-engager-widget-iframe"):null}var Ce={openIframe:yr,closeIframe:Cr,getIframe:Tr};function Lt(){if(document.getElementById("video-engager-widget-styles"))return;let r=document.createElement("style");r.id="video-engager-widget-styles",r.innerHTML=`
        .video-engager-widget-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        #video-engager-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }
    `,document.head.appendChild(r)}function Mt(r){if((!r.domain||typeof r.domain!="string"||r.domain.trim()==="")&&(r.domain="videome.leadsecure.com"),r.domain=Sr(r.domain),r.authMethod||(r.authMethod="generic"),r.options||(r.options={}),"containerId"in r.options&&typeof r.options.containerId!="string")throw new o(o.codes.CONFIG_CONTAINER_ID_INVALID_TYPE);if("uiHandlers"in r.options&&r.options.uiHandlers){let e=["openIframe","closeIframe","getIframe"];for(let t of e)if(!r.options.uiHandlers[t]||typeof r.options.uiHandlers[t]!="function")throw new o(o.codes.UI_HANDLERS_METHOD_REQUIRED,{context:{missingMethod:t}})}return r}function Sr(r){if(typeof r!="string"||r.trim()==="")throw new o(o.codes.CONFIG_DOMAIN_REQUIRED);try{let e=!r.startsWith("http://")&&!r.startsWith("https://");return new URL(e?`https://${r}`:r).host}catch(e){throw new o(o.codes.CONFIG_DOMAIN_INVALID_FORMAT,{originalError:e,context:{providedDomain:r}})}}function de(r){let{OperationRunningError:e,ConflictError:t,OperationAbortedError:n,OperationTimeoutError:i}=w;return o.isVeError(r)?r:r instanceof e?new o(o.codes.OPERATION_ALREADY_RUNNING,{originalError:r,context:{operationName:r.op}}):r instanceof t?new o(o.codes.OPERATION_CONFLICT,{originalError:r,context:{operationName:r.op,conflictingOperations:r.conflicts}}):r instanceof n?new o(o.codes.OPERATION_ABORTED,{originalError:r,context:{operationName:r.op}}):r instanceof i?new o(o.codes.OPERATION_TIMEOUT,{originalError:r,context:{operationName:r.op,timeoutMs:r.ms}}):new o(o.codes.VE_UNHANDLED_ERROR,{originalError:r instanceof Error?r:new Error(xt(r)),context:{message:xt(r)}})}function xt(r){return typeof r=="string"?r:typeof r=="object"&&r!==null&&"message"in r&&typeof r.message=="string"?r.message:typeof r=="object"&&r!==null?JSON.stringify(r):String(r)}var Te=class{constructor(e={}){this.opts=e;c(this,"items",[]);c(this,"log",(e,...t)=>this.push("log",e,t));c(this,"debug",(e,...t)=>this.push("debug",e,t));c(this,"info",(e,...t)=>this.push("info",e,t));c(this,"warn",(e,...t)=>this.push("warn",e,t));c(this,"error",(e,...t)=>this.push("error",e,t))}shouldStore(e){return!this.opts.store||this.opts.store.includes(e)}push(e,t,n){var s;if(!this.shouldStore(e))return;let i=Math.max(1,(s=this.opts.max)!=null?s:500);this.items.push({method:e,data:[t,...n],timestamp:new Date().toISOString()}),this.items.length>i&&this.items.splice(0,this.items.length-i)}clear(){this.items=[]}getItems(){return this.items.slice()}getErrors(){return this.items.filter(e=>e.method==="error")}reportData(){var n;let e={log:0,debug:0,info:0,warn:0,error:0};for(let i of this.items)e[i.method]++;let t=this.getErrors();return{total:this.items.length,counts:e,errors:t,lastError:(n=t.at(-1))!=null?n:null,items:this.getItems()}}};var Se="__VE_WIDGET_LOGGER_V2_GLOBALS__",Nr={};function wr(){return typeof window<"u"?window:typeof globalThis<"u"?globalThis:typeof global<"u"?global:Nr}var Ne=wr();function br(){if(!Ne[Se]){let r=new Te({max:2e3});return Ne[Se]={globalMemory:r},Ne[Se]}return Ne[Se]}var Pt=br();var ge=class r{constructor(e){c(this,"pathStr");c(this,"sep");c(this,"sinks");c(this,"tombstones",0);c(this,"compactThreshold");c(this,"parent");c(this,"children",new Map);var t,n,i,s;this.sep=(t=e==null?void 0:e.separator)!=null?t:"/",this.pathStr=(n=e==null?void 0:e.pathStr)!=null?n:"root",this.sinks=(i=e==null?void 0:e.sinks)!=null?i:[],this.compactThreshold=(s=e==null?void 0:e.compactThreshold)!=null?s:64,this.parent=e==null?void 0:e.parent}getFinalParent(){let e=this;for(;e.parent;)e=e.parent;return e}child(e){let t=this.children.get(e);if(t)return t;let n=this.pathStr==="root"?"":this.pathStr,i=n?`${n}${this.sep}${e}`:e,s=new r({pathStr:i,separator:this.sep,sinks:this.sinks,compactThreshold:this.compactThreshold});return this.children.set(e,s),s}addSink(e){if(typeof e!="object"||e===null)throw new Error("LoggerSink must be an object with log methods");for(let n=0;n<this.sinks.length;n++)if(this.sinks[n]===e)return()=>{};let t=this.sinks.length;return this.sinks.push(e),()=>{this.sinks[t]!==null&&(this.sinks[t]=null,this.tombstones++,this.tombstones>=this.compactThreshold&&this.compact())}}compact(){if(this.tombstones===0)return;let e=[];for(let t=0;t<this.sinks.length;t++){let n=this.sinks[t];n&&e.push(n)}this.sinks.length=0;for(let t=0;t<e.length;t++)this.sinks.push(e[t]);this.tombstones=0}log(...e){this.dispatch("log",e)}debug(...e){this.dispatch("debug",e)}info(...e){this.dispatch("info",e)}warn(...e){this.dispatch("warn",e)}error(...e){this.dispatch("error",e)}dispatch(e,t){var s;let n=this.pathStr,i=this.sinks;for(let a=0;a<i.length;a++){let l=i[a];if(l)try{let h=(s=l[e])!=null?s:l.log;h&&h.apply(l,[n,...t])}catch{}}}destroy(e){if(this.children){if(this.parent=void 0,e!=null&&e.recursive)for(let t of this.children.values())t.destroy({recursive:!0});this.children.clear()}}get methods(){return Ut}static get methods(){return Ut}withContext(){return this}getLevel(){return{NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4}}setLevel(e){}},Ut=["log","debug","info","warn","error"];var Or={log:(r,...e)=>ue(console.log,r,e),debug:(r,...e)=>{var t;return ue((t=console.debug)!=null?t:console.log,r,e)},info:(r,...e)=>{var t;return ue((t=console.info)!=null?t:console.log,r,e)},warn:(r,...e)=>{var t;return ue((t=console.warn)!=null?t:console.log,r,e)},error:(r,...e)=>{var t;return ue((t=console.error)!=null?t:console.log,r,e)}},Rr={log:(r,...e)=>console.log(`[${r}]`,...e),debug:(r,...e)=>console.debug(`[${r}]`,...e),info:(r,...e)=>console.info(`[${r}]`,...e),warn:(r,...e)=>console.warn(`[${r}]`,...e),error:(r,...e)=>console.error(`[${r}]`,...e)},Ye=typeof window<"u"&&typeof window.document<"u"&&typeof window.console<"u",Ft=!Ye&&typeof process<"u"&&!!process.stdout&&(process.stdout.isTTY||process.env.FORCE_COLOR==="1")&&process.env.NO_COLOR!=="1";function Gt(r){let[e,...t]=r.split("/");return{root:e||"root",rest:t.join("/")}}var Ht="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;",$t="padding:0.5px 6px;font-weight:700;",vr="border-top-left-radius:4px;border-bottom-left-radius:4px;",zt="border-top-right-radius:4px;border-bottom-right-radius:4px;",Dr=205,Vt=`${Ht}${$t}${vr}background:hsl(${Dr} 80% 42%);color:#fff;`,Lr=`${Ht}${$t}${zt}background:rgba(0,0,0,.08);color:#111;font-weight:600;`,Mr="\x1B[38;5;75m",xr="\x1B[1m",kt="\x1B[22m",Pr="\x1B[2m",Ur="\x1B[39m";function Vr(r){let{root:e,rest:t}=Gt(r);return t?[`%c[${e}%c%c/${t}]%c`,Vt,"",Lr,""]:[`%c[${e}]%c`,Vt+zt,""]}function kr(r){let{root:e,rest:t}=Gt(r),n=`${Mr}${xr}${e}${kt}${Ur}`,i=t?`${Pr}/${t}${kt}`:"";return[`[${n}${i}]`]}function Fr(){return Ye?Vr:Ft?kr:void 0}var Qe=Fr();function ue(r,e,t){var n;r(...(n=Qe==null?void 0:Qe(e))!=null?n:[`[${e}]`],...t)}function Gr(){if(Ye)try{return window.location.href.includes("debug-format")}catch{return!0}else return Ft}var Bt=Gr()?Or:Rr;function M(r,e={}){var i;if(r instanceof ge){let s=e!=null&&e.component?r.child(e.component):r;return jt(s,e),s}let t={...e};typeof r=="object"&&r&&(t={...t,...r}),typeof r=="boolean"&&(t.debug=r);let n=new ge({pathStr:(i=t.component)!=null?i:"root"});return jt(n,t),n}function jt(r,e){typeof e.debug=="object"&&e.debug!==null?r.addSink(e.debug):typeof e.debug=="boolean"&&e.debug===!0&&r.addSink(Bt),r.addSink(Pt.globalMemory)}var W="__VE_EXTERNAL_SCRIPT_LOADERS__";var we=class{constructor(e){c(this,"config");c(this,"logger");c(this,"iframe",null);c(this,"id",D());c(this,"loadPromise");c(this,"loaded",!1);c(this,"loadFailed",!1);c(this,"_vars");var t;this.config=e,this.logger=M(this.config.logger,{component:(t=this.config.loggerName)!=null?t:"ExternalScriptLoader"}),window[W]||(window[W]={}),window[W][this.id]=this,this.config.loadImmediately&&(this.loadPromise=this.load().catch(n=>{this.logger.error("Error loading scripts immediately:",n)}).finally(()=>{this.loadPromise=void 0}))}insureLoaded(){if(!this.loaded){if(this.loadFailed)throw new Error("Previous load attempt failed");return this.loadPromise?this.loadPromise:(this.loadPromise=this.load(),this.loadPromise)}}get vars(){if(!this._vars)throw new Error("Script not loaded yet");return this._vars}async load(){try{if(this.iframe){this.logger.warn("Script already loaded");return}this.iframe=document.createElement("iframe"),this.iframe.style.display="none";let e=Hr(this);this.iframe.srcdoc=e,await new Promise((n,i)=>{this.iframe.onload=()=>{this.logger.info("Iframe loaded"),n(this.iframe)},this.iframe.onerror=s=>{this.logger.error("Error loading iframe:",s),i(s)},document.body.appendChild(this.iframe)});let t=this.iframe.contentWindow;if(!t)throw new Error("Iframe has no contentWindow");this._vars=this.config.varsGetter(t),this.logger.info("Scripts loaded and variables initialized"),this.loaded=!0}catch(e){throw this.loadFailed=!0,this.logger.error("Error loading scripts:",e),e}}unload(){if(this.iframe){try{document.body.removeChild(this.iframe)}catch(e){this.logger.error("Error removing iframe:",e)}this.iframe=null,this._vars=void 0,this.logger.info("Iframe unloaded"),this.logger.destroy(),delete window[W][this.id]}}};function Hr(r){let e=r.config.scripts.map(t=>`<script ${Object.entries(t).map(([i,s])=>s===!0?i:s===!1||s===void 0?"":`${i}="${s}"`).filter(Boolean).join(" ")}><\/script>`).join(`
`);return`
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Iframe App</title>
    <script>
      const modifiedLogger = window.parent['${W}']['${r.id}'].logger;
      ${JSON.stringify(r.logger.methods)}.forEach(method => {
        const original = modifiedLogger[method].bind(modifiedLogger);
        console[method] = (...args) => {
          original.call(modifiedLogger, ...args);
        };
      });
    <\/script>
  </head>
  <body>
    <div id="root"></div>
    ${e}
    
  </body>
</html>
    `}var $r="__VE_PUSH_CLIENT_MANAGER__",K=Symbol.for($r);var he,pe,$,Oe,Qt,qe=class qe{constructor(e,t){k(this,Oe);c(this,"component");k(this,he,!1);c(this,"eventEmitter",new V);k(this,pe);k(this,$,new Set);this.component=t,Ue(this,pe,e),Y(this,Oe,Qt).call(this)}get pushClientManager(){return P(this,pe)}static createSubscribedInstance(e,t){return new qe(e,t)}get state(){return this.pushClientManager.state}get client(){return this.pushClientManager.client}async cleanup(){if(!P(this,he)){Ue(this,he,!0);for(let e of P(this,$))e(),P(this,$).delete(e);P(this,$).clear(),this.eventEmitter&&await this.eventEmitter.shutdown().catch(e=>{console.error("[PushSubscribedInstance] Error shutting down event emitter:",e)})}}async destroy(){await this.cleanup().catch(e=>{console.error("[PushSubscribedInstance] Error during cleanup:",e)}),this.pushClientManager.removeSubscriber(this)}get checkIfSessionIdIsMine(){return this.pushClientManager.checkIfSessionIdIsMine.bind(this.pushClientManager)}get waitForConnected(){return this.pushClientManager.waitForConnected.bind(this.pushClientManager)}};he=new WeakMap,pe=new WeakMap,$=new WeakMap,Oe=new WeakSet,Qt=function(){P(this,$).add(this.pushClientManager.eventEmitter.on("*",(e,t)=>{this.eventEmitter.emit(e,t)}))};var be=qe;var fe,We,me,ve,Yt,Z=class Z{constructor(e){k(this,ve);c(this,"eventEmitter",new V);c(this,"_state",{connected:!1,sessionId:null,inCallsQueue:!1});c(this,"MAX_CACHED_SESSION_IDS",1e3);c(this,"_destroyed",!1);c(this,"_logger");c(this,"_client");c(this,"subscribedInstances",new Set);k(this,me,e=>{switch(e){case"Connected":this.getCurrentPushSessionId();break;case"Disconnected":case"SessionClosed":case"Expired":this.setState("connected",!1),this.setState("sessionId",null);break;default:break}});c(this,"cachedSessionIds",new Set);if(this._logger=M(e.logger,{component:"PushClientManager"}),!(e!=null&&e.pushClient))throw new Error("PushClient instance is required");this._client=e==null?void 0:e.pushClient,this.registerListeners(),this._client[K]=this}static createSubscriber(e){var n;return Y(n=Z,fe,We).call(n,e).addSubscriber(e.component)}static initialize(e){var t;return Y(t=Z,fe,We).call(t,e)}get client(){return this._client}get state(){return this._state}get destroyed(){return this._destroyed}async getTimeTableData(){return typeof this.state.timetable>"u"&&await this.eventEmitter.waitFor("state:timetable",3e4,e=>typeof e<"u").promise,this.state.timetable}async leaveCallsQueue(){let e=await this.getTimeTableData();if(e!=="on"&&e!=="disabled")throw new Error('Cannot listen for calls, timetable is not set to "on" or "disabled"');if(!this.state.inCallsQueue)throw new Error("Cannot leave calls queue, already not in queue");return new Promise((t,n)=>{this._client.switch.leave({callTypes:["chat","video","screen"]},(i,s)=>{if(i)return n(i);this.setState("inCallsQueue",!1),t(s)})})}joinCallsQueue(e=!1){let t=this.state.timetable;if(t!=="on"&&t!=="disabled")throw new Error('Cannot listen for calls, timetable is not set to "on" or "disabled"');if(this.state.inCallsQueue&&!e)throw new Error("Already in calls queue");let n,i,s,a;if(this._client.switch.join({callTypes:["chat","video","screen"]},(l,h)=>{if(l&&(a=l,i))return i(l||!0);this.setState("inCallsQueue",!0),s=h,n&&n(h||!0)}),s)return s;if(a)throw a;return new Promise((l,h)=>{n=l,i=h})}registerSomeStuff(){let e=!1;this.eventEmitter.on("state:connected",a=>{a||(this.state.inCallsQueue&&(e=!0),this.setState("inCallsQueue",!1))});let t=a=>{var h;this._logger.log("[setCallInfoCallbacks]: Set called with args:",a);let l=["chat","video","screen"];typeof((h=a==null?void 0:a.groups)==null?void 0:h.floor)=="object"&&l.filter(f=>typeof a.groups.floor[f]=="number"&&a.groups.floor[f]>0).length>0?this.joinCallsQueue(!0):this._logger.log("[setCallInfoCallbacks]: Empty calls queue detected")},n=a=>{var l,h,f;this._logger.log("[setCallInfoCallbacks]: Update called with args:",a),(f=(h=(l=a==null?void 0:a.mrg)==null?void 0:l.self)==null?void 0:h.set)!=null&&f.timetable&&(this.setState("timetable",a.mrg.self.set.timetable),e&&this.joinCallsQueue(!0))},i=(...a)=>{this._logger.error("[setCallInfoCallbacks]: Error called with args:",...a)};this._client.setCallInfoCallbacks(t,n,i);let s=(a,l)=>{this._logger.log("User info updated:",a,l),a==="timetable"&&this.setState("timetable",l)};this._client.onUserInfo(s)}async connect(e){let t=this.eventEmitter.waitFor("state:connected",3e4,n=>n===!0);try{this.registerSomeStuff(),this._client.connect(e),await t.promise}catch(n){throw new Error(`PushClient connect failed: ${n.message||"Unknown error"} `)}await new Promise(n=>setTimeout(n,100))}async disconnect(){if(this._destroyed){this._logger.warn("Instance already destroyed");return}try{this._client.disconnect()}catch(e){this._logger.error("Error during disconnect:",e)}}async destroy(){if(this._destroyed){this._logger.warn("Instance already destroyed");return}return await Y(this,ve,Yt).call(this)}checkIfSessionIdIsMine(e){return this._destroyed?!1:this.cachedSessionIds.has(e)}async waitForConnected(e=15e3){return this._destroyed?Promise.reject(new Error("PushClientManager instance is destroyed")):this.state.connected?Promise.resolve():this.eventEmitter.waitFor("state:connected",e,t=>t===!0).promise}setState(e,t){this._state[e]!==t&&(this._state[e]=t,this._logger.debug(`State change: ${e} =`,t),this.eventEmitter.emit(`state:${e}`,t))}addMySessionIdToCache(e){if(this.cachedSessionIds.add(e),this.cachedSessionIds.size>this.MAX_CACHED_SESSION_IDS){let t=this.cachedSessionIds.values().next().value;t&&this.cachedSessionIds.delete(t)}}getCurrentPushSessionId(){try{let e=this._client.getSessionId();return!e||e==="NO-SESSION"?(e=null,this.setState("sessionId",null),this.setState("connected",!1)):(this.setState("sessionId",e),this.setState("connected",!0),this.addMySessionIdToCache(e)),e}catch(e){return this._logger.error("Error getting session ID:",e),this.setState("sessionId",null),this.setState("connected",!1),null}}registerListeners(){this.getCurrentPushSessionId(),this._client.on("*",P(this,me))}addSubscriber(e){if(this._destroyed)throw new Error("Cannot add subscriber: PushClientManager is destroyed");let t=be.createSubscribedInstance(this,e);return this.subscribedInstances.add(t),this._logger.debug(`Subscriber ${e?`(${e})`:""} added. Total subscribers:`,this.subscribedInstances.size),t}removeSubscriber(e){this.subscribedInstances.has(e)?(this.subscribedInstances.delete(e),this._logger.debug(`Subscriber ${e.component?`(${e.component})`:""} removed. Total subscribers:`,this.subscribedInstances.size)):this._logger.warn(`Attempted to remove non-registered subscriber ${e.component?`(${e.component})`:""}`)}};fe=new WeakSet,We=function(e){if(!(e!=null&&e.pushClient))throw new Error("PushClient instance is required");let t=e.pushClient[K];return(!t||t.destroyed)&&(t=new Z({logger:e.logger,pushClient:e.pushClient})),t},me=new WeakMap,ve=new WeakSet,Yt=async function(){var t,n;if(this._destroyed)return;this._logger.debug("Cleaning up PushClientManager instance."),this._destroyed=!0;let e=Array.from(this.subscribedInstances);this.subscribedInstances.clear(),this._client&&this._client[K]&&(this._client[K]=void 0,delete this._client[K]);try{(n=(t=this._client)==null?void 0:t.off)==null||n.call(t,"*",P(this,me))}catch(i){this._logger.error("Error removing event handler:",i)}for(let i of e)await i.cleanup().catch(s=>{this._logger.error("Error cleaning up subscribed instance:",s)});await this.eventEmitter.shutdown(),this.cachedSessionIds.clear(),this._logger.debug("Cleanup complete."),this._logger.destroy()},k(Z,fe);var Re=Z;async function Ke(r){let e=Br(r.domain),t=zr(e,r.pushClientLocation||"/static/widgets/push.bundle.v3.js"),n=new we({scripts:[{src:t,crossOrigin:"anonymous"}],varsGetter:a=>{if(!a.push)throw new Error("PushClient script did not load correctly.");return{push:a.push}},logger:r.logger,loggerName:"PushClient",loadImmediately:!0});await n.insureLoaded();let i=n.vars.push;if(!i)throw new Error("PushClient script did not load correctly.");return{pushClientManager:Re.initialize({pushClient:i.create(),logger:r.logger}),scriptLoader:n}}function zr(r,e){try{return new URL(e,r).toString()}catch(t){throw new Error("Invalid path provided for PushClientManager."+t.message)}}function Br(r){try{if(!r||typeof r!="string")throw new Error("Invalid domain provided for PushClientManager.");return r.startsWith("http://")||r.startsWith("https://")?new URL(r).origin:new URL(`https://${r}`).origin}catch(e){throw new Error("Invalid domain provided for PushClientManager."+e.message)}}var De=class{constructor(e){c(this,"eventEmitter");c(this,"promiseManager");c(this,"logger");c(this,"callbacks");c(this,"agentAuthenticate");c(this,"pushClientManager");c(this,"scriptLoader");c(this,"handlerErrors",e=>{let t=de(e);return this.logger.error("Error in VideoEngagerAgent operation:",t.toJSON()),t});c(this,"calls",new Map);this.logger=M(e.logger,{component:"CallNotificationManager"}),this.promiseManager=new w(this.logger.child("PromiseManager")),this.callbacks=e.callbacks,this.agentAuthenticate=e.agentAuthenticate,this.eventEmitter=e.eventEmitter||new V,this.logger.log("instance created")}get isOnQueue(){var e,t;return((t=(e=this.pushClientManager)==null?void 0:e.state)==null?void 0:t.inCallsQueue)||!1}get isOnline(){var e,t;return((t=(e=this.pushClientManager)==null?void 0:e.state)==null?void 0:t.connected)||!1}initialize(){return this.promiseManager.run("initialize",async()=>{await this.agentAuthenticate.waitForInitialization(),await this.initializeCallsNotifications()},{conflictsWith:["initialize"],transformError:this.handlerErrors})}async initializeCallsNotifications(){let{pushClientManager:e,scriptLoader:t}=await Ke({domain:this.agentAuthenticate.veDomain.origin,logger:this.logger});this.pushClientManager=e,this.scriptLoader=t,this.registerPushNotificationEvents(),this.pushClientManager.connect({url:this.agentAuthenticate.signallingUrl,tenantId:this.agentAuthenticate.brokerageData.tennantId,token:this.agentAuthenticate.token,userId:this.agentAuthenticate.brokerageData._account.email})}switchQueue(){return this.promiseManager.run("switchQueue",async()=>this.isOnQueue?this.pushClientManager.leaveCallsQueue():this.pushClientManager.joinCallsQueue(),{conflictsWith:["switchQueue"],transformError:this.handlerErrors})}async acceptCall(e){return this.promiseManager.run("acceptCall",async()=>{let t={...this.calls.get(e)};if(!t||!t.calls||Object.keys(t.calls).length===0)throw this.logger.error("No call info found for callId",e),new o(o.codes.SESSION_NOT_FOUND,{context:{visitorId:e,reason:"The visitor have left"}});this.logger.log("Accepting call for callId",e,t,this,this.eventEmitter);let n=this.eventEmitter.waitFor("callStateUpdated",12e4,a=>a.status==="PRE_CALL","resolve"),i=this.eventEmitter.waitForAny(["sessionFailed","acceptedElsewhere","partyLeft"],3e4,({event:a,payload:l})=>a==="acceptedElsewhere"?t.caller.id===l.visitorId:a==="partyLeft"&&l===e?!0:a==="sessionFailed","resolve");await this.callbacks.call({customerId:t.caller.id});let s=await i.promise;if(!s||!s.event||!s.payload)throw this.logger.error("No response received after accepting call for callId",e),n.cancel(),new o(o.codes.SESSION_FAILED_TO_START,{context:{visitorId:e,reason:"The call did not start within the expected time frame"}});if(s.event==="partyLeft")throw this.logger.error("Visitor left before call could be established for callId",e),new o(o.codes.VISITOR_HAS_LEFT_SESSION,{context:{visitorId:e,reason:"The visitor have left"}});if(this.logger.log("Call accepted response",s),s.event==="sessionFailed"){n.cancel(),this.logger.error("Call session failed after accepting call for callId",e,s);let a=t.calls||{};for(let l in a)a[l].sendCustomEvent("DismissMeeting",{data:"Caller Name"}),a[l].hangup("DismissMeeting");throw new o(o.codes.CALL_ALREADY_FINISHED,{context:{visitorId:e,reason:"The call have already finished, Nextjs failed to find the interaction"}})}if(!s.payload.acceptedByMyOtherDevice)throw n.cancel(),this.logger.error("Call was accepted by another agent",s),new o(o.codes.SESSION_ACCEPTED_BY_ANOTHER_AGENT,{context:{reason:"Accepted By Other Agent"}});if(await n.promise,this.callbacks.getCallState().status!=="CALL_STARTED"&&await this.eventEmitter.waitFor("callStateUpdated",1e4,a=>a.status==="CALL_STARTED","resolve").promise.catch(()=>{}),this.callbacks.getCallState().status!=="CALL_STARTED")throw this.logger.error("Call did not start properly after accepting call for callId",e,this.callbacks.getCallState()),new o(o.codes.SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE,{context:{visitorId:e,reason:"Picked somewhere else by you"}})},{waitFor:["initialize"],conflictsWith:["acceptCall","rejectCall"],transformError:this.handlerErrors})}async rejectCall(e){return this.promiseManager.run("rejectCall",async()=>{let t={...this.calls.get(e)};if(!t||!t.calls||Object.keys(t.calls).length===0)throw this.logger.error("No call info found for callId",e),new o(o.codes.VISITOR_HAS_LEFT_SESSION,{context:{visitorId:e,reason:"The visitor have left"}});this.logger.info("Rejecting call for callId",e,t);let n=t.calls||{};for(let i in n)n[i].hangup("RejectedByAgent")},{waitFor:["initialize"],conflictsWith:["acceptCall","rejectCall"],transformError:this.handlerErrors})}async registerPushNotificationEvents(){this.pushClientManager.eventEmitter.on("state:inCallsQueue",e=>{this.logger.info(`PushClientManager state changed: inCallsQueue = ${e}`),this.eventEmitter.emit("inCallsQueue",e)}),this.pushClientManager.eventEmitter.on("state:connected",e=>{this.logger.info(`PushClientManager state changed: connected = ${e}`),this.eventEmitter.emit("isOnline",e)}),this.pushClientManager.client.call.service.onIncomingCall((e,t,n)=>{var l;if(!e||!t){this.logger.error("Invalid callControl or callerInfo received in incoming call");return}if(typeof(n==null?void 0:n.from)!="object"||!("id"in n.from&&typeof n.from.id=="string")||!("type"in n.from&&typeof n.from.type=="string")){this.logger.error("Invalid callerInfo structure received in incoming call",{callerInfo:t,context:n});return}if(n.from.type!=="visitor"){this.logger.warn("Incoming call from non-visitor type is ignored",{callerInfo:t,context:n});return}this.logger.info("Incoming call received",e,t,n);let i=e.getId(),s=((l=this.calls.get(n.from.id))==null?void 0:l.calls)||{};s[i]=e;let a={calls:s,caller:n.from,context:n,displayName:jr(t==null?void 0:t.name)};e.on("AcceptedElsewhere",async h=>{this.logger.log("Call accepted elsewhere, removing call locally",h),this.eventEmitter.emit("acceptedElsewhere",{callId:i,visitorId:a.caller.id,acceptedByUser:h.userId,acceptedByMyOtherDevice:h.deviceId}),await new Promise(f=>setTimeout(f,100)),this.removeCall(i,a.caller.id)}),e.on("CallFailed",h=>{this.logger.log("Call failed with reason",h),this.removeCall(i,a.caller.id)}),e.on("CallEnded",()=>{this.logger.log("Call ended by remote"),this.removeCall(i,a.caller.id)}),this.calls.set(a.caller.id,a),this.eventEmitter.emit("incomingCall",a)})}removeCall(e,t){let n=this.calls.get(t);if(!n){this.logger.error("No call info found for visitorId",t),this.eventEmitter.emit("callRemoved",e);return}delete n.calls[e],Object.keys(n.calls).length>0?this.calls.set(t,n):(this.calls.delete(t),this.eventEmitter.emit("partyLeft",t)),this.eventEmitter.emit("callRemoved",e)}get currentReceivedCalls(){return Array.from(this.calls.values())}async destroyInstance(){var e,t,n,i,s,a;(e=this.pushClientManager)==null||e.disconnect(),await((t=this.pushClientManager)==null?void 0:t.destroy()),await((n=this.scriptLoader)==null?void 0:n.unload()),(i=this.promiseManager)==null||i.abortAll("destroyInstance called"),await((s=this.eventEmitter)==null?void 0:s.shutdown()),(a=this.logger)==null||a.destroy({recursive:!0})}};function jr(r){let e=r==null?void 0:r.replaceAll("+"," ").trim();return e||"Visitor"}async function J(r,e={}){let t=await fetch(r,{method:(e==null?void 0:e.method)||"GET",headers:{Accept:"application/json",...(e==null?void 0:e.headers)||{}},body:e==null?void 0:e.body});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}async function qt(r,e){Qr(e);let t=`${r}/api/partners/impersonateCreate`,{token:n}=await J(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n)throw new Error("Impersonation failed: no token");return n}function Qr(r){let e=["pak","email","division"];for(let t of e)if(!r[t])throw new Error(`ImpersonateCreateBody validation failed: missing required field '${t}'`)}async function Ze(r,e,t,n){if(!r)throw new Error("No signalling data");let i=`${r}/api/signalling/endpoint/${e}/${t}`,s=await J(i),a=new URL(n);return a.searchParams.set("signallingId",s.signallingId),a.toString()}async function Je(r,e){let t=`${r}/api/brokerages/users/me`;return J(t,{headers:{Authorization:`Bearer ${e}`}})}var Po=Object.freeze({token:"token",generic:"generic"}),Le=class{constructor(e){c(this,"configs");c(this,"logger");c(this,"promiseManager");c(this,"initialized",!1);c(this,"_brokerageData");c(this,"_signallingUrl");c(this,"_token");c(this,"_veDomain");this.configs=e.configs,this.logger=M(e.logger,{component:"AgentAuthentication"}),this.promiseManager=new w(this.logger.child("PromiseManager")),this.initialize().catch(t=>{this.logger.error("Error during initialization: "+String(t))})}async waitForInitialization(){if(await this.promiseManager.waitFor("initialize"),!this.initialized)throw new o(o.codes.AGENT_NOT_AUTHENTICATED)}async initialize(){return this.promiseManager.run("initialize",async()=>{let{token:e,signallingUrl:t,brokerageData:n,veDomain:i}=await this.authenticate();this._token=e,this._signallingUrl=t,this._brokerageData=n,this._veDomain=i,this.initialized=!0},{conflictsWith:["initialize"]})}async authenticate(){return Yr[this.configs.authMethod](this.configs)}getDisplayName(){if(!this.brokerageData)throw new o(o.codes.AGENT_NOT_AUTHENTICATED);let e=`${this.brokerageData.firstName||""} ${this.brokerageData.lastName||""}`.trim();return e||(e=this.brokerageData.contactEmail||this.brokerageData._account.contactEmail||this.brokerageData.email.replaceAll(this.brokerageData.organizationId||this.brokerageData._account.organizationId||"","")),e}get brokerageData(){if(!this._brokerageData)throw new o(o.codes.AGENT_NOT_AUTHENTICATED);return this._brokerageData}get signallingUrl(){if(!this._signallingUrl)throw new o(o.codes.AGENT_NOT_AUTHENTICATED);return this._signallingUrl}get token(){if(!this._token)throw new o(o.codes.AGENT_NOT_AUTHENTICATED);return this._token}get veDomain(){if(!this._veDomain)throw new o(o.codes.AGENT_NOT_AUTHENTICATED);return this._veDomain}destroy(){this.promiseManager.abortAll(),this.logger.destroy({recursive:!0})}},Yr={generic:qr,token:Wr};async function qr(r){let e=new URL(`https://${r.domain}`),t=await qt(e.origin,{pak:r.apiKey,division:r.externalId,email:`${r.organizationId||""}${r.agentEmail}`,organizationId:r.organizationId,firstName:r.firstName,lastName:r.lastName,contactEmail:r.contactEmail}),n=await Je(e.origin,t),i=await Ze(e.origin,n.tennantId,"null",n.signalling.endPoint);return{token:t,signallingUrl:i,brokerageData:n,veDomain:e}}async function Wr(r){let e=new URL(`https://${r.domain}`),t=await Je(e.origin,r.token),n=await Ze(e.origin,t.tennantId,"null",t.signalling.endPoint);return{token:r.token,signallingUrl:n,brokerageData:t,veDomain:e}}function Xe(r){return r&&typeof r.then=="function"&&typeof r.catch=="function"}var g=class g{constructor(){c(this,"logger");c(this,"eventEmitter",new V);c(this,"authParameters");c(this,"promiseManager");c(this,"PromiseManager",w);c(this,"configs");c(this,"_isInitialized",!1);c(this,"cleanups",[]);c(this,"callState",this.defaultCallState);c(this,"handlerErrors",e=>{let t=de(e);return this.logger.error("Error in VideoEngagerAgent operation:",t.toJSON()),t});c(this,"_isIframeOpened",!1);c(this,"onCloseHandler",async()=>{let e=await this.handlersUiFromConfigs.getIframe(this.configs);this.setIsIframeOpened(e||null)});c(this,"uiHandlers",{openIframe:(e,t)=>{let n=this.handlersUiFromConfigs.openIframe(e,t);return Xe(n)?n.then(i=>(this.onCloseHandler(),i)):(this.onCloseHandler(),n)},closeIframe:e=>{let t=this.handlersUiFromConfigs.closeIframe(e);return Xe(t)?t.then(()=>{this.setIsIframeOpened(null)}):(this.setIsIframeOpened(null),t)},getIframe:e=>{let t=this.handlersUiFromConfigs.getIframe(e);return t&&typeof t.then=="function"?t.then(n=>(this.setIsIframeOpened(n||null),n)):(this.setIsIframeOpened(t||null),t)}});c(this,"_callsNotificationsManager");c(this,"_agentDetails");c(this,"on",this.eventEmitter.on.bind(this.eventEmitter));c(this,"off",this.eventEmitter.off.bind(this.eventEmitter));this.logger=M({component:"VideoEngagerAgent"}),this.promiseManager=new w(this.logger.child("PromiseManager")),this.logger.info("VideoEngagerAgent loaded")}get defaultCallState(){return{status:"NONE",callerEmail:"",email:"",tennant_id:"",visitorId:"",pin:"",shortUrl:"",attributes:{},inActiveSession:!1}}get currentCallState(){return this.callState}getCurrentCallState(){return this.callState}static getCurrentCallState(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.getCurrentCallState()}static getInstance(){return g._instance||(g._instance=new g),g._instance}static async init(e){return X&&await X.catch(t=>{}),g._instance||(g._instance=new g),await g._instance.initialize(e)}isStandaloneMode(e){if(!e)throw new o(o.codes.AGENT_NOT_INITIALIZED);return"standaloneMode"in e?e.standaloneMode===!0:!1}async initialize(e){if(this._isInitialized)throw new o(o.codes.AGENT_ALREADY_INITIALIZED);return e.logger&&(this.logger=M(this.logger,{debug:e.logger})),await this.promiseManager.run("initialize",async()=>{var s,a;this.configs=Mt(e);let t=!!this.configs.authMethod&&this.configs.authMethod in $e&&$e[this.configs.authMethod];if(!t)throw new o(o.codes.AUTH_METHOD_NOT_SUPPORTED,{context:{authMethod:this.configs.authMethod}});let n=new t(this.configs);this.authParameters=await n.authenticate();let i=await this.initializeStandaloneModules();i&&(this.authParameters={...this.authParameters,...i},delete this.authParameters.email,delete this.authParameters.environment,delete this.authParameters.pak),!("uiHandlers"in(this.configs.options||{}))&&!((s=this.configs.options)!=null&&s.containerId)&&Lt(),this.setUiHandler(((a=this.configs.options)==null?void 0:a.uiHandlers)||Ce),this.registerSmartVideoEvents(),this._isInitialized=!0},{waitIfRunning:!1,transformError:this.handlerErrors})}registerSmartVideoEvents(){let e=t=>{var n;t.origin===`https://${this.configs.domain}`&&(this.logger.info("Received message from VideoEngager widget: ",t.data),(n=t.data)!=null&&n.status&&this.handleStatusEvent(t.data))};window.addEventListener("message",e),this.logger.info("Registered message event listener for VideoEngager widget"),this.cleanups.push(()=>{this.logger.info("Removing message event listener"),window.removeEventListener("message",e)})}updateCallState(e,t=!0){let n=e.attributes||{},i={...this.callState.attributes,...n};this.callState={...this.callState,...e,attributes:i},this.logger.info(`Call state updated: ${JSON.stringify(this.callState)}`),t&&this.eventEmitter.emit("callStateUpdated",{...this.callState})}async handleStatusEvent(e){return this.promiseManager.run("handleStatusEvent",async()=>{if(!e||!e.status){this.logger.debug("Received empty payload for status event");return}this.logger.info(`Handling status event: ${e.status}`);let t=this.callState.visitorId,n=this.callState.status,i=!1;switch(e.status){case"PRE_CALL":this.updateCallState(e,!1),t!==e.visitorId&&(this.callState.inActiveSession=!0,this.eventEmitter.emit("sessionStarted",{...this.callState})),i=!0;break;case"CALL_STARTED":this.updateCallState(e);break;case"END_CALL":if(n!=="CALL_STARTED"){this.logger.warn("Call not started yet, ignoring END_CALL event");return}this.updateCallState(e);break;case"FINISHED":if(n==="FINISHED"){this.logger.debug("Call already finished, ignoring duplicate FINISHED event");return}if(n==="NONE"){this.logger.warn("Call Never Started, this indicates a failure to start the call, ignoring FINISHED event"),this.eventEmitter.emit("sessionFailed",e);return}this.callState.inActiveSession=!0,this.updateCallState(e,!1),this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState}),await new Promise(s=>setTimeout(s,10)),this.logger.info("Resetting call state after session finished"),this.callState=this.defaultCallState;break;default:this.logger.warn(`Unhandled status event: ${e.status}`);break}i&&this.eventEmitter.emit("callStateUpdated",{...this.callState})},{waitIfRunning:!0})}setIsIframeOpened(e){var n;let t=!!e;this._isIframeOpened!==t&&(this._isIframeOpened=t,(n=this.eventEmitter)==null||n.emit("iframeStateChanged",t))}isIframeOpened(){return this._isIframeOpened}setUiHandler(e=Ce){let t=["openIframe","closeIframe","getIframe"];for(let n of t)if(!e[n]||typeof e[n]!="function")throw new o(o.codes.UI_HANDLERS_METHOD_REQUIRED,{context:{missingMethod:n}});this.configs.options||(this.configs.options={}),this.configs.options.uiHandlers=e}get handlersUiFromConfigs(){return(this.configs.options||{}).uiHandlers||Ce}async call(e){return await this.promiseManager.run("call",async()=>{if(!this._isInitialized||!this.authParameters)throw new o(o.codes.AGENT_NOT_AUTHENTICATED);this.logger.info("Calling VideoEngagerAgent with auth parameters:");let t={...this.authParameters,enablePostMessage:"true",authPopup:"true"},n=e==null?void 0:e.customerId;if(n&&typeof n!="string")throw new o(o.codes.PARAM_CUSTOMER_ID_INVALID_TYPE);n&&(t.veinteraction=n);let i=new URLSearchParams(t),s=`https://${this.configs.domain}/nextjs/single/smartvideo/?${i.toString()}`;await this.uiHandlers.openIframe(s,this.configs),this.logger.info("VideoEngagerAgent call completed. Widget is ready.")},{waitFor:["initialize"],conflictsWith:["endCall"],waitIfRunning:!1,transformError:this.handlerErrors})}async endCall(){return await this.promiseManager.run("endCall",async()=>{if(!this.callState.inActiveSession&&!this.isIframeOpened())throw this.logger.warn("No active session to end"),new o(o.codes.CALL_NOT_STARTED);this.logger.info("Ending call"),await this.uiHandlers.closeIframe(this.configs),this.logger.info("closed iframe"),this.callState.inActiveSession&&(this.callState.status=Dt.FINISHED,this.callState.inActiveSession=!1,this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState})),this.logger.info("Call ended and iframe closed"),this.callState=this.defaultCallState},{waitFor:["initialize","call"],waitIfRunning:!1,waitForDelayMs:500,transformError:this.handlerErrors})}get callsNotificationsManager(){if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);if(!this._callsNotificationsManager)throw new o(o.codes.AGENT_NOT_INITIALIZED);return this._callsNotificationsManager}get agentDetails(){if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);if(!this._agentDetails)throw new o(o.codes.AGENT_NOT_INITIALIZED);return this._agentDetails}async initializeStandaloneModules(){if(!this.isStandaloneMode(this.configs)){this.logger.info("Standalone mode not enabled, skipping standalone modules initialization");return}let e=this.configs.authMethod==="generic"?{agentEmail:this.configs.agentEmail,apiKey:this.configs.apiKey,domain:this.configs.domain,authMethod:this.configs.authMethod,organizationId:this.configs.organizationId,standaloneMode:!0,externalId:this.configs.externalId,firstName:this.configs.firstName,lastName:this.configs.lastName,contactEmail:this.configs.contactEmail}:{authMethod:this.configs.authMethod,token:this.configs.token,domain:this.configs.domain,standaloneMode:!0};return this._agentDetails=new Le({configs:e,logger:this.logger}),this._callsNotificationsManager=new De({agentAuthenticate:this._agentDetails,logger:this.logger,callbacks:{call:this.call.bind(this),getCallState:()=>this.callState},eventEmitter:this.eventEmitter}),await this._callsNotificationsManager.initialize(),{token:this._agentDetails.token}}getReceivedCalls(){if(!this.isInitialized())throw new o(o.codes.AGENT_NOT_INITIALIZED);if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.callsNotificationsManager.currentReceivedCalls}switchQueue(){if(!this.isInitialized())throw new o(o.codes.AGENT_NOT_INITIALIZED);if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.callsNotificationsManager.switchQueue()}isOnQueue(){return this.isInitialized()?this.isStandaloneMode(this.configs)?this.callsNotificationsManager.isOnQueue:(this.logger.warn("Agent not in standalone mode when checking queue status"),!1):(this.logger.warn("Agent not initialized when checking queue status"),!1)}isOnline(){return this.isInitialized()?this.isStandaloneMode(this.configs)?this.callsNotificationsManager.isOnline:(this.logger.warn("Agent not in standalone mode when checking online status"),!1):(this.logger.warn("Agent not initialized when checking online status"),!1)}async acceptCall(e){if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);if(this.isIframeOpened()||this.callState.inActiveSession)throw this.logger.warn("Cannot accept call while another call is active"),new o(o.codes.SESSION_ALREADY_ACTIVE,{context:{visitorId:e,reason:"Another call is active"}});try{await this.callsNotificationsManager.acceptCall(e)}catch(t){throw this.logger.error("Error accepting call:",t),this.isIframeOpened()&&await this.endCall().catch(()=>{}),t}}async rejectCall(e){if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.callsNotificationsManager.rejectCall(e)}getDisplayName(){if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.agentDetails.getDisplayName()}agentSettings(){if(!this.isStandaloneMode(this.configs))throw new o(o.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.agentDetails.brokerageData}async cleanup(){var e,t,n,i,s,a,l,h,f,m,y,E,S,_;this.logger.info("Cleaning up VideoEngagerAgent resources");try{(e=this.callState)!=null&&e.inActiveSession&&await this.endCall()}catch(A){(t=this.logger)==null||t.warn("Error closing iframe during cleanup:"+String(A))}this.cleanups.forEach(A=>{var T;try{A()}catch(p){(T=this.logger)==null||T.warn("Error during cleanup:"+String(p))}}),this.cleanups.length=0,await((n=this.promiseManager)==null?void 0:n.waitFor("handleStatusEvent")),await((i=this.eventEmitter)==null?void 0:i.emit("cleanup",void 0,{awaitListeners:!0}).catch(A=>{this.logger.warn("Error emitting cleanup event:"+String(A))})),(s=this.logger)==null||s.info("Emitted cleanup event to listeners");try{await((a=this.eventEmitter)==null?void 0:a.shutdown(1e3))}catch(A){(l=this.logger)==null||l.warn("Error during event emitter shutdown:"+String(A))}(h=this.promiseManager)==null||h.abortAll("cleanup"),await((f=this._callsNotificationsManager)==null?void 0:f.destroyInstance().catch(()=>{}));try{await((m=this._agentDetails)==null?void 0:m.destroy())}catch(A){(y=this.logger)==null||y.warn("Error destroying agent details:"+String(A))}(E=this.logger)==null||E.info("Destroyed standalone modules"),this.callState=this.defaultCallState,this._isInitialized=!1,this.authParameters=void 0,this.promiseManager=void 0,this.eventEmitter=void 0,(S=this.logger)==null||S.info("VideoEngagerAgent cleanup completed"),(_=this.logger)==null||_.destroy({recursive:!0}),this.logger=void 0,this.configs=void 0}isInitialized(){return this._isInitialized}static call(...e){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.call.bind(g._instance)(...e)}static endCall(...e){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.endCall.bind(g._instance)(...e)}static isInitialized(){return g._instance!==null&&g._instance.isInitialized()}static isIframeOpened(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.isIframeOpened()}static acceptCall(...e){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.acceptCall.bind(g._instance)(...e)}static rejectCall(...e){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.rejectCall.bind(g._instance)(...e)}static getDisplayName(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.getDisplayName()}static agentSettings(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.agentSettings()}static setUiHandler(...e){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.setUiHandler.bind(g._instance)(...e)}static getReceivedCalls(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.getReceivedCalls()}static switchQueue(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.switchQueue()}static isOnQueue(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.isOnQueue()}static isOnline(){if(!g._instance)throw new o(o.codes.AGENT_NOT_INITIALIZED);return g._instance.isOnline()}static async destroy(){if(X)throw new o(o.codes.OPERATION_ALREADY_RUNNING,{context:{operationName:"destroy"}});if(g._instance)try{X=g._instance.cleanup(),await X}finally{X=null,g._instance=null}}};c(g,"VERSION",q),c(g,"_instance",null),c(g,"on",((...e)=>g.getInstance().on.bind(g.getInstance())(...e))),c(g,"off",((...e)=>g.getInstance().off.bind(g.getInstance())(...e)));var I=g,X=null,Kr=I.init,Zr=I.getInstance,Jr=I.isInitialized,Xr=I.destroy,en=I.call,tn=I.endCall,rn=I.on,nn=I.off,on=I.isIframeOpened,sn=I.acceptCall,an=I.rejectCall,ln=I.getDisplayName,cn=I.agentSettings,dn=I.setUiHandler,gn=I.getCurrentCallState,un=I.getReceivedCalls,hn=I.switchQueue,pn=I.isOnQueue,fn=I.isOnline,mn=I;
