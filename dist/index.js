"use strict";var be=Object.defineProperty;var Wt=Object.getOwnPropertyDescriptor;var Kt=Object.getOwnPropertyNames;var Zt=Object.prototype.hasOwnProperty;var Ot=n=>{throw TypeError(n)};var Jt=(n,e,t)=>e in n?be(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Xt=(n,e)=>{for(var t in e)be(n,t,{get:e[t],enumerable:!0})},en=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Kt(e))!Zt.call(n,i)&&i!==t&&be(n,i,{get:()=>e[i],enumerable:!(r=Wt(e,i))||r.enumerable});return n};var tn=n=>en(be({},"__esModule",{value:!0}),n);var c=(n,e,t)=>Jt(n,typeof e!="symbol"?e+"":e,t),$e=(n,e,t)=>e.has(n)||Ot("Cannot "+t);var g=(n,e,t)=>($e(n,e,"read from private field"),t?t.call(n):e.get(n)),D=(n,e,t)=>e.has(n)?Ot("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),K=(n,e,t,r)=>($e(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),y=(n,e,t)=>($e(n,e,"access private method"),t);var nr={};Xt(nr,{VEErrorCodes:()=>d,VEErrorDetails:()=>Ye,VERSION:()=>ne,VideoEngagerAgent:()=>N,VideoEngagerAgentError:()=>a,acceptCall:()=>Qn,agentSettings:()=>Wn,call:()=>Hn,default:()=>tr,destroy:()=>Fn,endCall:()=>$n,getCurrentCallState:()=>Zn,getDisplayName:()=>qn,getInstance:()=>kn,getReceivedCalls:()=>Jn,init:()=>Vn,isIframeOpened:()=>jn,isInitialized:()=>Gn,isOnQueue:()=>er,off:()=>Bn,on:()=>zn,rejectCall:()=>Yn,setUiHandler:()=>Kn,switchQueue:()=>Xn});module.exports=tn(nr);function Rt(n){return{all:n=n||new Map,on:function(e,t){var r=n.get(e);r?r.push(t):n.set(e,[t])},off:function(e,t){var r=n.get(e);r&&(t?r.splice(r.indexOf(t)>>>0,1):n.set(e,[]))},emit:function(e,t){var r=n.get(e);r&&r.slice().map(function(i){i(t)}),(r=n.get("*"))&&r.slice().map(function(i){i(e,t)})}}}var v=[];for(let n=0;n<256;++n)v.push((n+256).toString(16).slice(1));function vt(n,e=0){return(v[n[e+0]]+v[n[e+1]]+v[n[e+2]]+v[n[e+3]]+"-"+v[n[e+4]]+v[n[e+5]]+"-"+v[n[e+6]]+v[n[e+7]]+"-"+v[n[e+8]]+v[n[e+9]]+"-"+v[n[e+10]]+v[n[e+11]]+v[n[e+12]]+v[n[e+13]]+v[n[e+14]]+v[n[e+15]]).toLowerCase()}var ze,nn=new Uint8Array(16);function Be(){if(!ze){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ze=crypto.getRandomValues.bind(crypto)}return ze(nn)}var rn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),je={randomUUID:rn};function on(n,e,t){var i,o,s;if(je.randomUUID&&!e&&!n)return je.randomUUID();n=n||{};let r=(s=(o=n.random)!=null?o:(i=n.rng)==null?void 0:i.call(n))!=null?s:Be();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let l=0;l<16;++l)e[t+l]=r[l];return e}return vt(r)}var k=on;var ue=class extends Error{constructor(t){super(`Operation "${t}" is already running`);this.op=t}},he=class extends Error{constructor(t,r){super(`Cannot run "${t}" while [${r.join(", ")}] are running`);this.op=t;this.conflicts=r}},x=class extends Error{constructor(t){super(`Operation "${t}" was aborted`);this.op=t}},z=class extends Error{constructor(t,r){super(`Operation "${t}" timed out after ${r} ms`);this.op=t;this.ms=r}};var Qe=class{constructor(){c(this,"_emitter");c(this,"_listeners",new Map);c(this,"_pendingEvents",new Set);c(this,"_shuttingDown",!1);c(this,"addListener",this.on.bind(this));c(this,"removeListener",this.off.bind(this));this._emitter=Rt()}on(e,t,r={async:!1}){var o;let i={id:k(),isAsync:(o=r.async)!=null?o:!1,originalHandler:t,wrappedHandler:async(...s)=>{if(!this._shuttingDown)try{if(i.isAsync){let l=Promise.resolve().then(()=>t(...s));this._pendingEvents.add(l),await l.finally(()=>this._pendingEvents.delete(l))}else await t(...s)}catch(l){console.error(`[SafeEventBus] Handler failed for "${e}":`,l),this.emit("error",{event:e,error:l,payload:s})}}};return this._listeners.has(e)||this._listeners.set(e,[]),this._listeners.get(e).push(i),this._emitter.on(e,i.wrappedHandler),()=>this.off(e,t)}once(e,t,r={async:!1}){let i=async o=>{this.off(e,i),await t(o)};return this.on(e,i,r)}waitFor(e,t=5e3,r,i="resolve"){if(r&&typeof r!="function")throw new Error("Filter must be a function");let o,s,l=()=>{};return{promise:new Promise((m,E)=>{t!==-1&&(o=setTimeout(()=>{s&&s(),E(new z(`Timeout waiting for event: ${e}`,t))},t)),s=this.on(e,T=>{try{if(r&&!r(T))return;clearTimeout(o),s&&s(),m(T)}catch(A){clearTimeout(o),s&&s(),E(A);return}}),l=T=>{if(t!==-1&&clearTimeout(o),s&&s(),i==="reject"){E(new x(`Wait for event cancelled: ${e}`));return}m(T||void 0)}}),cancel:l}}waitForAny(e,t=5e3,r,i="resolve"){if(!Array.isArray(e)||e.length===0)throw new Error("eventNames must be a non-empty array");if(r&&typeof r!="function")throw new Error("Filter must be a function");let o,s=[],l=()=>{};return{promise:new Promise((m,E)=>{t!==-1&&(o=setTimeout(()=>{s.forEach(A=>A()),E(new z(`Timeout waiting for any of events: ${e.join(", ")}`,t))},t));let T=A=>R=>{try{if(r&&!r({event:A,payload:R}))return;clearTimeout(o),s.forEach(I=>I()),m({event:A,payload:R})}catch(I){clearTimeout(o),s.forEach(C=>C()),E(I)}};e.forEach(A=>{let R=this.on(A,T(A));s.push(R)}),l=A=>{if(t!==-1&&clearTimeout(o),s.forEach(R=>R()),i==="reject"){E(new x(`Wait for any event cancelled: ${e.join(", ")}`));return}m(A||void 0)}}),cancel:l}}off(e,t){let r=this._listeners.get(e);if(!r)return;let i=r.findIndex(o=>o.originalHandler===t);if(i!==-1){let[o]=r.splice(i,1);this._emitter.off(e,o.wrappedHandler)}r.length===0&&this._listeners.delete(e)}async emit(e,t,r={}){if(this._shuttingDown){console.warn(`[SafeEventBus] Emit ignored during shutdown: ${e}`);return}if(r.awaitListeners){let i=this._listeners.get(e)||[];for(let{wrappedHandler:o}of i)try{await o(t)}catch(s){console.error(`[SafeEventBus] Sequential handler error: ${e}`,s)}}else this._emitter.emit(e,t)}async shutdown(e=5e3){this._shuttingDown=!0;let t=new Promise((r,i)=>setTimeout(()=>i(new Error("Shutdown timeout")),e));try{await Promise.race([Promise.allSettled([...this._pendingEvents]),t])}catch(r){console.error("[SafeEventBus] Shutdown error:",r)}finally{this._listeners.clear(),this._emitter.all.clear()}}subscribe(e,t){return this.on(e,t)}getListenerCount(e){var t;return e?((t=this._listeners.get(e))==null?void 0:t.length)||0:[...this._listeners.values()].reduce((r,i)=>r+i.length,0)}},B=Qe;var G=k(),sn=new RegExp('(\\\\)?"@__(F|R|D|M|S|A|U|I|B|L)-'+G+'-(\\d+)__@"',"g"),an=/\{\s*\[native code\]\s*\}/g,ln=/function.*?\(/,cn=/.*?=>.*?/,dn=/[<>\/\u2028\u2029]/g,gn=["*","async"],un={"<":"\\u003C",">":"\\u003E","/":"\\u002F","\u2028":"\\u2028","\u2029":"\\u2029"};function hn(n){return un[n]}function Dt(n){let e=[];for(let t in n)typeof n[t]=="function"&&e.push(t);for(let t=0;t<e.length;t++)delete n[e[t]]}function Lt(n){let e=n.toString();if(an.test(e))throw new TypeError("Serializing native function: "+n.name);if(ln.test(e)||cn.test(e))return e;let t=e.indexOf("("),r=e.substr(0,t).trim().split(" ").filter(function(o){return o.length>0});return r.filter(function(o){return gn.indexOf(o)===-1}).length>0?(r.indexOf("async")>-1?"async ":"")+"function"+(r.join("").indexOf("*")>-1?"*":"")+e.substr(t):e}function pn(n,e){let t=new WeakMap,r={__circularRefId:0};function i(o,s){try{if(e.ignoreFunction&&s&&typeof s=="object"&&Dt(s),s===null||s===0||s===!1||s===""||!s&&s!==void 0&&s!==BigInt(0))return s;let l=this[o],p=typeof l;if(p==="object"&&l!==null){if(t.has(l))return{__type:"CircularRef",refId:t.get(l)};let m=r.__circularRefId++;if(t.set(l,m),l instanceof RegExp)return{__type:"RegExp",source:l.source,flags:l.flags};if(l instanceof Date)return isNaN(l.getTime())?{__type:"Date",value:"Invalid Date"}:{__type:"Date",value:l.toISOString()};if(l instanceof Map)return{__type:"Map",entries:Array.from(l.entries())};if(l instanceof Set)return{__type:"Set",values:Array.from(l.values())};if(l instanceof Array)return l.length!==Object.keys(l).length?{__type:"SparseArray",length:l.length,entries:Object.assign({},l)}:l;if(l instanceof URL)return{__type:"URL",value:l.toString()};if(l instanceof Error)return{__type:"Error",name:l.name,message:l.message,stack:l.stack}}if(p==="function"){if(e.ignoreFunction)return;try{return{__type:"Function",value:Lt(l),name:l.name}}catch(m){return{__type:"Function",error:m.message,name:l.name}}}if(p==="undefined")return{__type:"undefined"};if(p==="number"){if(isNaN(l))return{__type:"NaN"};if(!isFinite(l))return{__type:"Infinity",value:l>0?"Infinity":"-Infinity"}}return p==="bigint"?{__type:"BigInt",value:l.toString()}:p==="symbol"?{__type:"Symbol",description:l.description}:s}catch(l){return{__type:"SerializationError",error:l.message}}}try{if(e.ignoreFunction&&typeof n=="function"&&(n=void 0),n===void 0)return{__type:"undefined"};if(n===null)return null;let o=JSON.stringify(n,i,e.space);return o===void 0?{__type:"undefined"}:JSON.parse(o)}catch(o){return{__type:"SerializationError",error:o.message,originalType:typeof n}}}function Y(n,e){if(e||(e={}),(typeof e=="number"||typeof e=="string")&&(e={space:e}),e.returnObject)return pn(n,e);let t=[],r=[],i=[],o=[],s=[],l=[],p=[],m=[],E=[],T=[],A=new WeakSet;function R(C,O){if(e.ignoreFunction&&Dt(O),!O&&O!==void 0&&O!==BigInt(0))return O;let f=this[C],w=typeof f;if(w==="object"&&f!==null){if(A.has(f))return"[Circular]";if(A.add(f),f instanceof RegExp)return"@__R-"+G+"-"+(r.push(f)-1)+"__@";if(f instanceof Date)return"@__D-"+G+"-"+(i.push(f)-1)+"__@";if(f instanceof Map)return"@__M-"+G+"-"+(o.push(f)-1)+"__@";if(f instanceof Set)return"@__S-"+G+"-"+(s.push(f)-1)+"__@";if(f instanceof Array&&f.filter(function(){return!0}).length!==f.length)return"@__A-"+G+"-"+(l.push(f)-1)+"__@";if(f instanceof URL)return"@__L-"+G+"-"+(T.push(f)-1)+"__@"}return w==="function"?"@__F-"+G+"-"+(t.push(f)-1)+"__@":w==="undefined"?"@__U-"+G+"-"+(p.push(f)-1)+"__@":w==="number"&&!isNaN(f)&&!isFinite(f)?"@__I-"+G+"-"+(m.push(f)-1)+"__@":w==="bigint"?"@__B-"+G+"-"+(E.push(f)-1)+"__@":O}if(e.ignoreFunction&&typeof n=="function"&&(n=void 0),n===void 0)return String(n);let I;return e.isJSON&&!e.space?I=JSON.stringify(n):I=JSON.stringify(n,e.isJSON?null:R,e.space),typeof I!="string"?String(I):(e.unsafe!==!0&&(I=I.replace(dn,hn)),t.length===0&&r.length===0&&i.length===0&&o.length===0&&s.length===0&&l.length===0&&p.length===0&&m.length===0&&E.length===0&&T.length===0?I:I.replace(sn,function(C,O,f,w){if(O)return C;if(f==="D")return'new Date("'+i[w].toISOString()+'")';if(f==="R")return"new RegExp("+Y(r[w].source)+', "'+r[w].flags+'")';if(f==="M")return"new Map("+Y(Array.from(o[w].entries()),e)+")";if(f==="S")return"new Set("+Y(Array.from(s[w].values()),e)+")";if(f==="A")return"Array.prototype.slice.call("+Y(Object.assign({length:l[w].length},l[w]),e)+")";if(f==="U")return"undefined";if(f==="I")return m[w];if(f==="B")return'BigInt("'+E[w]+'")';if(f==="L")return"new URL("+Y(T[w].toString(),e)+")";let ce=t[w];return Lt(ce)}))}var pe=class n extends Error{constructor(t,r,i,o={},s="1.0.0"){super(r);c(this,"idempotencyKey",k());c(this,"cause");c(this,"context");c(this,"code");c(this,"version");this.name=t||"VideoEngagerError",this.cause=i,this.message=`VideoEngagerError: ${this.cause.name}`,this.code=i.code,this.context=o,this.version=s}static isVeError(t){return t instanceof n}toString(){let t=this.cause.description||"No description available",r=this.cause.originalError?`
Original Error: ${this.cause.originalError.message}`:"";return`${this.name} [${this.code}]: ${t}${r}`}toJSON(){var t;return Y({name:this.name,message:this.message,code:this.code,cause:{...this.cause,originalError:(t=this.cause.originalError)==null?void 0:t.message},context:this.context,version:this.version,stack:this.stack,idempotencyKey:this.idempotencyKey},{ignoreFunction:!0,returnObject:!0})}},fn=["code","name","description"];function mn(n,e){let t=(r,i)=>{if(!r||typeof r!="object"||Object.keys(r).length===0)throw new Error(`Invalid VideoEngager ${i} configuration`)};t(n,"error codes"),t(e,"error details"),Object.values(n).forEach(r=>{e[r]||console.warn(`Missing error details for code: ${r}`)}),Object.entries(e).forEach(([r,i])=>{if(!i||typeof i!="object")throw new Error(`Invalid error details for code: ${r}`);fn.forEach(o=>{if(!(o in i))throw new Error(`Missing required field '${o}' in error details for code: ${r}`)})})}var En={name:"UnknownError",description:"An unknown error occurred",code:"unknown"};function Pt(n,e,t="VideoEngager",r="1.0.0"){mn(n,e);let o=class o extends pe{constructor(l,p={}){let{originalError:m,context:E={},retryable:T,component:A=t}=p,R=e[l];R||console.warn(`Unknown error code: ${l}. Falling back to unhandled error.`);let I=R||En,C=typeof m=="string"?new Error(m):m,O={code:I.code,name:I.name,description:I.description,retryable:T,component:A,originalError:C},f=`VideoEngagerError: ${I.name||(C==null?void 0:C.message)||"UnknownError"}`;super("VideoEngagerError",f,O,E,r),this.code=l,this.cause=O,In(this)}static isVeError(l){return l instanceof pe}static isOwnError(l){return l instanceof o}static getErrorDetails(l){return e[l]}static isValidCode(l){return Object.values(n).includes(l)}};c(o,"codes",n),c(o,"errorsDetails",e);let i=o;return i}var An=new B,_n=300*1e3,Mt=1e3,q=new Map;function In(n){if(!n||typeof n!="object")return;if(!("idempotencyKey"in n))try{Object.assign(n,{idempotencyKey:k()})}catch{return}let e=n.idempotencyKey,t=Date.now();for(let[r,i]of q)t-i>_n&&q.delete(r);if(!q.has(e)&&(q.set(e,t),An.emit("error",n),q.size>Mt)){let r=q.size-Mt,i=0;for(let o of q.keys())if(q.delete(o),++i>=r)break}}var ne="4.0.1";var d=Object.freeze({AGENT_ALREADY_INITIALIZED:"agent|already-initialized",AGENT_NOT_INITIALIZED:"agent|not-initialized",AGENT_NOT_AUTHENTICATED:"agent|not-authenticated",AUTH_METHOD_NOT_SUPPORTED:"auth|method-not-supported",AUTH_GENESYS_ENVIRONMENT_REQUIRED:"auth|genesys-environment-required",AUTH_GENERIC_API_KEY_REQUIRED:"auth|generic-api-key-required",AUTH_GENERIC_EXTERNAL_ID_REQUIRED:"auth|generic-external-id-required",AUTH_GENERIC_AGENT_EMAIL_REQUIRED:"auth|generic-agent-email-required",AUTH_CUSTOM_FUNCTION_REQUIRED:"auth|custom-function-required",AUTH_CUSTOM_PARAMETERS_MISSING:"auth|custom-parameters-missing",AUTH_CUSTOM_PARAMETERS_INVALID_TYPE:"auth|custom-parameters-invalid-type",AUTH_CUSTOM_PARAMETERS_EMPTY:"auth|custom-parameters-empty",AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE:"auth|custom-parameters-invalid-value-type",AUTH_TOKEN_REQUIRED:"auth|token-required",CONFIG_DOMAIN_REQUIRED:"config|domain-required",CONFIG_DOMAIN_INVALID_FORMAT:"config|domain-invalid-format",CONFIG_CONTAINER_ID_INVALID_TYPE:"config|container-id-invalid-type",UI_HANDLERS_BAD_CONFIG:"ui-handlers|bad-config",UI_HANDLERS_METHOD_REQUIRED:"ui-handlers|method-required",UI_HANDLERS_NOT_INITIALIZED:"ui-handlers|not-initialized",PARAM_CUSTOMER_ID_INVALID_TYPE:"param|customer-id-invalid-type",SESSION_ALREADY_ACTIVE:"session|already-active",SESSION_NOT_FOUND:"session|not-found",SESSION_FAILED_TO_START:"session|failed-to-start",CALL_NOT_STARTED:"call|not-started",CALL_ALREADY_FINISHED:"call|already-finished",WIDGET_IFRAME_LOAD_FAILED:"widget|iframe-load-failed",WIDGET_IFRAME_NOT_FOUND:"widget|iframe-not-found",WIDGET_CONTAINER_NOT_FOUND:"widget|container-not-found",OPERATION_ALREADY_RUNNING:"operation|already-running",OPERATION_TIMEOUT:"operation|timeout",OPERATION_CONFLICT:"operation|conflict",OPERATION_ABORTED:"operation|aborted",VE_UNHANDLED_ERROR:"ve|unhandled-error",INVALID_ARGUMENT:"validation|invalid-argument",REQUIRED_FIELD_MISSING:"validation|required-field-missing",AGENT_NOT_IN_STANDALONE_MODE:"standalone|agent-not-in-standalone-mode",VISITOR_HAS_LEFT_SESSION:"standalone|visitor-has-left-session",SESSION_ACCEPTED_BY_ANOTHER_AGENT:"standalone|session-accepted-by-another-agent",SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE:"standalone|session-accepted-by-self-on-another-device"}),Ye=Object.freeze({[d.AGENT_ALREADY_INITIALIZED]:{name:"AgentAlreadyInitialized",description:"VideoEngager Agent is already initialized. Cannot initialize again.",code:d.AGENT_ALREADY_INITIALIZED},[d.AGENT_NOT_INITIALIZED]:{name:"AgentNotInitialized",description:"VideoEngager Agent is not initialized. Call initialize() first.",code:d.AGENT_NOT_INITIALIZED},[d.AGENT_NOT_AUTHENTICATED]:{name:"AgentNotAuthenticated",description:"VideoEngager Agent is not authenticated. Call initialize() first.",code:d.AGENT_NOT_AUTHENTICATED},[d.AUTH_METHOD_NOT_SUPPORTED]:{name:"AuthMethodNotSupported",description:"The specified authentication method is not supported.",code:d.AUTH_METHOD_NOT_SUPPORTED},[d.AUTH_GENESYS_ENVIRONMENT_REQUIRED]:{name:"GenesysEnvironmentRequired",description:"Genesys environment is required for Genesys authentication.",code:d.AUTH_GENESYS_ENVIRONMENT_REQUIRED},[d.AUTH_GENERIC_API_KEY_REQUIRED]:{name:"GenericApiKeyRequired",description:"API key is required for generic authentication.",code:d.AUTH_GENERIC_API_KEY_REQUIRED},[d.AUTH_GENERIC_AGENT_EMAIL_REQUIRED]:{name:"GenericAgentEmailRequired",description:"Agent email is required for generic authentication.",code:d.AUTH_GENERIC_AGENT_EMAIL_REQUIRED},[d.AUTH_GENERIC_EXTERNAL_ID_REQUIRED]:{name:"GenericExternalIdRequired",description:"External ID is required for generic authentication in standalone mode.",code:d.AUTH_GENERIC_EXTERNAL_ID_REQUIRED},[d.AUTH_CUSTOM_FUNCTION_REQUIRED]:{name:"CustomAuthFunctionRequired",description:"Custom authentication function is required for custom authentication.",code:d.AUTH_CUSTOM_FUNCTION_REQUIRED},[d.AUTH_CUSTOM_PARAMETERS_MISSING]:{name:"CustomAuthParametersMissing",description:"Authentication parameters are missing in the response from custom authentication function.",code:d.AUTH_CUSTOM_PARAMETERS_MISSING},[d.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE]:{name:"CustomAuthParametersInvalidType",description:"Authentication parameters should be an object.",code:d.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE},[d.AUTH_CUSTOM_PARAMETERS_EMPTY]:{name:"CustomAuthParametersEmpty",description:"Authentication parameters are empty.",code:d.AUTH_CUSTOM_PARAMETERS_EMPTY},[d.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE]:{name:"CustomAuthParametersInvalidValueType",description:"Invalid type for authentication parameter. Only string, number, and boolean are supported.",code:d.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE},[d.AUTH_TOKEN_REQUIRED]:{name:"AuthTokenRequired",description:"Token is required for token-based authentication.",code:d.AUTH_TOKEN_REQUIRED},[d.CONFIG_DOMAIN_REQUIRED]:{name:"DomainRequired",description:"Domain must be a non-empty string.",code:d.CONFIG_DOMAIN_REQUIRED},[d.CONFIG_DOMAIN_INVALID_FORMAT]:{name:"DomainInvalidFormat",description:"Invalid domain format. Please provide a valid domain.",code:d.CONFIG_DOMAIN_INVALID_FORMAT},[d.CONFIG_CONTAINER_ID_INVALID_TYPE]:{name:"ContainerIdInvalidType",description:"Container ID must be a string.",code:d.CONFIG_CONTAINER_ID_INVALID_TYPE},[d.UI_HANDLERS_BAD_CONFIG]:{name:"UIHandlersBadConfig",description:"UI handlers are not configured correctly. Please check your UI handlers configuration.",code:d.UI_HANDLERS_BAD_CONFIG},[d.UI_HANDLERS_METHOD_REQUIRED]:{name:"UIHandlersMethodRequired",description:"Required UI handler method is missing or not a function.",code:d.UI_HANDLERS_METHOD_REQUIRED},[d.UI_HANDLERS_NOT_INITIALIZED]:{name:"UIHandlersNotInitialized",description:"UI handlers are not initialized. Please ensure that the UI handlers are set up before using them.",code:d.UI_HANDLERS_NOT_INITIALIZED},[d.PARAM_CUSTOMER_ID_INVALID_TYPE]:{name:"CustomerIdInvalidType",description:"Customer ID must be a string and not empty.",code:d.PARAM_CUSTOMER_ID_INVALID_TYPE},[d.SESSION_ALREADY_ACTIVE]:{name:"SessionAlreadyActive",description:"A session is already active. Cannot start a new session.",code:d.SESSION_ALREADY_ACTIVE},[d.SESSION_NOT_FOUND]:{name:"SessionNotFound",description:"No active session found.",code:d.SESSION_NOT_FOUND},[d.SESSION_FAILED_TO_START]:{name:"SessionFailedToStart",description:"Failed to start the video session.",code:d.SESSION_FAILED_TO_START},[d.CALL_NOT_STARTED]:{name:"CallNotStarted",description:"Call has not been started yet.",code:d.CALL_NOT_STARTED},[d.CALL_ALREADY_FINISHED]:{name:"CallAlreadyFinished",description:"Call has already finished.",code:d.CALL_ALREADY_FINISHED},[d.WIDGET_IFRAME_LOAD_FAILED]:{name:"WidgetIframeLoadFailed",description:"Failed to load the VideoEngager widget iframe.",code:d.WIDGET_IFRAME_LOAD_FAILED},[d.WIDGET_IFRAME_NOT_FOUND]:{name:"WidgetIframeNotFound",description:"VideoEngager widget iframe not found in the DOM.",code:d.WIDGET_IFRAME_NOT_FOUND},[d.WIDGET_CONTAINER_NOT_FOUND]:{name:"WidgetContainerNotFound",description:"VideoEngager widget container not found in the DOM.",code:d.WIDGET_CONTAINER_NOT_FOUND},[d.OPERATION_ALREADY_RUNNING]:{name:"OperationAlreadyRunning",description:"Operation is already running and cannot be started again.",code:d.OPERATION_ALREADY_RUNNING},[d.OPERATION_TIMEOUT]:{name:"OperationTimeout",description:"Operation timed out before completion.",code:d.OPERATION_TIMEOUT},[d.OPERATION_CONFLICT]:{name:"OperationConflict",description:"Cannot run operation due to conflicting operations already running.",code:d.OPERATION_CONFLICT},[d.OPERATION_ABORTED]:{name:"OperationAborted",description:"Operation was aborted before completion.",code:d.OPERATION_ABORTED},[d.VE_UNHANDLED_ERROR]:{name:"UnhandledError",description:"An unhandled error occurred in the VideoEngager system. Please check the logs for more details.",code:d.VE_UNHANDLED_ERROR},[d.INVALID_ARGUMENT]:{name:"InvalidArgument",description:"Invalid argument provided to the function.",code:d.INVALID_ARGUMENT},[d.REQUIRED_FIELD_MISSING]:{name:"RequiredFieldMissing",description:"Required field is missing or empty.",code:d.REQUIRED_FIELD_MISSING},[d.AGENT_NOT_IN_STANDALONE_MODE]:{name:"AgentNotInStandaloneMode",description:"The requested operation is only available in standalone mode.",code:d.AGENT_NOT_IN_STANDALONE_MODE},[d.VISITOR_HAS_LEFT_SESSION]:{name:"VisitorHasLeftSession",description:"The visitor has left the session.",code:d.VISITOR_HAS_LEFT_SESSION},[d.SESSION_ACCEPTED_BY_ANOTHER_AGENT]:{name:"SessionAcceptedByAnotherAgent",description:"The session was accepted by another agent.",code:d.SESSION_ACCEPTED_BY_ANOTHER_AGENT},[d.SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE]:{name:"SessionAcceptedBySelfOnAnotherDevice",description:"The session was accepted by the same agent on another device or tab.",code:d.SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE}}),a=Pt(d,Ye,"VideoEngagerAgent",ne);var fe=class{constructor(e){c(this,"name","custom");c(this,"configs");this.configs=e}async authenticate(){this.validateConfigs();let e=await this.configs.authenticateFn(this.configs);if(!e)throw new a(a.codes.AUTH_CUSTOM_PARAMETERS_MISSING);if(typeof e!="object")throw new a(a.codes.AUTH_CUSTOM_PARAMETERS_INVALID_TYPE);if(Object.keys(e).length===0)throw new a(a.codes.AUTH_CUSTOM_PARAMETERS_EMPTY);let t={};for(let r in e){let i=e[r];if(typeof i!="string"&&typeof i!="number"&&typeof i!="boolean")throw new a(a.codes.AUTH_CUSTOM_PARAMETERS_INVALID_VALUE_TYPE,{context:{parameterKey:r,valueType:typeof i,actualValue:i}});t[r]=String(i)}return t}validateConfigs(){if(!this.configs.authenticateFn||typeof this.configs.authenticateFn!="function")throw new a(a.codes.AUTH_CUSTOM_FUNCTION_REQUIRED)}};var me=class{constructor(e){c(this,"name","generic");c(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:"generic",pak:this.configs.apiKey,email:`${this.configs.organizationId?`${this.configs.organizationId}`:""}${this.configs.agentEmail}`}}validateConfigs(){if(!this.configs.apiKey||this.configs.apiKey==="")throw new a(a.codes.AUTH_GENERIC_API_KEY_REQUIRED);if(!this.configs.agentEmail||this.configs.agentEmail==="")throw new a(a.codes.AUTH_GENERIC_AGENT_EMAIL_REQUIRED);if(this.configs.standaloneMode&&(!this.configs.externalId||this.configs.externalId===""))throw new a(a.codes.AUTH_GENERIC_EXTERNAL_ID_REQUIRED)}};var Ee=class{constructor(e){c(this,"name","genesys");c(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{environment:this.configs.environment}}validateConfigs(){if(!this.configs.environment||this.configs.environment==="")throw new a(a.codes.AUTH_GENESYS_ENVIRONMENT_REQUIRED)}};var Ae=class{constructor(e){c(this,"name","token");c(this,"configs");this.configs=e}authenticate(){return this.validateConfigs(),{token:this.configs.token}}validateConfigs(){if(!this.configs.token||this.configs.token==="")throw new a(a.codes.AUTH_TOKEN_REQUIRED)}};var qe=Object.freeze({generic:me,genesys:Ee,custom:fe,token:Ae});var xt=Object.freeze({NONE:"NONE",CALL_STARTED:"CALL_STARTED",PRE_CALL:"PRE_CALL",FINISHED:"FINISHED",END_CALL:"END_CALL"});var Oe=class{constructor(e="sequential-reversed",t){this.logger=t;c(this,"actions",[]);c(this,"strategy");this.strategy=e}register(e){var t;this.actions.push(e),(t=this.logger)==null||t.debug(`Registered compensation action (total: ${this.actions.length})`)}registerIf(e,t){var r,i;e?(this.actions.push(t),(r=this.logger)==null||r.debug(`Conditionally registered compensation action (total: ${this.actions.length})`)):(i=this.logger)==null||i.debug("Compensation action not registered (condition false)")}registerIfLazy(e,t){var i;let r=async()=>{var o,s;try{await Promise.resolve(e())?await Promise.resolve(t()):(o=this.logger)==null||o.debug("Skipping lazy conditional action (condition false)")}catch(l){(s=this.logger)==null||s.error("Condition evaluation failed, treating as false:",l)}};this.actions.push(r),(i=this.logger)==null||i.debug(`Registered lazy conditional compensation action (total: ${this.actions.length})`)}getActionCount(){return this.actions.length}setStrategy(e){var t;(t=this.logger)==null||t.debug(`Changing compensation strategy from ${this.strategy} to ${e}`),this.strategy=e}getStrategy(){return this.strategy}async executeAll(){var t,r,i,o,s;if(this.actions.length===0){(t=this.logger)==null||t.debug("No compensation actions to execute");return}(r=this.logger)==null||r.debug(`Executing ${this.actions.length} compensation actions with strategy: ${this.strategy}`);let e=this.strategy==="sequential-reversed"?[...this.actions].reverse():this.actions;if(this.strategy==="parallel")(await Promise.allSettled(e.map(p=>Promise.resolve(p())))).forEach((p,m)=>{var E;p.status==="rejected"&&((E=this.logger)==null||E.error(`Compensation action ${m+1} failed:`,p.reason))});else for(let l=0;l<e.length;l++)try{await e[l](),(i=this.logger)==null||i.debug(`Compensation action ${l+1}/${e.length} completed`)}catch(p){(o=this.logger)==null||o.error(`Compensation action ${l+1} failed:`,p)}(s=this.logger)==null||s.debug("All compensation actions executed")}clear(){var e;this.actions=[],(e=this.logger)==null||e.debug("Cleared all compensation actions")}};var L=class{constructor(e,t={memoryLeakCheckTimeoutMs:1e4}){this.configs=t;c(this,"operations",new Map);c(this,"logger");this.logger=e}async run(e,t,r={}){var ot,st,at,lt,ct,dt,gt,ut,ht,pt,ft,mt,Et,At,_t,It,Ct,yt,Tt,St,Nt,wt;let{waitIfRunning:i=!1,useExistingRunResult:o=!1,onExistingRunFail:s="ignore",waitIfRunningDelayMs:l=0,conflictsWith:p=[],waitFor:m=[],waitForDelayMs:E=0,timeoutMs:T=0,signal:A,beforeRun:R,onSuccess:I,onAbort:C,onError:O,onWaitForRunsFail:f="ignore",transformError:w,compensationStrategy:ce="sequential-reversed",shouldCompensate:Se}=r,J=new Oe(ce,this.logger);(ot=this.logger)==null||ot.debug(`Running operation "${e}" with compensation strategy: ${ce}`);let qt=setTimeout(()=>{var h;(h=this.logger)==null||h.warn(`Operation "${e}" is taking too long to complete. Possible memory leak detected.`)},this.configs.memoryLeakCheckTimeoutMs),de,Ne,$=()=>{Ne&&(clearTimeout(Ne),Ne=void 0),A&&de&&(A.removeEventListener("abort",de),de=void 0),clearTimeout(qt)},W=w||(h=>h instanceof Error?h:new Error(String(h)));if(this.isRunning(e))if((st=this.logger)==null||st.debug(`"${e}" already running`),i||o){let U=await this.operations.get(e).promise.catch(P=>{var V;if(s==="throw")throw $(),P;return(V=this.logger)==null||V.debug(`"${e}" existing operation failed, ignoring error and continuing`),$(),P});if(l>0&&((at=this.logger)==null||at.debug(`Adding artificial delay of ${l}ms after waitIfRunning for "${e}"`),await new Promise(P=>setTimeout(P,l))),o){if(U instanceof Error)throw $(),U;return $(),U}(lt=this.logger)==null||lt.debug(`"${e}" completed, now running new instance`)}else throw $(),(ct=this.logger)==null||ct.debug(`"${e}" is already running, not starting a new instance`),W(new ue(e));let Fe=p.filter(h=>this.isRunning(h));if(Fe.length)throw(dt=this.logger)==null||dt.debug(`"${e}" conflicts with [${Fe.join(", ")}]`),$(),W(new he(e,Fe));let we=m.filter(h=>this.isRunning(h));we.length&&((gt=this.logger)==null||gt.debug(`"${e}" waiting for [${we.join(", ")}]`),f==="throw"?await Promise.all(we.map(h=>this.operations.get(h).promise)):await Promise.allSettled(we.map(h=>this.operations.get(h).promise)),(ut=this.logger)==null||ut.debug(`"${e}" done waiting for dependencies`),E>0&&((ht=this.logger)==null||ht.debug(`Adding artificial delay of ${E}ms after waitFor for "${e}"`),await new Promise(h=>setTimeout(h,E))));let X=new AbortController,{signal:ee}=X;if(A&&(A.aborted?X.abort():(de=()=>{var h;X.abort(),(h=this.logger)==null||h.debug(`"${e}" aborted by external signal`)},A.addEventListener("abort",de,{once:!0}))),R)try{(pt=this.logger)==null||pt.debug(`Executing beforeRun hook for "${e}"`);let h=await R(e,ee);if(ee.aborted)throw $(),W(new x(e));if(h&&h.skip)return(ft=this.logger)==null||ft.debug(`Operation "${e}" silently skipped by beforeRun hook`),$(),h.value}catch(h){if((mt=this.logger)==null||mt.debug(`beforeRun hook aborted operation "${e}": ${h}`),$(),h instanceof x)throw W(h);let U=new Error(`Operation "${e}" aborted by beforeRun hook: ${h}`);throw U.cause=h,W(U)}let it=(async()=>{var h;try{T>0&&((h=this.logger)==null||h.debug(`Setting timeout of ${T}ms for "${e}"`),Ne=setTimeout(()=>{var P;(P=this.logger)==null||P.debug(`"${e}" timed out after ${T}ms`),X.abort("Timeout")},T));let U=t(ee,J);return await new Promise((P,V)=>{var te;(te=this.logger)==null||te.debug(`"${e}" operation started`),X.signal.addEventListener("abort",He=>{var ge;(ge=this.logger)==null||ge.debug(`"${e}" aborted by controller with reason: ${ee.reason}`),V(ee.reason==="Timeout"?new z(e,T):new x(e))}),U.then(P).catch(He=>{var ge,bt;ee.aborted?((ge=this.logger)==null||ge.debug(`"${e}" operation aborted`),V(new x(e))):((bt=this.logger)==null||bt.debug(`"${e}" operation failed: ${He}`),V(He))})})}finally{$()}})();this.operations.set(e,{promise:it,controller:X});try{let h=await it;(Et=this.logger)==null||Et.debug(`"${e}" operation completed successfully`);try{await(I==null?void 0:I(h))}catch(U){(At=this.logger)==null||At.error(`onSuccess hook for "${e}" failed`,U)}return h}catch(h){if(h instanceof DOMException&&h.name==="AbortError"||h instanceof x||h instanceof z){let P=h instanceof z?`"${e}" timed out after ${T}ms`:`"${e}" aborted`;if((_t=this.logger)==null||_t.warn(P),(Se?Se(h):!0)&&J.getActionCount()>0){(It=this.logger)==null||It.debug(`Executing compensations for aborted operation "${e}"`);try{await J.executeAll()}catch(te){(Ct=this.logger)==null||Ct.error(`Failed to execute compensations for "${e}"`,te)}}try{await(C==null?void 0:C())}catch(te){(yt=this.logger)==null||yt.error(`onAbort hook for "${e}" failed`,te)}throw W(h)}else{if((Tt=this.logger)==null||Tt.error(`Operation "${e}" failed with error:`,h),(Se?Se(h):!0)&&J.getActionCount()>0){(St=this.logger)==null||St.debug(`Executing compensations for failed operation "${e}"`);try{await J.executeAll()}catch(V){(Nt=this.logger)==null||Nt.error(`Failed to execute compensations for "${e}"`,V)}}try{await(O==null?void 0:O(h))}catch(V){(wt=this.logger)==null||wt.error(`onError hook for "${e}" failed`,V)}throw W(h)}}finally{J.clear(),this.operations.delete(e)}}isRunning(e){return this.operations.has(e)}getRunningOperations(){return[...this.operations.keys()]}async waitFor(e){let t=this.operations.get(e);t&&await t.promise}async waitForAll(){await Promise.all([...this.operations.values()].map(e=>e.promise))}async waitForMany({operations:e,delay:t=0}){var i;let r=e.filter(o=>this.operations.has(o));if(r.length===0){(i=this.logger)==null||i.debug(`No operations found to wait for: ${e.join(", ")}`);return}await Promise.allSettled(r.map(o=>{var s;return(s=this.operations.get(o))==null?void 0:s.promise})),t>0&&await new Promise(o=>setTimeout(o,t))}abort(e,t="Abort Invoked"){var i,o,s;(i=this.logger)==null||i.debug(`Aborting operation "${e}"`);let r=this.operations.get(e);return r?(r.controller.abort(t),(s=this.logger)==null||s.debug(`Aborted operation "${e}" with reason: ${t}`),!0):((o=this.logger)==null||o.debug(`Operation "${e}" not found`),!1)}abortAll(e="Abort All Invoked"){var r,i;(r=this.logger)==null||r.debug("Aborting all operations");let t=0;for(let[o,s]of this.operations.entries())s.controller.abort(e),t++,(i=this.logger)==null||i.debug(`Aborted operation "${o}"`);return t}};c(L,"OperationRunningError",ue),c(L,"ConflictError",he),c(L,"OperationAbortedError",x),c(L,"OperationTimeoutError",z);var We="video-engager-container";function Ke(n){return(n==null?void 0:n.options)||{}}function Cn(n,e){let r=Ke(e).containerId||We,i=document.getElementById(r),o=!1;i||(i=document.createElement("div"),i.id=r,o=!0);let s=i.querySelector("iframe");s&&i.removeChild(s);let l=document.createElement("iframe");l.setAttribute("allow","camera; microphone; autoplay; encrypted-media; fullscreen; picture-in-picture; display-capture"),l.src=n,l.classList.add("video-engager-widget-iframe"),i.appendChild(l),o&&document.body.appendChild(i)}function yn(n){let t=Ke(n).containerId||We,r=document.querySelector(".video-engager-widget-iframe");r&&r.remove();let i=document.getElementById(t);i&&i.remove()}function Tn(n){let t=Ke(n).containerId||We,r=document.getElementById(t);return r?r.querySelector(".video-engager-widget-iframe"):null}var Re={openIframe:Cn,closeIframe:yn,getIframe:Tn};function Ut(){if(document.getElementById("video-engager-widget-styles"))return;let n=document.createElement("style");n.id="video-engager-widget-styles",n.innerHTML=`
        .video-engager-widget-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        #video-engager-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }
    `,document.head.appendChild(n)}function Vt(n){if((!n.domain||typeof n.domain!="string"||n.domain.trim()==="")&&(n.domain="videome.leadsecure.com"),n.domain=Sn(n.domain),n.authMethod||(n.authMethod="generic"),n.options||(n.options={}),"containerId"in n.options&&typeof n.options.containerId!="string")throw new a(a.codes.CONFIG_CONTAINER_ID_INVALID_TYPE);if("uiHandlers"in n.options&&n.options.uiHandlers){let e=["openIframe","closeIframe","getIframe"];for(let t of e)if(!n.options.uiHandlers[t]||typeof n.options.uiHandlers[t]!="function")throw new a(a.codes.UI_HANDLERS_METHOD_REQUIRED,{context:{missingMethod:t}})}return n}function Sn(n){if(typeof n!="string"||n.trim()==="")throw new a(a.codes.CONFIG_DOMAIN_REQUIRED);try{let e=!n.startsWith("http://")&&!n.startsWith("https://");return new URL(e?`https://${n}`:n).host}catch(e){throw new a(a.codes.CONFIG_DOMAIN_INVALID_FORMAT,{originalError:e,context:{providedDomain:n}})}}function Ze(n){let{OperationRunningError:e,ConflictError:t,OperationAbortedError:r,OperationTimeoutError:i}=L;return a.isVeError(n)?n:n instanceof e?new a(a.codes.OPERATION_ALREADY_RUNNING,{originalError:n,context:{operationName:n.op}}):n instanceof t?new a(a.codes.OPERATION_CONFLICT,{originalError:n,context:{operationName:n.op,conflictingOperations:n.conflicts}}):n instanceof r?new a(a.codes.OPERATION_ABORTED,{originalError:n,context:{operationName:n.op}}):n instanceof i?new a(a.codes.OPERATION_TIMEOUT,{originalError:n,context:{operationName:n.op,timeoutMs:n.ms}}):new a(a.codes.VE_UNHANDLED_ERROR,{originalError:n instanceof Error?n:new Error(kt(n)),context:{message:kt(n)}})}function kt(n){return typeof n=="string"?n:typeof n=="object"&&n!==null&&"message"in n&&typeof n.message=="string"?n.message:typeof n=="object"&&n!==null?JSON.stringify(n):String(n)}var ve=class{constructor(e={}){this.opts=e;c(this,"items",[]);c(this,"log",(e,...t)=>this.push("log",e,t));c(this,"debug",(e,...t)=>this.push("debug",e,t));c(this,"info",(e,...t)=>this.push("info",e,t));c(this,"warn",(e,...t)=>this.push("warn",e,t));c(this,"error",(e,...t)=>this.push("error",e,t))}shouldStore(e){return!this.opts.store||this.opts.store.includes(e)}push(e,t,r){var o;if(!this.shouldStore(e))return;let i=Math.max(1,(o=this.opts.max)!=null?o:500);this.items.push({method:e,data:[t,...r],timestamp:new Date().toISOString()}),this.items.length>i&&this.items.splice(0,this.items.length-i)}clear(){this.items=[]}getItems(){return this.items.slice()}getErrors(){return this.items.filter(e=>e.method==="error")}reportData(){var r;let e={log:0,debug:0,info:0,warn:0,error:0};for(let i of this.items)e[i.method]++;let t=this.getErrors();return{total:this.items.length,counts:e,errors:t,lastError:(r=t.at(-1))!=null?r:null,items:this.getItems()}}};var De="__VE_WIDGET_LOGGER_V2_GLOBALS__",Nn={};function wn(){return typeof window<"u"?window:typeof globalThis<"u"?globalThis:typeof global<"u"?global:Nn}var Le=wn();function bn(){if(!Le[De]){let n=new ve({max:2e3});return Le[De]={globalMemory:n},Le[De]}return Le[De]}var Gt=bn();var _e=class n{constructor(e){c(this,"pathStr");c(this,"sep");c(this,"sinks");c(this,"tombstones",0);c(this,"compactThreshold");c(this,"parent");c(this,"children",new Map);var t,r,i,o;this.sep=(t=e==null?void 0:e.separator)!=null?t:"/",this.pathStr=(r=e==null?void 0:e.pathStr)!=null?r:"root",this.sinks=(i=e==null?void 0:e.sinks)!=null?i:[],this.compactThreshold=(o=e==null?void 0:e.compactThreshold)!=null?o:64,this.parent=e==null?void 0:e.parent}getFinalParent(){let e=this;for(;e.parent;)e=e.parent;return e}child(e){let t=this.children.get(e);if(t)return t;let r=this.pathStr==="root"?"":this.pathStr,i=r?`${r}${this.sep}${e}`:e,o=new n({pathStr:i,separator:this.sep,sinks:this.sinks,compactThreshold:this.compactThreshold});return this.children.set(e,o),o}addSink(e){if(typeof e!="object"||e===null)throw new Error("LoggerSink must be an object with log methods");for(let r=0;r<this.sinks.length;r++)if(this.sinks[r]===e)return()=>{};let t=this.sinks.length;return this.sinks.push(e),()=>{this.sinks[t]!==null&&(this.sinks[t]=null,this.tombstones++,this.tombstones>=this.compactThreshold&&this.compact())}}compact(){if(this.tombstones===0)return;let e=[];for(let t=0;t<this.sinks.length;t++){let r=this.sinks[t];r&&e.push(r)}this.sinks.length=0;for(let t=0;t<e.length;t++)this.sinks.push(e[t]);this.tombstones=0}log(...e){this.dispatch("log",e)}debug(...e){this.dispatch("debug",e)}info(...e){this.dispatch("info",e)}warn(...e){this.dispatch("warn",e)}error(...e){this.dispatch("error",e)}dispatch(e,t){var o;let r=this.pathStr,i=this.sinks;for(let s=0;s<i.length;s++){let l=i[s];if(l)try{let p=(o=l[e])!=null?o:l.log;p&&p.apply(l,[r,...t])}catch{}}}destroy(e){if(this.children){if(this.parent=void 0,e!=null&&e.recursive)for(let t of this.children.values())t.destroy({recursive:!0});this.children.clear()}}get methods(){return Ft}static get methods(){return Ft}withContext(){return this}getLevel(){return{NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4}}setLevel(e){}},Ft=["log","debug","info","warn","error"];var Ht={log:(n,...e)=>console.log(`[${n}]`,...e),debug:(n,...e)=>console.debug(`[${n}]`,...e),info:(n,...e)=>console.info(`[${n}]`,...e),warn:(n,...e)=>console.warn(`[${n}]`,...e),error:(n,...e)=>console.error(`[${n}]`,...e)};function F(n,e={}){var i;if(n instanceof _e){let o=e!=null&&e.component?n.child(e.component):n;return $t(o,e),o}let t={...e};typeof n=="object"&&n&&(t={...t,...n}),typeof n=="boolean"&&(t.debug=n);let r=new _e({pathStr:(i=t.component)!=null?i:"root"});return $t(r,t),r}function $t(n,e){typeof e.debug=="object"&&e.debug!==null?n.addSink(e.debug):typeof e.debug=="boolean"&&e.debug===!0&&n.addSink(Ht),n.addSink(Gt.globalMemory)}var re="__VE_EXTERNAL_SCRIPT_LOADERS__";var Me=class{constructor(e){c(this,"config");c(this,"logger");c(this,"iframe",null);c(this,"id",k());c(this,"loadPromise");c(this,"loaded",!1);c(this,"loadFailed",!1);c(this,"_vars");var t;this.config=e,this.logger=F(this.config.logger,{component:(t=this.config.loggerName)!=null?t:"ExternalScriptLoader"}),window[re]||(window[re]={}),window[re][this.id]=this,this.config.loadImmediately&&(this.loadPromise=this.load().catch(r=>{this.logger.error("Error loading scripts immediately:",r)}).finally(()=>{this.loadPromise=void 0}))}insureLoaded(){if(!this.loaded){if(this.loadFailed)throw new Error("Previous load attempt failed");return this.loadPromise?this.loadPromise:(this.loadPromise=this.load(),this.loadPromise)}}get vars(){if(!this._vars)throw new Error("Script not loaded yet");return this._vars}async load(){try{if(this.iframe){this.logger.warn("Script already loaded");return}this.iframe=document.createElement("iframe"),this.iframe.style.display="none";let e=On(this);this.iframe.srcdoc=e,await new Promise((r,i)=>{this.iframe.onload=()=>{this.logger.info("Iframe loaded"),r(this.iframe)},this.iframe.onerror=o=>{this.logger.error("Error loading iframe:",o),i(o)},document.body.appendChild(this.iframe)});let t=this.iframe.contentWindow;if(!t)throw new Error("Iframe has no contentWindow");this._vars=this.config.varsGetter(t),this.logger.info("Scripts loaded and variables initialized"),this.loaded=!0}catch(e){throw this.loadFailed=!0,this.logger.error("Error loading scripts:",e),e}}unload(){this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null,this._vars=void 0,this.logger.info("Iframe unloaded"),this.logger.destroy(),delete window[re][this.id])}};function On(n){let e=n.config.scripts.map(t=>`<script ${Object.entries(t).map(([i,o])=>o===!0?i:o===!1||o===void 0?"":`${i}="${o}"`).filter(Boolean).join(" ")}><\/script>`).join(`
`);return`
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Iframe App</title>
    <script>
      const modifiedLogger = window.parent['${re}']['${n.id}'].logger;
      ${JSON.stringify(n.logger.methods)}.forEach(method => {
        const original = modifiedLogger[method].bind(modifiedLogger);
        console[method] = (...args) => {
          original.call(modifiedLogger, ...args);
        };
      });
    <\/script>
  </head>
  <body>
    <div id="root"></div>
    ${e}
    
  </body>
</html>
    `}var Rn="__VE_PUSH_CLIENT_MANAGER__",ie=Symbol.for(Rn);var Ie,Ce,Z,xe,zt,Je=class Je{constructor(e,t){D(this,xe);c(this,"component");D(this,Ie,!1);c(this,"eventEmitter",new B);D(this,Ce);D(this,Z,new Set);this.component=t,K(this,Ce,e),y(this,xe,zt).call(this)}get pushClientManager(){return g(this,Ce)}static createSubscribedInstance(e,t){return new Je(e,t)}get state(){return this.pushClientManager.state}get client(){return this.pushClientManager.client}async cleanup(){if(!g(this,Ie)){K(this,Ie,!0);for(let e of g(this,Z))e(),g(this,Z).delete(e);g(this,Z).clear(),this.eventEmitter&&await this.eventEmitter.shutdown().catch(e=>{console.error("[PushSubscribedInstance] Error shutting down event emitter:",e)})}}async destroy(){await this.cleanup().catch(e=>{console.error("[PushSubscribedInstance] Error during cleanup:",e)}),this.pushClientManager.removeSubscriber(this)}get checkIfSessionIdIsMine(){return this.pushClientManager.checkIfSessionIdIsMine.bind(this.pushClientManager)}get waitForConnected(){return this.pushClientManager.waitForConnected.bind(this.pushClientManager)}};Ie=new WeakMap,Ce=new WeakMap,Z=new WeakMap,xe=new WeakSet,zt=function(){g(this,Z).add(this.pushClientManager.eventEmitter.on("*",(e,t)=>{this.eventEmitter.emit(e,t)}))};var Pe=Je;var ye,Xe,se,Ve,H,S,b,j,_,M,Bt,et,Te,jt,Q,Qt,oe=class oe{constructor(e){D(this,_);c(this,"eventEmitter",new B);D(this,se,{connected:!1,sessionId:null,inCallsQueue:!1});D(this,Ve,1e3);D(this,H,!1);D(this,S);D(this,b);D(this,j,new Set);D(this,Te,e=>{switch(e){case"Connected":y(this,_,et).call(this);break;case"Disconnected":case"SessionClosed":case"Expired":y(this,_,M).call(this,"connected",!1),y(this,_,M).call(this,"sessionId",null);break;default:break}});D(this,Q,new Set);if(K(this,S,F(e.logger,{component:"PushClientManager"})),!(e!=null&&e.pushClient))throw new Error("PushClient instance is required");K(this,b,e==null?void 0:e.pushClient),y(this,_,jt).call(this),g(this,b)[ie]=this}static createSubscriber(e){var r;return y(r=oe,ye,Xe).call(r,e).addSubscriber(e.component)}static initialize(e){var t;return y(t=oe,ye,Xe).call(t,e)}get client(){return g(this,b)}get state(){return g(this,se)}get destroyed(){return g(this,H)}async getTimeTableData(){return typeof this.state.timetable>"u"&&await this.eventEmitter.waitFor("state:timetable",3e4,e=>typeof e<"u").promise,this.state.timetable}async leaveCallsQueue(){let e=await this.getTimeTableData();if(e!=="on"&&e!=="disabled")throw new Error('Cannot listen for calls, timetable is not set to "on" or "disabled"');if(!this.state.inCallsQueue)throw new Error("Cannot leave calls queue, already not in queue");return new Promise((t,r)=>{g(this,b).switch.leave({callTypes:["chat","video","screen"]},(i,o)=>{if(i)return r(i);y(this,_,M).call(this,"inCallsQueue",!1),t(o)})})}joinCallsQueue(e=!1){let t=this.state.timetable;if(t!=="on"&&t!=="disabled")throw new Error('Cannot listen for calls, timetable is not set to "on" or "disabled"');if(this.state.inCallsQueue&&!e)throw new Error("Already in calls queue");let r,i,o,s;if(g(this,b).switch.join({callTypes:["chat","video","screen"]},(l,p)=>{if(l&&(s=l,i))return i(l||!0);y(this,_,M).call(this,"inCallsQueue",!0),o=p,r&&r(p||!0)}),o)return o;if(s)throw s;return new Promise((l,p)=>{r=l,i=p})}registerSomeStuff(){let e=!1;this.eventEmitter.on("state:connected",s=>{s||(this.state.inCallsQueue&&(e=!0),y(this,_,M).call(this,"inCallsQueue",!1))});let t=s=>{var p;g(this,S).log("[setCallInfoCallbacks]: Set called with args:",s);let l=["chat","video","screen"];typeof((p=s==null?void 0:s.groups)==null?void 0:p.floor)=="object"&&l.filter(m=>typeof s.groups.floor[m]=="number"&&s.groups.floor[m]>0).length>0?this.joinCallsQueue(!0):g(this,S).log("[setCallInfoCallbacks]: Empty calls queue detected")},r=s=>{var l,p,m;g(this,S).log("[setCallInfoCallbacks]: Update called with args:",s),(m=(p=(l=s==null?void 0:s.mrg)==null?void 0:l.self)==null?void 0:p.set)!=null&&m.timetable&&(y(this,_,M).call(this,"timetable",s.mrg.self.set.timetable),e&&this.joinCallsQueue(!0))},i=(...s)=>{g(this,S).error("[setCallInfoCallbacks]: Error called with args:",...s)};g(this,b).setCallInfoCallbacks(t,r,i);let o=(s,l)=>{g(this,S).log("User info updated:",s,l),s==="timetable"&&y(this,_,M).call(this,"timetable",l)};g(this,b).onUserInfo(o)}async connect(e){let t=this.eventEmitter.waitFor("state:connected",3e4,r=>r===!0);try{this.registerSomeStuff(),g(this,b).connect(e),await t.promise}catch(r){throw new Error(`PushClient connect failed: ${r.message||"Unknown error"} `)}await new Promise(r=>setTimeout(r,100))}async disconnect(){if(g(this,H)){g(this,S).warn("[PushClientManager] Instance already destroyed");return}try{g(this,b).disconnect()}catch(e){g(this,S).error("[PushClientManager] Error during disconnect:",e)}}async destroy(){if(g(this,H)){g(this,S).warn("[PushClientManager] Instance already destroyed");return}return await y(this,_,Qt).call(this)}checkIfSessionIdIsMine(e){return g(this,H)?!1:g(this,Q).has(e)}async waitForConnected(e=15e3){return g(this,H)?Promise.reject(new Error("PushClientManager instance is destroyed")):this.state.connected?Promise.resolve():this.eventEmitter.waitFor("state:connected",e,t=>t===!0).promise}addSubscriber(e){if(g(this,H))throw new Error("Cannot add subscriber: PushClientManager is destroyed");let t=Pe.createSubscribedInstance(this,e);return g(this,j).add(t),g(this,S).debug(`[PushClientManager] Subscriber ${e?`(${e})`:""} added. Total subscribers:`,g(this,j).size),t}removeSubscriber(e){g(this,j).has(e)?(g(this,j).delete(e),g(this,S).debug(`[PushClientManager] Subscriber ${e.component?`(${e.component})`:""} removed. Total subscribers:`,g(this,j).size)):g(this,S).warn(`[PushClientManager] Attempted to remove non-registered subscriber ${e.component?`(${e.component})`:""}`)}};ye=new WeakSet,Xe=function(e){if(!(e!=null&&e.pushClient))throw new Error("PushClient instance is required");let t=e.pushClient[ie];return(!t||t.destroyed)&&(t=new oe({logger:e.logger,pushClient:e.pushClient})),t},se=new WeakMap,Ve=new WeakMap,H=new WeakMap,S=new WeakMap,b=new WeakMap,j=new WeakMap,_=new WeakSet,M=function(e,t){g(this,se)[e]!==t&&(g(this,se)[e]=t,g(this,S).debug(`[PushClientManager] State change: ${e} =`,t),this.eventEmitter.emit(`state:${e}`,t))},Bt=function(e){if(g(this,Q).add(e),g(this,Q).size>g(this,Ve)){let t=g(this,Q).values().next().value;t&&g(this,Q).delete(t)}},et=function(){try{let e=g(this,b).getSessionId();return!e||e==="NO-SESSION"?(e=null,y(this,_,M).call(this,"sessionId",null),y(this,_,M).call(this,"connected",!1)):(y(this,_,M).call(this,"sessionId",e),y(this,_,M).call(this,"connected",!0),y(this,_,Bt).call(this,e)),e}catch(e){return g(this,S).error("[PushClientManager] Error getting session ID:",e),y(this,_,M).call(this,"sessionId",null),y(this,_,M).call(this,"connected",!1),null}},Te=new WeakMap,jt=function(){y(this,_,et).call(this),g(this,b).on("*",g(this,Te))},Q=new WeakMap,Qt=async function(){var t,r;if(g(this,H))return;g(this,S).debug("[PushClientManager] Cleaning up PushClientManager instance."),K(this,H,!0);let e=Array.from(g(this,j));g(this,j).clear(),g(this,b)&&g(this,b)[ie]&&(g(this,b)[ie]=void 0,delete g(this,b)[ie]);try{(r=(t=g(this,b))==null?void 0:t.off)==null||r.call(t,"*",g(this,Te))}catch(i){g(this,S).error("[PushClientManager] Error removing event handler:",i)}for(let i of e)await i.cleanup().catch(o=>{g(this,S).error("[PushClientManager] Error cleaning up subscribed instance:",o)});await this.eventEmitter.shutdown(),g(this,Q).clear(),g(this,S).debug("[PushClientManager] Cleanup complete."),g(this,S).destroy()},D(oe,ye);var Ue=oe;async function tt(n){let e=Dn(n.domain),t=vn(e,n.pushClientLocation||"/static/widgets/push.bundle.v3.js"),r=new Me({scripts:[{src:t,crossOrigin:"anonymous"}],varsGetter:s=>{if(!s.push)throw new Error("PushClient script did not load correctly.");return{push:s.push}},logger:n.logger,loadImmediately:!0});await r.insureLoaded();let i=r.vars.push;return{pushClientManager:Ue.initialize({pushClient:i.create(),logger:n.logger}),scriptLoader:r}}function vn(n,e){try{return new URL(e,n).toString()}catch(t){throw new Error("Invalid path provided for PushClientManager."+t.message)}}function Dn(n){try{if(!n||typeof n!="string")throw new Error("Invalid domain provided for PushClientManager.");return n.startsWith("http://")||n.startsWith("https://")?new URL(n).origin:new URL(`https://${n}`).origin}catch(e){throw new Error("Invalid domain provided for PushClientManager."+e.message)}}var ke=class{constructor(e){c(this,"eventEmitter");c(this,"promiseManager");c(this,"logger");c(this,"callbacks");c(this,"agentAuthenticate");c(this,"pushClientManager");c(this,"scriptLoader");c(this,"calls",new Map);this.logger=F(e.logger,{component:"CallNotificationManager"}),this.promiseManager=new L(e.logger),this.callbacks=e.callbacks,this.agentAuthenticate=e.agentAuthenticate,this.eventEmitter=e.eventEmitter||new B,this.logger.log("instance created")}get isOnQueue(){var e,t;return((t=(e=this.pushClientManager)==null?void 0:e.state)==null?void 0:t.inCallsQueue)||!1}initialize(){return this.promiseManager.run("initialize",async()=>{await this.agentAuthenticate.waitForInitialization(),await this.initializeCallsNotifications()},{conflictsWith:["initialize"]})}async initializeCallsNotifications(){let{pushClientManager:e,scriptLoader:t}=await tt({domain:this.agentAuthenticate.veDomain.origin,logger:this.logger});this.pushClientManager=e,this.scriptLoader=t,this.registerPushNotificationEvents(),this.pushClientManager.connect({url:this.agentAuthenticate.signallingUrl,tenantId:this.agentAuthenticate.brokerageData.tennantId,token:this.agentAuthenticate.token,userId:this.agentAuthenticate.brokerageData._account.email})}switchQueue(){return this.promiseManager.run("switchQueue",async()=>this.isOnQueue?this.pushClientManager.leaveCallsQueue():this.pushClientManager.joinCallsQueue(),{conflictsWith:["switchQueue"]})}async acceptCall(e){return this.promiseManager.run("acceptCall",async()=>{let t={...this.calls.get(e)};if(!t||!t.calls||Object.keys(t.calls).length===0)throw this.logger.error("No call info found for callId",e),new a(a.codes.SESSION_NOT_FOUND,{context:{visitorId:e,reason:"The visitor have left"}});this.logger.log("Accepting call for callId",e,t,this,this.eventEmitter);let r=this.eventEmitter.waitFor("callStateUpdated",12e4,s=>s.status==="PRE_CALL","resolve"),i=this.eventEmitter.waitForAny(["sessionFailed","acceptedElsewhere","partyLeft"],3e4,({event:s,payload:l})=>s==="acceptedElsewhere"?t.caller.id===l.visitorId:s==="partyLeft"&&l===e?!0:s==="sessionFailed","resolve");await this.callbacks.call({customerId:t.caller.id});let o=await i.promise;if(!o||!o.event||!o.payload)throw this.logger.error("No response received after accepting call for callId",e),r.cancel(),new a(a.codes.SESSION_FAILED_TO_START,{context:{visitorId:e,reason:"The call did not start within the expected time frame"}});if(o.event==="partyLeft")throw this.logger.error("Visitor left before call could be established for callId",e),new a(a.codes.VISITOR_HAS_LEFT_SESSION,{context:{visitorId:e,reason:"The visitor have left"}});if(this.logger.log("Call accepted response",o),o.event==="sessionFailed"){r.cancel(),this.logger.error("Call session failed after accepting call for callId",e,o);let s=t.calls||{};for(let l in s)s[l].sendCustomEvent("DismissMeeting",{data:"Caller Name"}),s[l].hangup("DismissMeeting");throw new a(a.codes.CALL_ALREADY_FINISHED,{context:{visitorId:e,reason:"The call have already finished, Nextjs failed to find the interaction"}})}if(!o.payload.acceptedByMyOtherDevice)throw r.cancel(),this.logger.error("Call was accepted by another agent",o),new a(a.codes.SESSION_ACCEPTED_BY_ANOTHER_AGENT,{context:{reason:"Accepted By Other Agent"}});if(await r.promise,this.callbacks.getCallState().status!=="CALL_STARTED"&&await this.eventEmitter.waitFor("callStateUpdated",1e4,s=>s.status==="CALL_STARTED","resolve").promise.catch(()=>{}),this.callbacks.getCallState().status!=="CALL_STARTED")throw this.logger.error("Call did not start properly after accepting call for callId",e,this.callbacks.getCallState()),new a(a.codes.SESSION_ACCEPTED_BY_SELF_ON_ANOTHER_DEVICE,{context:{visitorId:e,reason:"Picked somewhere else by you"}})},{waitFor:["initialize"],conflictsWith:["acceptCall","rejectCall"]})}async rejectCall(e){return this.promiseManager.run("rejectCall",async()=>{let t={...this.calls.get(e)};if(!t||!t.calls||Object.keys(t.calls).length===0)throw this.logger.error("No call info found for callId",e),new a(a.codes.VISITOR_HAS_LEFT_SESSION,{context:{visitorId:e,reason:"The visitor have left"}});this.logger.info("Rejecting call for callId",e,t);let r=t.calls||{};for(let i in r)r[i].hangup("RejectedByAgent")},{waitFor:["initialize"],conflictsWith:["acceptCall","rejectCall"]})}async registerPushNotificationEvents(){this.pushClientManager.eventEmitter.on("state:inCallsQueue",e=>{this.logger.info(`PushClientManager state changed: inCallsQueue = ${e}`),this.eventEmitter.emit("inCallsQueue",e)}),this.pushClientManager.client.call.service.onIncomingCall((e,t,r)=>{var l;if(!e||!t){this.logger.error("Invalid callControl or callerInfo received in incoming call");return}if(typeof(r==null?void 0:r.from)!="object"||!("id"in r.from&&typeof r.from.id=="string")||!("type"in r.from&&typeof r.from.type=="string")){this.logger.error("Invalid callerInfo structure received in incoming call",{callerInfo:t,context:r});return}if(r.from.type!=="visitor"){this.logger.warn("Incoming call from non-visitor type is ignored",{callerInfo:t,context:r});return}this.logger.info("Incoming call received",e,t,r);let i=e.getId(),o=((l=this.calls.get(r.from.id))==null?void 0:l.calls)||{};o[i]=e;let s={calls:o,caller:r.from,context:r,displayName:Ln(t==null?void 0:t.name)};e.on("AcceptedElsewhere",async p=>{this.logger.log("Call accepted elsewhere, removing call locally",p),this.eventEmitter.emit("acceptedElsewhere",{callId:i,visitorId:s.caller.id,acceptedByUser:p.userId,acceptedByMyOtherDevice:p.deviceId}),await new Promise(m=>setTimeout(m,100)),this.removeCall(i,s.caller.id)}),e.on("CallFailed",p=>{this.logger.log("Call failed with reason",p),this.removeCall(i,s.caller.id)}),e.on("CallEnded",()=>{this.logger.log("Call ended by remote"),this.removeCall(i,s.caller.id)}),this.calls.set(s.caller.id,s),this.eventEmitter.emit("incomingCall",s)})}removeCall(e,t){let r=this.calls.get(t);if(!r){this.logger.error("No call info found for visitorId",t),this.eventEmitter.emit("callRemoved",e);return}delete r.calls[e],Object.keys(r.calls).length>0?this.calls.set(t,r):(this.calls.delete(t),this.eventEmitter.emit("partyLeft",t)),this.eventEmitter.emit("callRemoved",e)}get currentReceivedCalls(){return Array.from(this.calls.values())}async destroyInstance(){var e,t,r,i,o,s;(e=this.pushClientManager)==null||e.disconnect(),await((t=this.pushClientManager)==null?void 0:t.destroy()),await((r=this.scriptLoader)==null?void 0:r.unload()),(i=this.promiseManager)==null||i.abortAll("destroyInstance called"),await((o=this.eventEmitter)==null?void 0:o.shutdown()),(s=this.logger)==null||s.destroy({recursive:!0})}};function Ln(n){let e=n==null?void 0:n.replaceAll("+"," ").trim();return e||"Visitor"}async function ae(n,e={}){let t=await fetch(n,{method:(e==null?void 0:e.method)||"GET",headers:{Accept:"application/json",...(e==null?void 0:e.headers)||{}},body:e==null?void 0:e.body});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}async function Yt(n,e){Mn(e);let t=`${n}/api/partners/impersonateCreate`,{token:r}=await ae(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r)throw new Error("Impersonation failed: no token");return r}function Mn(n){let e=["pak","email","division"];for(let t of e)if(!n[t])throw new Error(`ImpersonateCreateBody validation failed: missing required field '${t}'`)}async function nt(n,e,t,r){if(!n)throw new Error("No signalling data");let i=`${n}/api/signalling/endpoint/${e}/${t}`,o=await ae(i),s=new URL(r);return s.searchParams.set("signallingId",o.signallingId),s.toString()}async function rt(n,e){let t=`${n}/api/brokerages/users/me`;return ae(t,{headers:{Authorization:`Bearer ${e}`}})}var _o=Object.freeze({token:"token",generic:"generic"}),Ge=class{constructor(e){c(this,"configs");c(this,"logger");c(this,"promiseManager");c(this,"initialized",!1);c(this,"_brokerageData");c(this,"_signallingUrl");c(this,"_token");c(this,"_veDomain");this.configs=e.configs,this.logger=F(e.logger,{component:"AgentAuthentication"}),this.promiseManager=new L(this.logger),this.initialize().catch(t=>{this.logger.error("Error during initialization: "+String(t))})}async waitForInitialization(){if(await this.promiseManager.waitFor("initialize"),!this.initialized)throw new a(a.codes.AGENT_NOT_AUTHENTICATED)}async initialize(){return this.promiseManager.run("initialize",async()=>{let{token:e,signallingUrl:t,brokerageData:r,veDomain:i}=await this.authenticate();this._token=e,this._signallingUrl=t,this._brokerageData=r,this._veDomain=i,this.initialized=!0},{conflictsWith:["initialize"]})}async authenticate(){return Pn[this.configs.authMethod](this.configs)}getDisplayName(){if(!this.brokerageData)throw new a(a.codes.AGENT_NOT_AUTHENTICATED);let e=`${this.brokerageData.firstName||""} ${this.brokerageData.lastName||""}`.trim();return e||(e=this.brokerageData.contactEmail||this.brokerageData._account.contactEmail||this.brokerageData.email.replaceAll(this.brokerageData.organizationId||this.brokerageData._account.organizationId||"","")),e}get brokerageData(){if(!this._brokerageData)throw new a(a.codes.AGENT_NOT_AUTHENTICATED);return this._brokerageData}get signallingUrl(){if(!this._signallingUrl)throw new a(a.codes.AGENT_NOT_AUTHENTICATED);return this._signallingUrl}get token(){if(!this._token)throw new a(a.codes.AGENT_NOT_AUTHENTICATED);return this._token}get veDomain(){if(!this._veDomain)throw new a(a.codes.AGENT_NOT_AUTHENTICATED);return this._veDomain}destroy(){this.promiseManager.abortAll(),this.logger.destroy({recursive:!0})}},Pn={generic:xn,token:Un};async function xn(n){let e=new URL(`https://${n.domain}`),t=await Yt(e.origin,{pak:n.apiKey,division:n.externalId,email:`${n.organizationId||""}${n.agentEmail}`,organizationId:n.organizationId,firstName:n.firstName,lastName:n.lastName,contactEmail:n.contactEmail}),r=await rt(e.origin,t),i=await nt(e.origin,r.tennantId,"null",r.signalling.endPoint);return{token:t,signallingUrl:i,brokerageData:r,veDomain:e}}async function Un(n){let e=new URL(`https://${n.domain}`),t=await rt(e.origin,n.token),r=await nt(e.origin,t.tennantId,"null",t.signalling.endPoint);return{token:n.token,signallingUrl:r,brokerageData:t,veDomain:e}}var u=class u{constructor(){c(this,"logger");c(this,"eventEmitter",new B);c(this,"authParameters");c(this,"promiseManager");c(this,"PromiseManager",L);c(this,"configs");c(this,"_isInitialized",!1);c(this,"cleanups",[]);c(this,"callState",this.defaultCallState);c(this,"handlerErrors",e=>{let t=Ze(e);return this.logger.error("Error in VideoEngagerAgent operation:",t.toJSON()),t});c(this,"_isIframeOpened",!1);c(this,"_callsNotificationsManager");c(this,"_agentDetails");c(this,"on",this.eventEmitter.on.bind(this.eventEmitter));c(this,"off",this.eventEmitter.off.bind(this.eventEmitter));this.logger=F({component:"VideoEngagerAgent"}),this.promiseManager=new L(this.logger),this.logger.info("VideoEngagerAgent loaded")}get defaultCallState(){return{status:"NONE",callerEmail:"",email:"",tennant_id:"",visitorId:"",pin:"",shortUrl:"",attributes:{},inActiveSession:!1}}get currentCallState(){return this.callState}getCurrentCallState(){return this.callState}static getCurrentCallState(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.getCurrentCallState()}static getInstance(){return u._instance||(u._instance=new u),u._instance}static async init(e){return le&&await le.catch(t=>{}),u._instance||(u._instance=new u),await u._instance.initialize(e)}isStandaloneMode(e){if(!e)throw new a(a.codes.AGENT_NOT_INITIALIZED);return"standaloneMode"in e?e.standaloneMode===!0:!1}async initialize(e){if(this._isInitialized)throw new a(a.codes.AGENT_ALREADY_INITIALIZED);return e.logger&&(this.logger=F(this.logger,{debug:e.logger})),await this.promiseManager.run("initialize",async()=>{var o,s;this.configs=Vt(e);let t=!!this.configs.authMethod&&this.configs.authMethod in qe&&qe[this.configs.authMethod];if(!t)throw new a(a.codes.AUTH_METHOD_NOT_SUPPORTED,{context:{authMethod:this.configs.authMethod}});let r=new t(this.configs);this.authParameters=await r.authenticate();let i=await this.initializeStandaloneModules();i&&(this.authParameters={...this.authParameters,...i},delete this.authParameters.email,delete this.authParameters.environment,delete this.authParameters.pak),!("uiHandlers"in(this.configs.options||{}))&&!((o=this.configs.options)!=null&&o.containerId)&&Ut(),this.setUiHandler(((s=this.configs.options)==null?void 0:s.uiHandlers)||Re),this.registerSmartVideoEvents(),this._isInitialized=!0,this.logger.info("VideoEngagerAgent Authenticated Successfully")},{waitIfRunning:!1,transformError:this.handlerErrors})}registerSmartVideoEvents(){let e=t=>{var r;t.origin===`https://${this.configs.domain}`&&(this.logger.info("Received message from VideoEngager widget: ",t.data),(r=t.data)!=null&&r.status&&this.handleStatusEvent(t.data))};window.addEventListener("message",e),this.logger.info("Registered message event listener for VideoEngager widget"),this.cleanups.push(()=>{this.logger.info("Removing message event listener"),window.removeEventListener("message",e)})}updateCallState(e,t=!0){let r=e.attributes||{},i={...this.callState.attributes,...r};this.callState={...this.callState,...e,attributes:i},this.logger.info(`Call state updated: ${JSON.stringify(this.callState)}`),t&&this.eventEmitter.emit("callStateUpdated",{...this.callState})}async handleStatusEvent(e){return this.promiseManager.run("handleStatusEvent",async()=>{if(!e||!e.status){this.logger.debug("Received empty payload for status event");return}this.logger.info(`Handling status event: ${e.status}`);let t=this.callState.visitorId,r=this.callState.status,i=!1;switch(e.status){case"PRE_CALL":this.updateCallState(e,!1),t!==e.visitorId&&(this.callState.inActiveSession=!0,this.eventEmitter.emit("sessionStarted",{...this.callState})),i=!0;break;case"CALL_STARTED":this.updateCallState(e);break;case"END_CALL":if(r!=="CALL_STARTED"){this.logger.warn("Call not started yet, ignoring END_CALL event");return}this.updateCallState(e);break;case"FINISHED":if(r==="FINISHED"){this.logger.debug("Call already finished, ignoring duplicate FINISHED event");return}if(r==="NONE"){this.logger.warn("Call Never Started, this indicates a failure to start the call, ignoring FINISHED event"),this.eventEmitter.emit("sessionFailed",e);return}this.callState.inActiveSession=!0,this.updateCallState(e,!1),this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState}),await new Promise(o=>setTimeout(o,10)),this.logger.info("Resetting call state after session finished"),this.callState=this.defaultCallState;break;default:this.logger.warn(`Unhandled status event: ${e.status}`);break}i&&this.eventEmitter.emit("callStateUpdated",{...this.callState})},{waitIfRunning:!0})}setIsIframeOpened(e){var r;let t=!!e&&e.contentWindow!==null;this._isIframeOpened!==t&&(this._isIframeOpened=t,(r=this.eventEmitter)==null||r.emit("iframeStateChanged",t))}isIframeOpened(){return this._isIframeOpened}setUiHandler(e=Re){let t=["openIframe","closeIframe","getIframe"];for(let o of t)if(!e[o]||typeof e[o]!="function")throw new a(a.codes.UI_HANDLERS_METHOD_REQUIRED,{context:{missingMethod:o}});let r=async()=>{let o=await e.getIframe(this.configs);this.setIsIframeOpened(o||null)},i={openIframe:(...o)=>{let s=e.openIframe(...o);return s&&typeof s.then=="function"?s.then(l=>(r(),l)):(r(),s)},getIframe:(...o)=>{let s=e.getIframe(...o);return s&&typeof s.then=="function"?s.then(l=>(this.setIsIframeOpened(l||null),l)):(this.setIsIframeOpened(s||null),s)},closeIframe:(...o)=>{let s=e.closeIframe(...o);return s&&typeof s.then=="function"?s.then(()=>{this.setIsIframeOpened(null)}):(this.setIsIframeOpened(null),s)}};this.configs.options||(this.configs.options={}),this.configs.options.uiHandlers=i}async call(e){return await this.promiseManager.run("call",async()=>{if(!this._isInitialized||!this.authParameters)throw new a(a.codes.AGENT_NOT_AUTHENTICATED);this.logger.info("Calling VideoEngagerAgent with auth parameters:");let t={...this.authParameters,enablePostMessage:"true",authPopup:"true"},r=e==null?void 0:e.customerId;if(r&&typeof r!="string")throw new a(a.codes.PARAM_CUSTOMER_ID_INVALID_TYPE);r&&(t.veinteraction=r);let i=new URLSearchParams(t),o=`https://${this.configs.domain}/nextjs/single/smartvideo/?${i.toString()}`;await this.handlersUi.openIframe(o,this.configs),this.logger.info("VideoEngagerAgent call completed. Widget is ready.")},{waitFor:["initialize"],conflictsWith:["endCall"],waitIfRunning:!1,transformError:this.handlerErrors})}async endCall(){return await this.promiseManager.run("endCall",async()=>{if(!this.callState.inActiveSession&&!this.isIframeOpened())throw this.logger.warn("No active session to end"),new a(a.codes.CALL_NOT_STARTED);this.logger.info("Ending call"),await this.handlersUi.closeIframe(this.configs),this.logger.info("closed iframe"),this.callState.inActiveSession&&(this.callState.status=xt.FINISHED,this.callState.inActiveSession=!1,this.eventEmitter.emit("sessionEnded",{...this.callState}),this.eventEmitter.emit("callStateUpdated",{...this.callState})),this.logger.info("Call ended and iframe closed"),this.callState=this.defaultCallState},{waitFor:["initialize","call"],waitIfRunning:!1,waitForDelayMs:500,transformError:this.handlerErrors})}get callsNotificationsManager(){if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);if(!this._callsNotificationsManager)throw new a(a.codes.AGENT_NOT_INITIALIZED);return this._callsNotificationsManager}get agentDetails(){if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);if(!this._agentDetails)throw new a(a.codes.AGENT_NOT_INITIALIZED);return this._agentDetails}async initializeStandaloneModules(){if(!this.isStandaloneMode(this.configs)){this.logger.info("Standalone mode not enabled, skipping standalone modules initialization");return}let e=this.configs.authMethod==="generic"?{agentEmail:this.configs.agentEmail,apiKey:this.configs.apiKey,domain:this.configs.domain,authMethod:this.configs.authMethod,organizationId:this.configs.organizationId,standaloneMode:!0,externalId:this.configs.externalId,firstName:this.configs.firstName,lastName:this.configs.lastName,contactEmail:this.configs.contactEmail}:{authMethod:this.configs.authMethod,token:this.configs.token,domain:this.configs.domain,standaloneMode:!0};return this._agentDetails=new Ge({configs:e,logger:this.logger}),this._callsNotificationsManager=new ke({agentAuthenticate:this._agentDetails,logger:this.logger,callbacks:{call:this.call.bind(this),getCallState:()=>this.callState},eventEmitter:this.eventEmitter}),await this._callsNotificationsManager.initialize(),{token:this._agentDetails.token}}getReceivedCalls(){if(!this.isInitialized())throw new a(a.codes.AGENT_NOT_INITIALIZED);if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.callsNotificationsManager.currentReceivedCalls}switchQueue(){if(!this.isInitialized())throw new a(a.codes.AGENT_NOT_INITIALIZED);if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.callsNotificationsManager.switchQueue()}isOnQueue(){return this.isInitialized()?this.isStandaloneMode(this.configs)?this.callsNotificationsManager.isOnQueue:(this.logger.warn("Agent not in standalone mode when checking queue status"),!1):(this.logger.warn("Agent not initialized when checking queue status"),!1)}async acceptCall(e){if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);if(this.isIframeOpened()||this.callState.inActiveSession)throw this.logger.warn("Cannot accept call while another call is active"),new a(a.codes.SESSION_ALREADY_ACTIVE,{context:{visitorId:e,reason:"Another call is active"}});try{await this.callsNotificationsManager.acceptCall(e)}catch(t){throw this.logger.error("Error accepting call:",t),this.isIframeOpened()&&await this.endCall().catch(()=>{}),t}}async rejectCall(e){if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.callsNotificationsManager.rejectCall(e)}getDisplayName(){if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.agentDetails.getDisplayName()}agentSettings(){if(!this.isStandaloneMode(this.configs))throw new a(a.codes.AGENT_NOT_IN_STANDALONE_MODE);return this.agentDetails.brokerageData}async cleanup(){var e,t,r,i,o,s,l,p,m,E,T,A,R,I;this.logger.info("Cleaning up VideoEngagerAgent resources");try{(e=this.callState)!=null&&e.inActiveSession&&await this.endCall()}catch(C){(t=this.logger)==null||t.warn("Error closing iframe during cleanup:"+String(C))}this.cleanups.forEach(C=>{var O;try{C()}catch(f){(O=this.logger)==null||O.warn("Error during cleanup:"+String(f))}}),this.cleanups.length=0,await((r=this.promiseManager)==null?void 0:r.waitFor("handleStatusEvent")),await((i=this.eventEmitter)==null?void 0:i.emit("cleanup",void 0,{awaitListeners:!0}).catch(C=>{this.logger.warn("Error emitting cleanup event:"+String(C))})),(o=this.logger)==null||o.info("Emitted cleanup event to listeners");try{await((s=this.eventEmitter)==null?void 0:s.shutdown(1e3))}catch(C){(l=this.logger)==null||l.warn("Error during event emitter shutdown:"+String(C))}(p=this.promiseManager)==null||p.abortAll("cleanup"),await((m=this._callsNotificationsManager)==null?void 0:m.destroyInstance().catch(()=>{}));try{await((E=this._agentDetails)==null?void 0:E.destroy())}catch(C){(T=this.logger)==null||T.warn("Error destroying agent details:"+String(C))}(A=this.logger)==null||A.info("Destroyed standalone modules"),this.callState=this.defaultCallState,this._isInitialized=!1,this.authParameters=void 0,this.promiseManager=void 0,this.eventEmitter=void 0,(R=this.logger)==null||R.info("VideoEngagerAgent cleanup completed"),(I=this.logger)==null||I.destroy({recursive:!0}),this.logger=void 0,this.configs=void 0}isInitialized(){return this._isInitialized}static call(...e){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.call.bind(u._instance)(...e)}static endCall(...e){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.endCall.bind(u._instance)(...e)}static isInitialized(){return u._instance!==null&&u._instance.isInitialized()}static isIframeOpened(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.isIframeOpened()}static acceptCall(...e){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.acceptCall.bind(u._instance)(...e)}static rejectCall(...e){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.rejectCall.bind(u._instance)(...e)}static getDisplayName(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.getDisplayName()}static agentSettings(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.agentSettings()}static setUiHandler(...e){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.setUiHandler.bind(u._instance)(...e)}static getReceivedCalls(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.getReceivedCalls()}static switchQueue(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.switchQueue()}static isOnQueue(){if(!u._instance)throw new a(a.codes.AGENT_NOT_INITIALIZED);return u._instance.isOnQueue()}static async destroy(){if(le)throw new a(a.codes.OPERATION_ALREADY_RUNNING,{context:{operationName:"destroy"}});if(u._instance)try{le=u._instance.cleanup(),await le}finally{le=null,u._instance=null}}get handlersUi(){let e=this.configs.options||{};return"uiHandlers"in e&&e.uiHandlers||Re}};c(u,"VERSION",ne),c(u,"_instance",null),c(u,"on",((...e)=>u.getInstance().on.bind(u.getInstance())(...e))),c(u,"off",((...e)=>u.getInstance().off.bind(u.getInstance())(...e)));var N=u,le=null,Vn=N.init,kn=N.getInstance,Gn=N.isInitialized,Fn=N.destroy,Hn=N.call,$n=N.endCall,zn=N.on,Bn=N.off,jn=N.isIframeOpened,Qn=N.acceptCall,Yn=N.rejectCall,qn=N.getDisplayName,Wn=N.agentSettings,Kn=N.setUiHandler,Zn=N.getCurrentCallState,Jn=N.getReceivedCalls,Xn=N.switchQueue,er=N.isOnQueue,tr=N;
